ut.WebGLRenderer=function(t){"use strict";if(this.view=t,this.canvas=document.createElement("canvas"),!this.canvas.getContext)throw"Canvas not supported";if(this.gl=this.canvas.getContext("experimental-webgl"),!this.gl)throw"WebGL not supported";var e=this.gl;function i(t,e,i,r,o,a){var s=i,h=r,n=i+o,l=r+a;t[e]=s,t[++e]=h,t[++e]=n,t[++e]=h,t[++e]=s,t[++e]=l,t[++e]=s,t[++e]=l,t[++e]=n,t[++e]=h,t[++e]=n,t[++e]=l}if(t.elem.appendChild(this.canvas),this.charMap={},this.charArray=[],this.defaultColors={r:1,g:1,b:1,br:0,bg:0,bb:0},this.attribs={position:{buffer:null,data:null,itemSize:2,location:null,hint:e.STATIC_DRAW},texCoord:{buffer:null,data:null,itemSize:2,location:null,hint:e.STATIC_DRAW},color:{buffer:null,data:null,itemSize:3,location:null,hint:e.DYNAMIC_DRAW},bgColor:{buffer:null,data:null,itemSize:3,location:null,hint:e.DYNAMIC_DRAW},charIndex:{buffer:null,data:null,itemSize:1,location:null,hint:e.DYNAMIC_DRAW}},this.initBuffers=function(){var t,r,o=this.attribs,a=this.view.w,s=this.view.h;for(t in this.attribs)(r=o[t]).data=new Float32Array(6*r.itemSize*a*s);for(var h=0;h<s;++h)for(var n=0;n<a;++n){var l=6*o.position.itemSize*(h*a+n);i(o.position.data,l,n*this.tw,h*this.th,this.tw,this.th),i(o.texCoord.data,l,0,0,1,1)}for(t in this.attribs)(r=o[t]).buffer&&e.deleteBuffer(r.buffer),r.buffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,r.buffer),e.bufferData(e.ARRAY_BUFFER,r.data,r.hint),e.enableVertexAttribArray(r.location),e.vertexAttribPointer(r.location,r.itemSize,e.FLOAT,!1,0,0)},this.offscreen||(this.offscreen=document.createElement("canvas")),this.offscreen.style.position="absolute",this.offscreen.style.top="0px",this.offscreen.style.left="0px",this.ctx=this.offscreen.getContext("2d"),!this.ctx)throw"Failed to acquire offscreen canvas drawing context";function r(t,i){var r=e.createShader(t);if(e.shaderSource(r,i),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS)){var o="Error compiling shader: "+e.getShaderInfoLog(r);throw e.deleteShader(r),o}return r}this.updateStyle(),this.canvas.width=(t.squarify?this.th:this.tw)*t.w,this.canvas.height=this.th*t.h,this.offscreen.width=0,this.offscreen.height=0,this.updateStyle(),e.viewport(0,0,this.canvas.width,this.canvas.height);var o=r(e.VERTEX_SHADER,ut.WebGLRenderer.VERTEX_SHADER),a=r(e.FRAGMENT_SHADER,ut.WebGLRenderer.FRAGMENT_SHADER),s=e.createProgram();if(e.attachShader(s,o),e.attachShader(s,a),e.linkProgram(s),e.deleteShader(o),e.deleteShader(a),!e.getProgramParameter(s,e.LINK_STATUS)){var h="Error linking program: "+e.getProgramInfoLog(s);throw e.deleteProgram(s),h}e.useProgram(s),this.attribs.position.location=e.getAttribLocation(s,"position"),this.attribs.texCoord.location=e.getAttribLocation(s,"texCoord"),this.attribs.color.location=e.getAttribLocation(s,"color"),this.attribs.bgColor.location=e.getAttribLocation(s,"bgColor"),this.attribs.charIndex.location=e.getAttribLocation(s,"charIndex"),this.initBuffers();var n=e.getUniformLocation(s,"uResolution");e.uniform2f(n,this.canvas.width,this.canvas.height),this.tileCountsLocation=e.getUniformLocation(s,"uTileCounts"),e.uniform2f(this.tileCountsLocation,this.view.w,this.view.h),this.paddingLocation=e.getUniformLocation(s,"uPadding"),e.uniform2f(this.paddingLocation,0,0);var l=e.createTexture();e.bindTexture(e.TEXTURE_2D,l),this.cacheChars(" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~"),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.activeTexture(e.TEXTURE0);var f=this;setTimeout((function(){f.updateStyle(),f.buildTexture(),f.render()}),100)},ut.WebGLRenderer.prototype.buildTexture=function(){"use strict";var t=this.gl,e=this.offscreen.width/(this.tw+this.pad),i=this.offscreen.height/(this.th+this.pad),r=this.charArray.length;r>Math.floor(e)*Math.floor(i)&&(i=(e=Math.ceil(Math.sqrt(r)))+2,this.offscreen.width=e*(this.tw+this.pad),this.offscreen.height=i*(this.th+this.pad),this.updateStyle(),t.uniform2f(this.tileCountsLocation,e,i)),t.uniform2f(this.paddingLocation,this.pad/this.offscreen.width,this.pad/this.offscreen.height);var o,a=0,s=.5*this.gap;this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.offscreen.width,this.offscreen.height),this.ctx.fillStyle="#ffffff";for(var h=this.tw+this.pad,n=this.th+this.pad,l=.5*n,f=0;f<i;++f){for(var c=.5*this.pad,d=0;d<e&&void 0!==(o=this.charArray[a]);++d,++a)this.ctx.fillText(o,c+s,l),c+=h;if(!o)break;l+=n}t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.offscreen)},ut.WebGLRenderer.prototype.cacheChars=function(t,e){"use strict";if(this.gl){for(var i=!1,r=0;r<t.length;++r)this.charMap[t[r]]||(i=!0,this.charArray.push(t[r]),this.charMap[t[r]]=this.charArray.length-1);i&&!1!==e&&this.buildTexture()}},ut.WebGLRenderer.prototype.updateStyle=function(t){"use strict";t=t||window.getComputedStyle(this.view.elem,null),this.ctx.font=t.fontSize+"/"+t.lineHeight+" "+t.fontFamily,this.ctx.textBaseline="middle",this.ctx.fillStyle="#ffffff",this.tw=this.ctx.measureText("M").width,this.th=parseInt(t.fontSize,10),this.gap=this.view.squarify?this.th-this.tw:0,this.view.squarify&&(this.tw=this.th),this.pad=2*Math.ceil(.2*this.th);var e=t.color.match(/\d+/g),i=t.backgroundColor.match(/\d+/g);this.defaultColors.r=parseInt(e[0],10)/255,this.defaultColors.g=parseInt(e[1],10)/255,this.defaultColors.b=parseInt(e[2],10)/255,this.defaultColors.br=parseInt(i[0],10)/255,this.defaultColors.bg=parseInt(i[1],10)/255,this.defaultColors.bb=parseInt(i[2],10)/255},ut.WebGLRenderer.prototype.clear=function(){},ut.WebGLRenderer.prototype.render=function(){"use strict";var t=this.gl;t.clear(t.COLOR_BUFFER_BIT);for(var e=this.attribs,i=this.view.w,r=this.view.h,o=this.view.buffer,a=(this.view.defaultColor,this.view.defaultBackground,!1),s=0;s<r;++s)for(var h=0;h<i;++h){var n=o[s][h],l=this.charMap[n.ch];void 0===l&&(this.cacheChars(n.ch,!1),a=!0,l=this.charMap[n.ch]);for(var f=6*e.color.itemSize*(s*i+h),c=6*e.charIndex.itemSize*(s*i+h),d=void 0===n.r?this.defaultColors.r:n.r/255,u=void 0===n.g?this.defaultColors.g:n.g/255,b=void 0===n.b?this.defaultColors.b:n.b/255,v=void 0===n.br?this.defaultColors.br:n.br/255,g=void 0===n.bg?this.defaultColors.bg:n.bg/255,R=void 0===n.bb?this.defaultColors.bb:n.bb/255,C=0;C<6;++C){var p=f+C*e.color.itemSize;e.color.data[p+0]=d,e.color.data[p+1]=u,e.color.data[p+2]=b,e.bgColor.data[p+0]=v,e.bgColor.data[p+1]=g,e.bgColor.data[p+2]=R,e.charIndex.data[c+C]=l}}a&&this.buildTexture(),t.bindBuffer(t.ARRAY_BUFFER,e.color.buffer),t.bufferData(t.ARRAY_BUFFER,e.color.data,e.color.hint),t.bindBuffer(t.ARRAY_BUFFER,e.bgColor.buffer),t.bufferData(t.ARRAY_BUFFER,e.bgColor.data,e.bgColor.hint),t.bindBuffer(t.ARRAY_BUFFER,e.charIndex.buffer),t.bufferData(t.ARRAY_BUFFER,e.charIndex.data,e.charIndex.hint);var T=this.attribs.position;t.drawArrays(t.TRIANGLES,0,T.data.length/T.itemSize)},ut.WebGLRenderer.VERTEX_SHADER=["attribute vec2 position;","attribute vec2 texCoord;","attribute vec3 color;","attribute vec3 bgColor;","attribute float charIndex;","uniform vec2 uResolution;","uniform vec2 uTileCounts;","uniform vec2 uPadding;","varying vec2 vTexCoord;","varying vec3 vColor;","varying vec3 vBgColor;","void main() {","vec2 tileCoords = floor(vec2(mod(charIndex, uTileCounts.x), charIndex / uTileCounts.x));","vTexCoord = (texCoord + tileCoords) / uTileCounts;","vTexCoord += (0.5 - texCoord) * uPadding;","vColor = color;","vBgColor = bgColor;","vec2 pos = position / uResolution * 2.0 - 1.0;","gl_Position = vec4(pos.x, -pos.y, 0.0, 1.0);","}"].join("\n"),ut.WebGLRenderer.FRAGMENT_SHADER=["precision mediump float;","uniform sampler2D uFont;","varying vec2 vTexCoord;","varying vec3 vColor;","varying vec3 vBgColor;","void main() {","vec4 color = texture2D(uFont, vTexCoord);","color.rgb = mix(vBgColor, vColor, color.rgb);","gl_FragColor = color;","}"].join("\n");