"use strict";function fsfunc(){var e,t,a,r,o,n,i,l;window._fs_debug=!1,window._fs_host="fullstory.com",window._fs_script="edge.fullstory.com/s/fs.js",window._fs_org="3HQ39",window._fs_namespace="FS",e=window,t=document,a=window._fs_namespace,r="script",o="user",a in e?e.console&&e.console.log&&e.console.log('FullStory namespace conflict. Please set window["_fs_namespace"].'):((i=e[a]=function(e,t,a){i.q?i.q.push([e,t,a]):i._api(e,t,a)}).q=[],(n=t.createElement(r)).async=1,n.crossOrigin="anonymous",n.src="https://"+_fs_script,(l=t.getElementsByTagName(r)[0]).parentNode.insertBefore(n,l),i.identify=function(e,t,a){i(o,{uid:e},a),t&&i(o,t,a)},i.setUserVars=function(e,t){i(o,e,t)},i.event=function(e,t,a){i("event",{n:e,p:t},a)},i.anonymize=function(){i.identify(!1)},i.shutdown=function(){i("rec",!1)},i.restart=function(){i("rec",!0)},i.log=function(e,t){i("log",[e,t])},i.consent=function(e){i("consent",!arguments.length||e)},i.identifyAccount=function(e,t){n="account",(t=t||{}).acctId=e,i(n,t)},i.clearUserCookie=function(){},i.setVars=function(e,t){i("setVars",[e,t])},i._w={},l="XMLHttpRequest",i._w[l]=e[l],l="fetch",i._w[l]=e[l],e[l]&&(e[l]=function(){return i._w[l].apply(this,arguments)}),i._v="1.3.0")}function rnd(e){return Math.floor(Math.random()*e+1)}function rund(e){return Math.floor(Math.random()*e)}function vxy(e,t){return[e=vx(e),t=vy(t)]}function vx(e){return e=Math.max(0,e),e=Math.min(MAXX-1,e)}function vy(e){return e=Math.max(0,e),e=Math.min(MAXY-1,e)}function beep(){}function initGrid(e,t){for(var a=new Array(e),r=0;r<e;r++)a[r]=new Array(t),a[r]=new Array(t);return a}function debug(e){DEBUG_OUTPUT&&console.log("DEBUG: ".concat(e))}var BLINKENCURSOR,KEYBOARD_INPUT="";function prepare_direction_event(e){setCharCallback(getdirectioninput),keyboard_input_callback=e,updateLog("  In what direction? ")}function getdirectioninput(e,t){if(e==ESC)return appendLog(" cancelled".concat(period)),keyboard_input_callback=null,nomove=1;t=parseDirectionKeys(e,t);return 0==t?0:(keyboard_input_callback&&keyboard_input_callback(t),keyboard_input_callback=null,1)}function echo(e){(mazeMode?appendLog:lprc)(e)}function getTextInput(e){return getInput(e,function(e){return isextra(e)})}function getNumberInput(e){return getInput(e,function(e){return isnum(e)})}function getNumberOrAsterisk(e){return getInput(e,function(e){return isnum(e)},function(e){return"*"==e&&0==KEYBOARD_INPUT.length?(echo(KEYBOARD_INPUT=e),getInput_done()):0})}function getInput(e,t,a){return e==ESC?(KEYBOARD_INPUT=e,getInput_done()):e==ENTER?getInput_done():e==DEL?(0<KEYBOARD_INPUT.length&&(KEYBOARD_INPUT=KEYBOARD_INPUT.slice(0,-1),echo("\b")),0):t(e)?(KEYBOARD_INPUT+=e,echo(e),0):a?a(e):void 0}function getInput_done(){var e=0;return keyboard_input_callback&&1==(e=keyboard_input_callback(KEYBOARD_INPUT))&&(keyboard_input_callback=null),KEYBOARD_INPUT="",e}var BLINKEN=!0;const BLINKENCHAR="_";function blinken(t,a){clearBlinkingCursor(),BLINKENCURSOR=setInterval(function(){var e=t+KEYBOARD_INPUT.length;cursor(e,a),lprc(BLINKEN?" ":BLINKENCHAR),cltoeoln(),cursor(e,a),BLINKEN=!BLINKEN,paint()},250)}function clearBlinkingCursor(){clearInterval(BLINKENCURSOR),BLINKEN=!0}function getCharFromIndex(e){return"a".nextChar(e)}function getIndexFromChar(e){if(e==ESC)return-1;if(!isalpha(e))return-1;var t="a".charCodeAt(0);return e.charCodeAt(0)-t}function elapsedtime(){return Math.floor(gtime/100)}function timeleft(){return Math.floor((TIMELIMIT-gtime)/100)}function isalpha(e){return 1==(e=String(e)).length&&e.match(/^[A-Za-z]+$/)}function isextra(e){return 1==(e=String(e)).length}function isnum(e){return 1==(e=String(e)).length&&e.match(/^[0-9]+$/)}function pad(e,t,a){return padString(""+e,t,a)}String.prototype.nextChar=function(e){e=null==e?1:e;return String.fromCharCode(this.charCodeAt(0)+e)},String.prototype.prevChar=function(e){e=null==e?1:e;return String.fromCharCode(this.charCodeAt(0)-e)};const HIGHLIGHT_DELAY=700;function padString(e,t,a){if(!e)return Array(Math.abs(t)).join(" ");if(!t||0==t)return e;var r=millis(),o=Math.max(0,Math.abs(t)+1-e.length),o=Array(o).join(" "),r=r-a<HIGHLIGHT_DELAY,a=r?START_MARK:"",r=r?END_MARK:"";return t<0?"".concat(a).concat(e).concat(r).concat(o):"".concat(o).concat(a).concat(e).concat(r)}function millis(){return Date.now()}function compareArrays(e,a){return!e&&!a||e&&a&&e.length==a.length&&e.every((e,t)=>e===a[t])}const COMPRESSED_DATA="_COMPRESSED";function onCompressed(e){var t=e.data[0],e=e.data[1];debug("onCompressed: compression end size: ".concat(t," ").concat(e.length)),localStorage.setItem(t,e)}function localStorageSetObject(e,t){ULARN&&(e+="_ularn");try{localStorage.setObject(e,t)}catch(e){return console.log("setObject: ".concat(e)),e}}function localStorageGetObject(t,a){ULARN&&(t+="_ularn");try{var e=localStorage.getObject(t);return!1===e?!1:e||a}catch(e){return console.log('getObject: "'.concat(t,'" ').concat(e)),a}}function localStorageRemoveItem(e){ULARN&&(e+="_ularn");try{console.log("removeItem: ".concat(e)),localStorage.removeItem(e),localStorage.removeItem(e+COMPRESSED_DATA)}catch(e){console.log("removeItem: ".concat(e))}}function loadURLParameters(){let t={};return location.search.substr(1).split("&").forEach(function(e){t[e.split("=")[0]]=e.split("=")[1]}),console.log("url parameters",t),t}function getTextWidth(e,t,a){var r=(getTextWidth.canvas||(getTextWidth.canvas=document.createElement("canvas"))).getContext("2d");return r.font=t=a?"bold "+t:t,r.measureText(e).width}function initLambdaCredentials(){AWS.config.accessKeyId="AKIARFQK7WESI4WPZ34M",AWS.config.secretAccessKey="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"}function setGameConfig(){GAMENAME=ULARN?"Ularn":"Larn",TIMELIMIT=ULARN?4e4:3e4,DBOTTOM=(MAXLEVEL=ULARN?16:11)-1,VBOTTOM=MAXLEVEL+(MAXVLEVEL=ULARN?5:3)-1,LEVELS=new Array(MAXLEVEL+MAXVLEVEL),MAZES=COMMON_MAZES.concat(ULARN?ULARN_MAZES:LARN_MAZES),monsterlist=ULARN?ULARN_monsterlist:LARN_monsterlist,splev=ULARN?ULARN_splev:LARN_splev,spelweird=ULARN?ULARN_spelweird:LARN_spelweird,STORE_INVENTORY=ULARN?ULARN_STORE_INVENTORY:LARN_STORE_INVENTORY,MAXITM=STORE_INVENTORY.length,MAX_BANK_BALANCE=ULARN?1e6:5e5,OBANK.desc="the bank of ".concat(GAMENAME),OBANK2.desc="the ".concat(ULARN?8:5,"th branch of the Bank of ").concat(GAMENAME),OSCHOOL.desc="the College of ".concat(GAMENAME),OLRS.desc="the ".concat(GAMENAME," Revenue Service"),ULARN&&(OTRADEPOST.desc="the Ularn trading Post"),FORTUNES=COMMON_FORTUNES.concat(ULARN?ULARN_FORTUNES:LARN_FORTUNES),ULARN&&(DEATH_REASONS.set(DIED_BOTTOMLESS_TRAPDOOR,"fell through a trap door to HELL"),DEATH_REASONS.set(DIED_BOTTOMLESS_PIT,"fell into a pit to HELL")),youFound=ULARN?"You find":"You have found",period=ULARN?".":"",ULARN?monsterlist[LEMMING].color="rosybrown":monsterlist[BAT].color="brown",monsterlist[GNOME].color="darkkhaki",monsterlist[HOBGOBLIN].color="salmon",monsterlist[JACKAL].color="sandybrown",monsterlist[KOBOLD].color=ULARN?"brown":"rosybrown",monsterlist[ORC].color="tan",monsterlist[SNAKE].color="olivedrab",monsterlist[CENTIPEDE].color="orangered",monsterlist[JACULI].color="burlywood",monsterlist[TROGLODYTE].color="navajowhite",monsterlist[ANT].color="indianred",monsterlist[EYE].color="mediumorchid",monsterlist[LEPRECHAUN].color="mediumseagreen",monsterlist[NYMPH].color="lightpink",monsterlist[QUASIT].color="yellowgreen",monsterlist[RUSTMONSTER].color="goldenrod",monsterlist[ZOMBIE].color="gray",monsterlist[ASSASSINBUG].color="forestgreen",ULARN?monsterlist[BITBUG].color="chocolate":monsterlist[BUGBEAR].color="chocolate",monsterlist[HELLHOUND].color="crimson",monsterlist[ICELIZARD].color="white",monsterlist[CENTAUR].color="sandybrown",monsterlist[TROLL].color="seagreen",monsterlist[YETI].color="mintcream",monsterlist[WHITEDRAGON].color="snow",monsterlist[ELF].color="mediumseagreen",monsterlist[CUBE].color="turquoise",monsterlist[METAMORPH].color="moccasin",monsterlist[VORTEX].color="lightcyan",monsterlist[ZILLER].color="cadetblue",monsterlist[VIOLETFUNGI].color="violet",monsterlist[WRAITH].color="dimgray",monsterlist[FORVALAKA].color="thistle",ULARN?monsterlist[LAMANOBE].color="powderblue":monsterlist[LAWLESS].color="powderblue",monsterlist[OSEQUIP].color=null,monsterlist[ROTHE].color="sienna",monsterlist[XORN].color="brown",monsterlist[VAMPIRE].color="slategray",monsterlist[INVISIBLESTALKER].color=null,monsterlist[POLTERGEIST].color="lavender",monsterlist[DISENCHANTRESS].color="antiquewhite",monsterlist[SHAMBLINGMOUND].color="olivedrab",monsterlist[YELLOWMOLD].color="palegoldenrod",monsterlist[UMBERHULK].color="peru",monsterlist[GNOMEKING].color="steelblue",monsterlist[MIMIC].color="beige",monsterlist[WATERLORD].color="cornflowerblue",monsterlist[BRONZEDRAGON].color="goldenrod",monsterlist[GREENDRAGON].color="palegreen",monsterlist[PURPLEWORM].color="purple",monsterlist[XVART].color="teal",monsterlist[SPIRITNAGA].color="mediumslateblue",monsterlist[SILVERDRAGON].color="paleturquoise",monsterlist[PLATINUMDRAGON].color="lightsteelblue",monsterlist[GREENURCHIN].color="lime",monsterlist[REDDRAGON].color="indianred"}Storage.prototype.setObject=function(e,t){let a=!1;25e3<(t=JSON.stringify(t)).length&&(this.setItem(e,COMPRESSED_DATA),e+=COMPRESSED_DATA,debug("setObject: compression start size: ".concat(t.length)),compressionWorker?(a=!0,compressionWorker.postMessage([e,t])):(t=LZString.compressToUTF16(t),debug("setObject: compression end size: ".concat(t.length)))),a||this.setItem(e,t)},Storage.prototype.getObject=function(e){var t=this.getItem(e);return t===COMPRESSED_DATA&&(t=this.getItem(e+COMPRESSED_DATA))&&(console.log("getObject: start size",t.length),t=LZString.decompressFromUTF16(t),console.log("getObject: end size",t.length)),t&&JSON.parse(t)};const VERSION="12.5.0",BUILD="495",ENABLE_DEVMODE=!1,ENABLE_MOBILE=!1;var lambda,youFound,period,ULARN=!1,DEBUG_STATS=!1,DEBUG_OUTPUT=!1,DEBUG_STAIRS_EVERYWHERE=!1,DEBUG_KNOW_ALL=!1,DEBUG_NO_MONSTERS=!1,DEBUG_PAINT=0,DEBUG_LPRCAT=0,DEBUG_LPRC=0,DEBUG_PROXIMITY=!1,dofs=!1;let compressionWorker,workersAvailable="file:"!=window.location.protocol;async function play(){console.log("".concat(gameID)),AWS.config.accessKeyId="AWS_CONFIG_ACCESSKEYID",AWS.config.secretAccessKey="AWS_CONFIG_SECRETACCESSKEY";try{initLambdaCredentials()}catch(e){console.error("not loading aws credentials: ".concat(e))}if(lambda=new AWS.Lambda({region:"us-east-1",apiVersion:"2015-03-31"}),initRB(),initKeyBindings(),document.addEventListener("click",onMouseClick),window.addEventListener("resize",onResize),window.Worker&&workersAvailable&&(compressionWorker=new Worker("worker.js"),compressionWorker.onmessage=onCompressed),"localhost"===location.hostname||""===location.hostname?enableDebug():window.onbeforeunload=confirmExit,altrender){for(var e=0;e<24;e++)for(var t=0;t<80;t++)display[t][e]=createDiv(t,e);images||loadImages(),bltDocument()}PARAMS=loadURLParameters(),no_intro=!!PARAMS.nointro&&"true"==PARAMS.nointro,mobile=!!PARAMS.mobile&&"true"==PARAMS.mobile,ENABLE_MOBILE&&(mobile=mobile||is_touch_device()),ULARN=!!PARAMS.ularn&&"true"==PARAMS.ularn,setGameConfig(),await loadFonts(),PARAMS.score?(player=new Player,loadScores(null,!0,!0)):welcome()}async function loadFonts(){await document.fonts.load("12px modern")}function confirmExit(){if(!GAMEOVER)return"Are you sure? Your game will be lost!"}function initKeyBindings(){Mousetrap.bind(".",mousetrap),Mousetrap.bind(",",mousetrap),Mousetrap.bind("<",mousetrap),Mousetrap.bind(">",mousetrap),Mousetrap.bind("^",mousetrap),Mousetrap.bind("!",mousetrap),Mousetrap.bind("@",mousetrap),Mousetrap.bind("#",mousetrap),Mousetrap.bind("{",mousetrap),Mousetrap.bind("}",mousetrap),Mousetrap.bind("?",mousetrap),Mousetrap.bind("_",mousetrap),Mousetrap.bind("-",mousetrap),Mousetrap.bind("+",mousetrap),Mousetrap.bind(["(",")"],mousetrap),Mousetrap.bind("tab",mousetrap),Mousetrap.bind("return",mousetrap),Mousetrap.bind("escape",mousetrap),Mousetrap.bind("backspace",mousetrap),Mousetrap.bind("space",mousetrap),Mousetrap.bind(["up","shift+up"],mousetrap),Mousetrap.bind(["down","shift+down"],mousetrap),Mousetrap.bind(["left","shift+left"],mousetrap),Mousetrap.bind(["right","shift+right"],mousetrap),Mousetrap.bind(["pageup","shift+pageup"],mousetrap),Mousetrap.bind(["pagedown","shift+pagedown"],mousetrap),Mousetrap.bind(["home","shift+home"],mousetrap),Mousetrap.bind(["end","shift+end"],mousetrap),Mousetrap.bind(["a","b","c","d","e","f","g","h","i","j","k","l","m"],mousetrap),Mousetrap.bind(["n","o","p","q","r","s","t","u","v","w","x","y","z"],mousetrap),Mousetrap.bind(["A","B","C","D","E","F","G","H","I","J","K","L","M"],mousetrap),Mousetrap.bind(["N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],mousetrap),Mousetrap.bind("*",mousetrap),Mousetrap.bind(["0","1","2","3","4","5","6","7","8","9"],mousetrap)}function enableDebug(){debug_used=1,document.body.style.backgroundColor="#002222",console.log("DEBUG_MODE: ON"),Mousetrap.bind("alt+`",eventToggleDebugStats),Mousetrap.bind("alt+1",eventToggleDebugOutput),Mousetrap.bind("alt+2",eventToggleDebugWTW),Mousetrap.bind("alt+3",eventToggleDebugStairs),Mousetrap.bind("alt+4",eventToggleDebugKnowAll),Mousetrap.bind("alt+5",eventToggleDebugStealth),Mousetrap.bind("alt+6",eventToggleDebugAwareness),Mousetrap.bind("alt+7",eventToggleDebugImmortal),Mousetrap.bind("alt+8",eventMagicMap),Mousetrap.bind("alt+9",eventEngolden),Mousetrap.bind("alt+0",eventToggleDebugNoMonsters),Mousetrap.bind("alt+-",eventToggleDebugProximity)}function eventToggleDebugStats(){debug_used=nomove=1,DEBUG_STATS=!DEBUG_STATS,updateLog("DEBUG_STATS: ".concat(DEBUG_STATS)),paint()}function eventToggleDebugOutput(){debug_used=nomove=1,DEBUG_OUTPUT=!DEBUG_OUTPUT,updateLog("DEBUG_OUTPUT: ".concat(DEBUG_OUTPUT)),paint()}function eventToggleDebugWTW(){debug_used=nomove=1,player.updateWTW(0==player.WTW?1e5:-player.WTW),updateLog("DEBUG_WALK_THROUGH_WALLS: ".concat(0<player.WTW)),paint()}function eventToggleDebugStairs(){debug_used=nomove=1,DEBUG_STAIRS_EVERYWHERE=!DEBUG_STAIRS_EVERYWHERE,updateLog("DEBUG_STAIRS_EVERYWHERE: ".concat(DEBUG_STAIRS_EVERYWHERE)),paint()}function eventToggleDebugKnowAll(){debug_used=nomove=1,DEBUG_KNOW_ALL=!0,learnAll(),updateLog("DEBUG_KNOW_ALL: ".concat(DEBUG_KNOW_ALL)),paint()}function learnAll(){for(let e=0;e<spelcode.length;e++)learnSpell(spelcode[e]);for(let e=0;e<SCROLL_NAMES.length;e++)learnScroll(createObject(OSCROLL,e));for(let e=0;e<POTION_NAMES.length;e++)learnPotion(createObject(OPOTION,e))}function eventToggleDebugStealth(){debug_used=nomove=1,player.STEALTH<=0?(player.updateHoldMonst(1e5),player.updateStealth(1e5),updateLog("DEBUG: FREEZING MONSTERS")):(player.updateHoldMonst(-player.HOLDMONST),player.updateStealth(-player.STEALTH),updateLog("DEBUG: UNFREEZING MONSTERS")),paint()}function eventToggleDebugAwareness(){debug_used=nomove=1,player.AWARENESS<=0?(player.AWARENESS=1e5,updateLog("DEBUG: EXPANDED AWARENESS++")):(player.AWARENESS=0,updateLog("DEBUG: EXPANDED AWARENESS--")),paint()}function eventMagicMap(){debug_used=nomove=1,read_scroll(createObject(OSCROLL,15)),paint()}function eventEngolden(){debug_used=nomove=1,player.GOLD+=25e4,paint()}function eventToggleDebugImmortal(){debug_used=nomove=1,player.LIFEPROT<=0?(player.LIFEPROT=1e5,updateLog("DEBUG: LIFE PROTECTION++")):(player.LIFEPROT=0,updateLog("DEBUG: LIFE PROTECTION--")),paint()}function eventToggleDebugNoMonsters(){debug_used=nomove=1,DEBUG_NO_MONSTERS=!DEBUG_NO_MONSTERS,updateLog("DEBUG: NO MONSTERS: ".concat(DEBUG_NO_MONSTERS)),paint()}function eventToggleDebugProximity(){debug_used=nomove=1,DEBUG_PROXIMITY=!DEBUG_PROXIMITY,updateLog("DEBUG: PROXIMITY: ".concat(DEBUG_PROXIMITY)),paint()}function welcome(){clear(),lflush(),createLevelNames(),initHelpPages(),amiga_mode=PARAMS.mode&&"amiga"==PARAMS.mode,retro_mode=localStorageGetObject("retro",!0),setMode(amiga_mode,retro_mode,original_objects),lprcat(helppages[0]),cursors(),logname=localStorageGetObject("logname",logname);var e=Math.random().toString(36).substr(2,5);localStorageSetObject("playerID",playerID=localStorageGetObject("playerID",e)),playerID===e&&(newplayer=!0,keyboard_hints=!0);e="Welcome to ".concat(GAMENAME,". Please enter your name [<b>").concat(logname,"</b>]: ");setDiv("FOOTER","* Please use only one name to leave room on the scoreboard for others"),lprcat(e),blinken(e.length-5,24),no_intro?setname(logname):setTextCallback(setname),blt()}function createLevelNames(){LEVELNAMES.push("H");for(let e=1;e<MAXLEVEL;e++)LEVELNAMES.push("".concat(e));for(let e=0;e<MAXVLEVEL;e++)LEVELNAMES.push("V".concat(e+1))}function setname(e){setDiv("FOOTER",""),(e=(e=e.trim())==ESC||""==e?logname:e)&&localStorageSetObject("logname",logname=e.substring(0,24)),cursors(),cltoeoln();var t=localStorageGetObject(logname),a=!1,e=!1;if(null!=t?e=!(a=null==(a=t.winner)?"winner"==t:a):r=localStorageGetObject("checkpoint"),setDifficulty(Number(localStorageGetObject("difficulty")||0)),player=new Player,no_intro)return setclass("Adventurer"),1;if(a)return clearBlinkingCursor(),readmail(),localStorageRemoveItem(logname),1;if(e||r)return e?loadSavedGame(t,!1):loadSavedGame(r,!0),clearBlinkingCursor(),setGameDifficulty(getDifficulty()),1;var r="What difficulty would you like to play? [<b>".concat(getDifficulty(),"</b>]: ");return lprcat(r),blinken(r.length-5,24),setNumberCallback(setdiff,!1),0}function setGameDifficulty(e){sethard(e=null==e||""==e||isNaN(Number(e))?getDifficulty():e),localStorageSetObject("difficulty",getDifficulty())}function sethard(e){e=Number(e),isNaN(e)&&(console.log("error setting difficulty, defaulting to 0"),e=0),setDifficulty(Math.max(0,e));var t=getDifficulty();if(0<getDifficulty())for(var a=0;a<monsterlist.length;a++){var r=monsterlist[a],o=((6+t)*r.hitpoints+1)/6;ULARN||(r.hitpoints=Math.min(32767,Math.round(o))),r.hitpoints=Math.round(o),o=((6+t)*r.damage+1)/5,ULARN||(r.damage=Math.min(127,Math.round(o))),r.damage=Math.round(o),o=10*r.gold/(10+t),r.gold=Math.min(32767,Math.round(o)),r.gold=Math.round(o),o=r.armorclass-t,r.armorclass=Math.max(-127,Math.round(o)),r.armorclass=Math.round(o),o=7*r.experience/(7+t)+1,r.experience=Math.max(1,Math.round(o)),r.experience=Math.round(o)}}function makeplayer(){learnPotion(createObject(OPOTION,21)),player.x=rnd(MAXX-2),player.y=rnd(MAXY-2),recalc(),changedAC=changedWC=0}function initFS(){try{var e,t=localStorageGetObject("gameNum",0)+1;localStorageSetObject("gameNum",t),(t<=5||4<getDifficulty())&&(dofs=!0,console.log("dofs: "+t+" "+dofs+" "+getDifficulty())),dofs&&(fsfunc(),e={displayName:logname,playerID_str:playerID,gameNum_int:t},console.log("fs",e),FS.identify(playerID,e))}catch(e){console.error("caught: ".concat(e))}}function initRB(){try{Rollbar.configure({payload:{code_version:"".concat(BUILD),environment:"".concat(BUILD)}})}catch(e){}}function getIP(){navigator.onLine?fetch("https://api.db-ip.com/v2/free/self").then(function(e){e.json().then(function(e){playerIP=e.ipAddress})}).catch(e=>console.log("no ip")):console.error("getIP(): offline")}function setdiff(e){if(clearBlinkingCursor(),winnerHardlev?(setDifficulty(winnerHardlev),setGameDifficulty(getDifficulty())):setGameDifficulty(e),!ULARN||no_intro)return setclass("Adventurer"),!0;clear(),lprcat("The Addiction of Ularn\n\n"),lprcat("     Pick a character class...\n\n"),lprcat("     a)  Ogre          Exceptional strength, but thick as a brick\n"),lprcat("     b)  Wizard        Smart, good at magic, but very weak\n"),lprcat("     c)  Klingon       Strong and average IQ, but unwise & very ugly\n"),lprcat("     d)  Elf           OK at magic, but a mediocre fighter\n"),lprcat("     e)  Rogue         Nimble and smart, but only average strength\n"),lprcat("     f)  Adventurer    Jack of all trades, master of none\n"),lprcat("     g)  Dwarf         Strong and healthy, but not good at magic\n"),lprcat("     h)  Rambo         Bad at everything, but has a Lance of Death\n"),cursors(),player.char_picked=localStorageGetObject("character_class")||"Adventurer",lprcat("So, what are ya? [<b>".concat(player.char_picked,"</b>]:")),lflush(),blinken(player.char_picked.length+23,24),setCharCallback(setclass)}function setclass(e){let t;return"a"===e||"Ogre"===e?t="Ogre":"b"===e||"Wizard"===e?t="Wizard":"c"===e||"Klingon"===e?t="Klingon":"d"===e||"Elf"===e?t="Elf":"e"===e||"Rogue"===e?t="Rogue":"f"===e||"Adventurer"===e?t="Adventurer":"g"===e||"Dwarf"===e?t="Dwarf":"h"===e||"Rambo"===e?t="Rambo":e===ENTER&&(t=player.char_picked),!!t&&(player.setCharacterClass(t),recalc(),changedAC=changedWC=0,!ULARN||no_intro?(setgender("Male"),!0):(localStorageSetObject("character_class",t),clear(),lprcat("The Addiction of Ularn\n\n"),lprcat("     Pick a gender...\n\n"),lprcat("     a)  Male\n"),lprcat("     b)  Female\n"),lprcat("     c)  I prefer to not be defined by traditional gender norms\n"),cursors(),player.gender=localStorageGetObject("gender")||"Male",lprcat("So, what are ya? [<b>".concat(player.gender,"</b>]:")),lflush(),blinken(player.gender.length+23,24),void setCharCallback(setgender)))}function setgender(e){let t;return"a"===e||"Male"===e?t="Male":"b"===e||"Female"===e?t="Female":"c"===e||"Other"===e?t="Other":e===ENTER&&(t=player.gender),!!t&&(player.setGender(t),ULARN&&localStorageSetObject("gender",t),startgame(getDifficulty()),clearBlinkingCursor(),!0)}function startgame(e){return initFS(),getIP(),makeplayer(),newcavelevel(0),lflush(),updateLog("Welcome to ".concat(GAMENAME,", ").concat(logname," -- Press <b>?</b> for help")),navigator.cookieEnabled||updateLog("Are cookies disabled? You may not be able to save your game!"),showcell(player.x,player.y),setMazeMode(!(GAMEOVER=!1)),game_started=!0,setButtons(),ENABLE_DEVMODE&&enableDevmode(),1}function mainloop(e,t){napping?debug("napping"):(nomove=0,parse(e,t),setButtons(),1!=nomove&&(regen(),randmonst(),0==dropflag?lookforobject(!0,auto_pickup):dropflag=0,player.TIMESTOP<=0&&(0!=player.HASTESELF&&0!=(1&player.HASTESELF)||(gtime++,movsphere(),0==hitflag&&(player.HASTEMONST&&movemonst(),movemonst()))),0==viewflag&&showcell(player.x,player.y),hitflag=viewflag=0,400<=gtime&&gtime%400==0&&saveGame(!0),recalc()),paint())}function parse2(){player.TIMESTOP<=0&&(player.HASTEMONST&&movemonst(),movemonst(),randmonst()),regen()}function run(e){for(var t=1;1==t;)0<(t=moveplayer(e))&&parse2(),0!=(t=1==hitflag?0:t)&&showcell(player.x,player.y)}function wizardmode(e){if("checkpoint"===e){var t=localStorageSetObject("checkpoint",localStorageGetObject("checkpointbackup"));return t?(updateLog("Sorry, no checkpoint found (or cookies are disabled)"),updateLog("".concat(t))):updateLog("Reload to restart from backup checkpoint"),1}if("savegame"===e){var a=localStorageGetObject(logname+"backup"),a=localStorageSetObject(logname,a);return a?(updateLog("Sorry, no backup save game found (or cookies are disabled)"),updateLog("".concat(a))):updateLog("Reload to restart from backup save game"),1}if("debug"===e)return updateLog("debugging shortcuts enabled"),enableDebug(),1;if(10==e.length||11==e.length)return updateLog("trying to load game "+e),dbQueryLoadGame(e),1;if(!["pvnert(x)","frobozz","fizban","main(){}","amiga"].includes(e))return updateLog("Sorry".concat(period)),1;wizard=1,player.TELEFLAG=0,player.setStrength(70),player.setIntelligence(70),player.setWisdom(70),player.setConstitution(70),player.setDexterity(70),player.setCharisma(70),player.inventory[0]=null,player.inventory[1]=null;a=createObject(OLANCE,25),e=createObject(OPROTRING,50);take(a),take(e),ULARN&&take(createObject(OSLAYER)),player.WEAR=null,player.WIELD=a,player.raiseexperience(6e6),player.AWARENESS=1e5;for(let e=0;e<spelcode.length;e++)learnSpell(spelcode[e]);if(player.setGold(25e4),player.level){for(let t=0;t<MAXY;t++)for(let e=0;e<MAXX;e++)player.level.know[e][t]=KNOWALL;for(var r=0;r<SCROLL_NAMES.length;r++){var o=createObject(OSCROLL,r);learnScroll(o),setItem(r,0,o)}for(var n=MAXX-1;n>MAXX-1-POTION_NAMES.length;n--){var i=createObject(OPOTION,MAXX-1-n);learnPotion(i),setItem(n,0,i)}for(var l=0,s=1,c=0;s<MAXY;)itemlist[++c]&&(setItem(l,s++,itemlist[c]),ULARN||(c==OORB.id&&--s,c==OELEVATORUP.id&&--s,c==OELEVATORDOWN.id&&--s));for(;++l<MAXX-1;)if(itemlist[++c]){if(setItem(l,s-1,itemlist[c]),!ULARN&&c>=OCOOKIE.id)break}else--l;if(ULARN)for(;c<OLIFEPRESERVER.id;){var d=itemlist[++c];d&&d!=OHOMEENTRANCE&&d!=OUNKNOWN&&setItem(l,--s,d)}}return 1}const itemlist=[];class Item{constructor(e,t){this.id=e,this.arg=t||0}getChar(){return itemlist[this.id].getChar(this.arg)}getDescription(){return itemlist[this.id].desc}matches(e,t){if(!e)return!1;let a=this.id==e.id;return t&&(a&=this.arg==e.arg),a}toString(e,t,a){var r=this.getDescription();return this.matches(OPOTION)?a&&!isKnownPotion(this,a)&&t?r+=" (of ".concat(POTION_NAMES[this.arg],")"):(isKnownPotion(this)||e||t)&&(r+=" of ".concat(POTION_NAMES[this.arg])):this.matches(OSCROLL)?a&&!isKnownScroll(this,a)&&t?r+=" (of ".concat(SCROLL_NAMES[this.arg],")"):(isKnownScroll(this)||e||t)&&(r+=" of "+SCROLL_NAMES[this.arg]):this.matches(OOPENDOOR)||this.matches(OCLOSEDDOOR)||this.matches(OWALL)||this.matches(OGOLDPILE)||this.matches(ODEADTHRONE)||this.matches(OBOOK)||this.matches(OTHRONE)||this.matches(OCHEST)||this.matches(OAMULET)||this.isRing()&&e&&!t||this.isGem()||(0<this.arg?r+=" +"+this.arg:this.arg<0&&(r+=" "+this.arg)),this!==(a=a||player).WEAR&&this!==a.SHIELD||e||(r+=" (being worn)"),this!==a.WIELD||e||(r+=" (weapon in hand)"),r}canWield(){return this.isWeapon()||this.isArmor()||this.isRing()}isWeapon(){var e=!1;return e|=this.matches(OSHIELD),e|=this.matches(ODAGGER),e|=this.matches(OSPEAR),e|=this.matches(OFLAIL),e|=this.matches(OBATTLEAXE),e|=this.matches(OLONGSWORD),e|=this.matches(O2SWORD),e|=this.matches(OSWORD),e|=this.matches(OLANCE),e|=this.matches(OSWORDofSLASHING),e|=this.matches(OHAMMER),e|=this.matches(OBELT),e|=this.matches(OVORPAL),e|=this.matches(OSLAYER),e|=this.matches(OPSTAFF)}isArmor(){var e=!1;return e|=this.matches(OSHIELD),e|=this.matches(OLEATHER),e|=this.matches(OSTUDLEATHER),e|=this.matches(ORING),e|=this.matches(OCHAIN),e|=this.matches(OSPLINT),e|=this.matches(OPLATE),e|=this.matches(OPLATEARMOR),e|=this.matches(OSSPLATE),e|=this.matches(OELVENCHAIN)}isGem(){var e=!1;return e|=this.matches(ODIAMOND),e|=this.matches(ORUBY),e|=this.matches(OEMERALD),e|=this.matches(OSAPPHIRE)}isRing(){var e=!1;return e|=this.matches(ORINGOFEXTRA),e|=this.matches(ODEXRING),e|=this.matches(ODAMRING),e|=this.matches(OREGENRING),e|=this.matches(OSTRRING),e|=this.matches(OPROTRING),e|=this.matches(OCLEVERRING),e|=this.matches(OENERGYRING)}isStore(){var e=!1;return e|=this.matches(OENTRANCE),e|=this.matches(OBANK),e|=this.matches(OBANK2),e|=this.matches(OLRS),e|=this.matches(OHOME),e|=this.matches(ODNDSTORE),e|=this.matches(OVOLUP),e|=this.matches(OVOLDOWN),e|=this.matches(OSCHOOL),e|=this.matches(OTRADEPOST),e|=this.matches(OPAD)}isDrug(){var e=!1;return e|=this.matches(OSPEED),e|=this.matches(OACID),e|=this.matches(OHASH),e|=this.matches(OSHROOMS),e|=this.matches(OCOKE)}getSortCode(){var e=1e4*(sortorder.indexOf(this.id)+1);return(isKnownScroll(this)||isKnownPotion(this))&&(e+=100*(this.arg+1)),e}}const DIV_START='url("img/',DIV_END='.png")',BOLD=!0,NO_BOLD=!1,NO_COLOR=null,CARRY=!0,NO_CARRY=!1;class DungeonObject extends Item{constructor(e,t,a,r,o,n,i,l){super(e,0),this.char=t,this.hackchar=a,this.ularnchar=r,this.color=o,this.bold=n,this.desc=i,this.carry=l,itemlist[e]||(itemlist[e]=this)}getChar(e){if(amiga_mode)return(this.id==OWALL.id?"".concat(DIV_START,"w").concat(e):"".concat(DIV_START,"o").concat(this.id)).concat(DIV_END);let t=null;return t=original_objects?ULARN?this.ularnchar:this.char:this.hackchar,show_color&&this.color&&(t="<font color='".concat(this.color,"'>").concat(t,"</font>")),bold_objects&&this.bold&&(t="<b>".concat(t,"</b>")),t}}function createObject(e,t){if(!e)return null;"number"==typeof e&&(e=itemlist[e]);var a=new Item(e.id,e.arg);return t?a.arg=t:e.arg?a.arg=e.arg:a.arg=0,a}const OEMPTY=new DungeonObject(0,"·","·","·",NO_COLOR,NO_BOLD,"the dungeon floor",NO_CARRY),OANNIHILATION=new DungeonObject(82,"s","0","s","crimson",BOLD,"a sphere of annihilation",NO_CARRY),OHOMEENTRANCE=new DungeonObject(93,OEMPTY.char,"8",OEMPTY.char,NO_COLOR,NO_BOLD,"the exit to the home level",NO_CARRY),OUNKNOWN=new DungeonObject(94," "," "," ",NO_COLOR,NO_BOLD,"... nothing",NO_CARRY),OHOME=new DungeonObject(69,"H","1","H","cornflowerblue",BOLD,"your way home",NO_CARRY),ODNDSTORE=new DungeonObject(12,"=","2","=","orchid",BOLD,"the DND store",NO_CARRY),OTRADEPOST=new DungeonObject(77,"S","3","S","tan",BOLD,"the local trading post",NO_CARRY),OLRS=new DungeonObject(80,"L","4","L","lightgray",BOLD,"the Larn Revenue Service",NO_CARRY),OBANK=new DungeonObject(16,"$","5","$","gold",BOLD,"the bank of Larn",NO_CARRY),OBANK2=new DungeonObject(15,"$","5","$","gold",BOLD,"the Nth branch of the Bank of Larn",NO_CARRY),OSCHOOL=new DungeonObject(10,"+","6","+","darkorange",BOLD,"the College of Larn",NO_CARRY),OENTRANCE=new DungeonObject(54,"E","8","E","yellowgreen",BOLD,"the dungeon entrance",NO_CARRY),OVOLDOWN=new DungeonObject(55,"V","9","V","crimson",BOLD,"a volcanic shaft leaning downward",NO_CARRY),OPAD=new DungeonObject(100,"@","@","@","lightgreen",BOLD,"Dealer McDope's Hideout!",NO_CARRY),OWALL=new DungeonObject(21,"▒","▒","▒",NO_COLOR,NO_BOLD,"a wall",NO_CARRY),OALTAR=new DungeonObject(1,"A",":","A","lightslategray",BOLD,"a holy altar",NO_CARRY),OTHRONE=new DungeonObject(2,"T","\\","T","gold",BOLD,"a handsome jewel encrusted throne",NO_CARRY),ODEADTHRONE=new DungeonObject(79,"t","/","t","lightgray",BOLD,"a massive throne",NO_CARRY),OPIT=new DungeonObject(4,"P","^","P","sandybrown",BOLD,"a pit",NO_CARRY),OVOLUP=new DungeonObject(56,"V","9","V","yellowgreen",BOLD,"the base of a volcanic shaft",NO_CARRY),OSTAIRSUP=new DungeonObject(5,"&lt","&lt","%","yellowgreen",BOLD,"a staircase going up",NO_CARRY),OSTAIRSDOWN=new DungeonObject(13,"&gt","&gt","%","sandybrown",BOLD,"a staircase going down",NO_CARRY),OFOUNTAIN=new DungeonObject(7,"F","{","F","cornflowerblue",BOLD,"a bubbling fountain",NO_CARRY),ODEADFOUNTAIN=new DungeonObject(17,"f","}","f","lightgray",BOLD,"a dead fountain",NO_CARRY),OSTATUE=new DungeonObject(8,"&","%","&","ivory",BOLD,"a great marble statue",NO_CARRY),OMIRROR=new DungeonObject(11,"M","|","M","silver",BOLD,"a mirror",NO_CARRY),OOPENDOOR=new DungeonObject(19,"O","'","O","lightgray",BOLD,"an open door",NO_CARRY),OCLOSEDDOOR=new DungeonObject(20,"D","+","D","lightgray",BOLD,"a closed door",NO_CARRY),OELEVATORUP=new DungeonObject(6,"_","_","_","yellowgreen",BOLD,"an express elevator going up",NO_CARRY),OELEVATORDOWN=new DungeonObject(14,"_","_","_","sandybrown",BOLD,"an express elevator going down",NO_CARRY),OIVTELETRAP=new DungeonObject(78,OEMPTY.char,OEMPTY.char,OEMPTY.char,NO_COLOR,NO_BOLD,"a teleport trap",NO_CARRY),OTELEPORTER=new DungeonObject(9,"^","^","^","mediumpurple",BOLD,"a teleport trap",NO_CARRY),OTRAPARROWIV=new DungeonObject(67,OEMPTY.char,OEMPTY.char,OEMPTY.char,NO_COLOR,NO_BOLD,"an arrow trap",NO_CARRY),OTRAPARROW=new DungeonObject(66,"^","^","^","lightgray",BOLD,"an arrow trap",NO_CARRY),ODARTRAP=new DungeonObject(74,"^","^","^","lightgreen",BOLD,"a dart trap",NO_CARRY),OIVDARTRAP=new DungeonObject(73,OEMPTY.char,OEMPTY.char,OEMPTY.char,NO_COLOR,NO_BOLD,"a dart trap",NO_CARRY),OTRAPDOOR=new DungeonObject(75,"^","^","^","sandybrown",BOLD,"a trapdoor",NO_CARRY),OIVTRAPDOOR=new DungeonObject(76,OEMPTY.char,OEMPTY.char,OEMPTY.char,NO_COLOR,NO_BOLD,"a trapdoor",NO_CARRY),OGOLDPILE=new DungeonObject(18,"*","$","*","gold",BOLD,"some gold",CARRY,0),OSCROLL=new DungeonObject(41,"?","?","?","tan",BOLD,"a magic scroll",CARRY),OPOTION=new DungeonObject(42,"!","!","!","plum",BOLD,"a magic potion",CARRY),OBOOK=new DungeonObject(43,"B","?","B","darkgoldenrod",BOLD,"a book",CARRY),OCHEST=new DungeonObject(44,"C","&","C","khaki",BOLD,"a chest",CARRY),ODIAMOND=new DungeonObject(50,"@","*","&lt","white",BOLD,"a brilliant diamond",CARRY),ORUBY=new DungeonObject(51,"@","*","&lt","crimson",BOLD,"a ruby",CARRY),OEMERALD=new DungeonObject(52,"@","*","&lt","springgreen",BOLD,"an enchanting emerald",CARRY),OSAPPHIRE=new DungeonObject(53,"@","*","&lt","dodgerblue",BOLD,"a sparkling sapphire",CARRY),OCOOKIE=new DungeonObject(83,"c",",","c","tan",BOLD,"a fortune cookie",CARRY),OSWORD=new DungeonObject(28,")",")",")","lightgray",BOLD,"a sunsword",CARRY),O2SWORD=new DungeonObject(29,"(",")","(","lightgray",BOLD,"a two handed sword",CARRY),OSPEAR=new DungeonObject(30,"(",")","(","lightgray",BOLD,"a spear",CARRY),ODAGGER=new DungeonObject(31,"(",")","(","lightgray",BOLD,"a dagger",CARRY),OBELT=new DungeonObject(40,"{","-","{","darkgoldenrod",BOLD,"a belt of striking",CARRY),OBATTLEAXE=new DungeonObject(57,")",")",")","lightgray",BOLD,"a battle axe",CARRY),OLONGSWORD=new DungeonObject(58,")",")",")","lightgray",BOLD,"a longsword",CARRY),OFLAIL=new DungeonObject(59,"(",")","(","lightgray",BOLD,"a flail",CARRY),OLANCE=new DungeonObject(65,")",")",")","lightgray",BOLD,"a lance of death",CARRY),OSWORDofSLASHING=new DungeonObject(26,")",")",")","cornflowerblue",BOLD,"a sword of slashing",CARRY),OHAMMER=new DungeonObject(27,")",")",")","darkgoldenrod",BOLD,"Bessman's flailing hammer",CARRY),OVORPAL=new DungeonObject(90,")",")",")","darkorange",BOLD,"the Vorpal Blade",CARRY),OSLAYER=new DungeonObject(91,")",")",")","crimson",BOLD,"Slayer",CARRY),OLEATHER=new DungeonObject(25,"[","[","[","lightgray",BOLD,"leather armor",CARRY),OSTUDLEATHER=new DungeonObject(61,"[","[","[","lightgray",BOLD,"studded leather armor",CARRY),ORING=new DungeonObject(60,"[","[","[","lightgray",BOLD,"ring mail",CARRY),OCHAIN=new DungeonObject(24,"[","[","[","lightgray",BOLD,"chain mail",CARRY),OSPLINT=new DungeonObject(62,"]","[","]","lightgray",BOLD,"splint mail",CARRY),OPLATE=new DungeonObject(23,"]","[","]","lightgray",BOLD,"plate mail",CARRY),OPLATEARMOR=new DungeonObject(63,"]","[","]","lightgray",BOLD,"plate armor",CARRY),OSSPLATE=new DungeonObject(64,"]","[","]","lightgray",BOLD,"stainless plate armor",CARRY),OSHIELD=new DungeonObject(68,"[","[","[","lightgray",BOLD,"a shield",CARRY),OELVENCHAIN=new DungeonObject(92,"]","]","]","cornflowerblue",BOLD,"elven chain",CARRY),ORINGOFEXTRA=new DungeonObject(32,"=","=","|","lightgray",BOLD,"a ring of extra regeneration",CARRY),OREGENRING=new DungeonObject(33,"=","=","|","lightgray",BOLD,"a ring of regeneration",CARRY),OPROTRING=new DungeonObject(34,"=","=","|","lightgray",BOLD,"a ring of protection",CARRY),OENERGYRING=new DungeonObject(35,"=","=","|","lightgray",BOLD,"an energy ring",CARRY),ODEXRING=new DungeonObject(36,"=","=","|","lightgray",BOLD,"a ring of dexterity",CARRY),OSTRRING=new DungeonObject(37,"=","=","|","lightgray",BOLD,"a ring of strength",CARRY),OCLEVERRING=new DungeonObject(38,"=","=","|","lightgray",BOLD,"a ring of cleverness",CARRY),ODAMRING=new DungeonObject(39,"=","=","|","lightgray",BOLD,"a ring of increase damage",CARRY),OLARNEYE=new DungeonObject(22,"~","~","~","magenta",BOLD,"The Eye of Larn",CARRY),OAMULET=new DungeonObject(45,"}","~",".","gold",BOLD,"an amulet of invisibility",CARRY),OORBOFDRAGON=new DungeonObject(46,"o","~","o","skyblue",BOLD,"an orb of dragon slaying",CARRY),OSPIRITSCARAB=new DungeonObject(47,":","~",".","darkorange",BOLD,"a scarab of negate spirit",CARRY),OCUBEofUNDEAD=new DungeonObject(48,";","~",".","plum",BOLD,"a cube of undead control",CARRY),ONOTHEFT=new DungeonObject(49,",","~",".","cornflowerblue",BOLD,"a device of theft prevention",CARRY),OORB=new DungeonObject(3,"o","~","o","plum",BOLD,"an orb of enlightenment",CARRY),OBRASSLAMP=new DungeonObject(85,".",".",".","gold",BOLD,"a brass lamp",CARRY),OHANDofFEAR=new DungeonObject(86,".",".",".","crimson",BOLD,"The Hand of Fear",CARRY),OSPHTALISMAN=new DungeonObject(87,".",".",".","skyblue",BOLD,"The Talisman of the Sphere",CARRY),OWWAND=new DungeonObject(88,"/","/","/","mediumseagreen",BOLD,"a wand of wonder",CARRY),OPSTAFF=new DungeonObject(89,"/","/","/","darkorange",BOLD,"a staff of power",CARRY),OLIFEPRESERVER=new DungeonObject(101,'"','"','"',"orange",BOLD,"an amulet of life preservation",CARRY),OSPEED=new DungeonObject(95,":",":",":","paleblue",BOLD,"some speed",CARRY),OACID=new DungeonObject(96,":",":",":","mediumpurple",BOLD,"some LSD",CARRY),OHASH=new DungeonObject(97,":",":",":","sandybrown",BOLD,"some hashish",CARRY),OSHROOMS=new DungeonObject(98,":",":",":","tan",BOLD,"some magic mushrooms",CARRY),OCOKE=new DungeonObject(99,":",":",":","snow",BOLD,"some cocaine",CARRY);function getItemDir(e){return itemAt(player.x+diroffx[e],player.y+diroffy[e])}function itemAt(e,t){if(null==e||null==t||e<0||e>=MAXX||t<0||t>=MAXY)return null;if(!player.level.items[e][t]){var a="itemAt(): null item: x=".concat(e," y=").concat(t);console.log(a);try{Rollbar.error("".concat(a))}catch(e){}}return player.level.items[e][t]}function setItem(e,t,a){return null==e||null==t||e<0||e>=MAXX||t<0||t>=MAXY?null:(player.level.items[e][t]=createObject(a,a.arg),a)}function isItemAt(e,t){t=itemAt(e,t);return t&&!t.matches(OEMPTY)}function setWallArg(e,t){var a,r=itemAt(e,t);r&&r.matches(OWALL)&&(r.arg=0,(a=itemAt(e,t-1))&&a.matches(OWALL)&&(r.arg+=2),(a=itemAt(e+1,t))&&a.matches(OWALL)&&(r.arg+=4),(a=itemAt(e,t+1))&&a.matches(OWALL)&&(r.arg+=8),(a=itemAt(e-1,t))&&a.matches(OWALL)&&(r.arg+=16))}function lookforobject(t,e){if(!player.TIMESTOP){showcell(player.x,player.y);var a=itemAt(player.x,player.y);if(a.matches(OEMPTY))nomove=1;else{if(a.matches(OGOLDPILE))return ULARN?updateLog("".concat(youFound," ").concat(Number(a.arg).toLocaleString()," gold pieces").concat(period)):(updateLog("".concat(youFound," some gold!")),updateLog("  It is worth ".concat(Number(a.arg).toLocaleString(),"!"))),player.setGold(player.GOLD+a.arg),void forget();if(a.matches(OALTAR)){if(nearbymonst())return;t&&updateLog("There is a Holy Altar here!",formatHint("p","to pray","A","to desecrate"))}else if(a.matches(OTHRONE)){if(nearbymonst())return;t&&updateLog("There is ".concat(a," here!"),formatHint("R","remove gems","s","sit down"))}else if(a.matches(ODEADTHRONE)){if(nearbymonst())return;t&&updateLog("There is ".concat(a," here!"),formatHint("s","sit down"))}else if(a.matches(OPIT))updateLog("You're standing at the top of a pit".concat(period)),opit();else if(a.matches(OMIRROR)){if(nearbymonst())return;t&&updateLog("There is a mirror here".concat(period))}else if(a.matches(OFOUNTAIN)){if(nearbymonst())return;t&&updateLog("There is a fountain here".concat(period),formatHint("f","to wash","D","to drink"))}else if(a.matches(ODEADFOUNTAIN)){if(nearbymonst())return;t&&updateLog("There is a dead fountain here".concat(period))}else if(ULARN&&a.matches(OOPENDOOR)){if(nearbymonst())return;t&&updateLog("There is an open door here".concat(period))}else if(a.matches(ODNDSTORE)){if(nearbymonst())return;t&&updateLog("There is a DND store here".concat(period),formatHint("e","to go inside"))}else if(a.matches(OPAD)){if(nearbymonst())return;t&&updateLog("You have found ".concat(a),formatHint("e","to go inside"))}else if(a.isStore()){if(nearbymonst())return;t&&updateLog("You have found ".concat(a).concat(period),formatHint("e","to go inside"))}else if(a.matches(OSTATUE)){if(nearbymonst())return;t&&updateLog("You are standing in front of a statue".concat(period))}else if(a.matches(OIVTELETRAP)){if(rnd(11)<6)return;setItem(player.x,player.y,OTELEPORTER),player.level.know[player.x][player.y]=KNOWALL,lookforobject(t,e)}else if(a.matches(OTELEPORTER))updateLog("Zaaaappp!  You've been teleported!"),oteleport(0);else{if(a.matches(OTRAPARROWIV))return rnd(17)<13?void 0:(setItem(player.x,player.y,OTRAPARROW),player.level.know[player.x][player.y]=KNOWALL,void lookforobject(t,e));if(a.matches(OTRAPARROW))return updateLog("You are hit by an arrow!"),lastnum=DIED_ARROW,void player.losehp(rnd(10)+level);if(a.matches(OIVDARTRAP))return rnd(17)<13?void 0:(setItem(player.x,player.y,ODARTRAP),player.level.know[player.x][player.y]=KNOWALL,void lookforobject(t,e));if(a.matches(ODARTRAP))return updateLog("You are hit by a dart!"),lastnum=DIED_DART,player.losehp(rnd(5)),void player.setStrength(player.STRENGTH-1);if(a.matches(OIVTRAPDOOR))return rnd(17)<13?void 0:(setItem(player.x,player.y,OTRAPDOOR),player.level.know[player.x][player.y]=KNOWALL,void lookforobject(t,e));if(a.matches(OTRAPDOOR)){if(isCarrying(OWWAND))return void updateLog("You escape a trap door!");if(level==DBOTTOM||level==VBOTTOM){var r=ULARN?"leading straight to HELL":"";return updateLog("You fell through a bottomless trap door ".concat(r,"!")),void died(DIED_BOTTOMLESS_TRAPDOOR,!1)}r=rnd(5+level);return updateLog("You fall through a trap door! You lose ".concat(r," hit points").concat(period)),lastnum=DIED_TRAPDOOR,player.losehp(r),void newcavelevel(level+1)}if(a.matches(OANNIHILATION)){if(!isCarrying(OSPHTALISMAN))return updateLog("You have been enveloped by the zone of nothingness!"),void died(DIED_ANNIHILATED,!1);updateLog("The Talisman of the Sphere protects you from annihilation!")}else if(a.matches(OSTAIRSUP)){let e="".concat(youFound," ").concat(a);ULARN&&(e="There is a circular staircase here".concat(period)),t&&updateLog(e,formatHint("<","go up"))}else if(a.matches(OSTAIRSDOWN)){let e="".concat(youFound," ").concat(a);ULARN&&(e="There is a circular staircase here".concat(period)),t&&updateLog(e,formatHint(">","go down"))}else a.matches(OELEVATORUP)?(updateLog("You have found ".concat(a)),oelevator(1)):a.matches(OELEVATORDOWN)?(updateLog("You have found ".concat(a)),oelevator(-1)):a.matches(OBRASSLAMP)?updateLog("You find ".concat(a).concat(period," [<b>R</b> to rub]")):a.matches(OPOTION)?t&&updateLog("".concat(youFound," ").concat(a).concat(period),formatHint("t","to take","q","to quaff")):a.matches(OSCROLL)||a.matches(OBOOK)?t&&updateLog("".concat(youFound," ").concat(a).concat(period),formatHint("t","to take","r","to read")):a.isArmor()?t&&updateLog("".concat(youFound," ").concat(a).concat(period),formatHint("t","to take","W","to wear")):a.isWeapon()?t&&updateLog("".concat(youFound," ").concat(a).concat(period),formatHint("t","to take","w","to wield")):a.matches(OCHEST)?t&&updateLog("There is a chest here".concat(period),formatHint("t","to take","o","to open")):a.matches(OCOOKIE)?t&&updateLog("".concat(youFound," ").concat(a).concat(period),formatHint("t","to take","E","to eat")):a.matches(OSPEED)?t&&updateLog("".concat(youFound," ").concat(a).concat(period," [<b>s</b> to snort]")):a.matches(OSHROOMS)||a.matches(OACID)?t&&updateLog("".concat(youFound," ").concat(a).concat(period," [<b>e</b> to eat]")):a.matches(OHASH)?t&&updateLog("".concat(youFound," ").concat(a).concat(period," [<b>s</b> to smoke]")):a.matches(OCOKE)?t&&updateLog("".concat(youFound," ").concat(a).concat(period," [<b>s</b> to snort]")):canTake(a)?t&&updateLog("".concat(youFound," ").concat(a).concat(period),formatHint("t","to take")):t&&!a.matches(OWALL)&&updateLog("".concat(youFound," ").concat(a).concat(period))}e&&(canTake(a)&&take(a)?forget():nomove=1)}}}function formatHint(e,t,a,r){t="<b>".concat(e,"</b> ").concat(t),r=a&&r?", <b>".concat(a,"</b> ").concat(r):"";return"[".concat(t).concat(r,"]")}function opit(){var e,t;81<=rnd(101)||rnd(70)<=9*player.DEXTERITY-packweight()&&5<=rnd(101)||(isCarrying(OWWAND)?updateLog("You float right over the pit!"):level==DBOTTOM||VBOTTOM<=level?obottomless():(e=0,rnd(101)<20?(t=ULARN?"A poor monster cushions your fall!":"Your fall is cushioned by an unknown force".concat(period),updateLog("You fell into a pit! ".concat(t))):(t=1==(e=rnd(3*level+3))?"":"s",updateLog("You fell into a pit! You suffer ".concat(e," hit point").concat(t," damage").concat(period)),lastnum=DIED_PIT),player.losehp(e),newcavelevel(level+1)))}function obottomless(){updateLog(ULARN?"You fell into a pit leading straight to HELL!":"You fell into a bottomless pit!"),beep(),died(DIED_BOTTOMLESS_PIT,!1)}function oelevator(e){if(1==e){if(0==level)return void appendLog(", unfortunately it is out of order".concat(period));player.x=rnd(MAXX-2),player.y=rnd(MAXY-2),newcavelevel(level<=DBOTTOM?rund(level):e=(e=DBOTTOM+rund(level-DBOTTOM))==DBOTTOM?0:e)}else{if(level==DBOTTOM||level==VBOTTOM)return updateLog("  and it leads straight to HELL!"),beep(),void died(DIED_BOTTOMLESS_ELEVATOR,!1);player.x=rnd(MAXX-2),player.y=rnd(MAXY-2),newcavelevel(level<=DBOTTOM?level+rnd(DBOTTOM-level):level+rnd(VBOTTOM-level))}positionplayer()}function forget(){setItem(player.x,player.y,OEMPTY)}function oteleport(e){if(e&&0!=level&&rnd(151)<3){if(0==player.WTW)return updateLog("You are trapped in solid rock!"),void died(DIED_SOLID_ROCK,!1);updateLog("You feel lucky!")}var t;0==player.TELEFLAG&&0!=level&&(changedDepth=millis()),player.TELEFLAG=wizard?0:1,0==level?t=0:level<MAXLEVEL?(t=rnd(5)+level-3,(t=MAXLEVEL<=t?DBOTTOM:t)<1&&(t=1)):(t=rnd(ULARN?4:3)+level-2,(t=MAXLEVEL+MAXVLEVEL<=t?VBOTTOM:t)<MAXLEVEL&&(t=MAXLEVEL)),player.x=rnd(MAXX-2),player.y=rnd(MAXY-2),lasthy=lasthx=0,e&&updateLog("Zaaaappp!"),level!=t&&newcavelevel(t),positionplayer()}function readbook(e){var t=e.arg,t=t<=3?rund(splev[t]||1):rnd(splev[t]-9||1)+9;ULARN||t!=MKW?(learnSpell(spelcode[t]),updateLog("Spell '<b>".concat(spelcode[t],"</b>': ").concat(spelname[t])),updateLog("  ".concat(speldescript[t]).concat(period)),4==rnd(10)&&(updateLog(ULARN?"You feel clever!":"  Your intelligence went up by one!"),player.setIntelligence(player.INTELLIGENCE+1))):readbook(e)}function adjtime(e){player.STEALTH&&player.updateStealth(-e),player.UNDEADPRO&&player.updateUndeadPro(-e),player.SPIRITPRO&&player.updateSpiritPro(-e),player.CHARMCOUNT&&player.updateCharmCount(-e),player.HOLDMONST&&player.updateHoldMonst(-e),player.GIANTSTR&&player.updateGiantStr(-e),player.FIRERESISTANCE&&player.updateFireResistance(-e),player.DEXCOUNT&&player.updateDexCount(-e),player.STRCOUNT&&player.updateStrCount(-e),player.SCAREMONST&&player.updateScareMonst(-e),player.HASTESELF&&player.updateHasteSelf(-e),player.CANCELLATION&&player.updateCancellation(-e),player.INVISIBILITY&&player.updateInvisibility(-e),player.ALTPRO&&player.updateAltPro(-e),player.PROTECTIONTIME&&player.updateProtectionTime(-e),player.WTW&&player.updateWTW(-e),player.HERO=0<player.HERO?Math.max(1,player.HERO-e):0,player.GLOBE=0<player.GLOBE?Math.max(1,player.GLOBE-e):0,player.AWARENESS=0<player.AWARENESS?Math.max(1,player.AWARENESS-e):0,player.SEEINVISIBLE=0<player.SEEINVISIBLE?Math.max(1,player.SEEINVISIBLE-e):0,player.AGGRAVATE=0<player.AGGRAVATE?Math.max(1,player.AGGRAVATE-e):0,player.HASTEMONST=0<player.HASTEMONST?Math.max(1,player.HASTEMONST-e):0,player.HALFDAM=0<player.HALFDAM?Math.max(1,player.HALFDAM-e):0,player.ITCHING=0<player.ITCHING?Math.max(1,player.ITCHING-e):0,player.CLUMSINESS=0<player.CLUMSINESS?Math.max(1,player.CLUMSINESS-e):0,regen()}const ENCH_SCROLL=0,ENCH_ALTAR=1,ENCH_FOUNTAIN=2;function positionplayer(e,t,a){null==e&&(e=player.x),null==t&&(t=player.y);var r=0;if((a=null==a?!1:a)&&canMove(e,t))return player.x=e,player.y=t,player.level.know[player.x][player.y]=KNOWALL,!0;for(var r=1,o=20;r<10;){for(;0<o--;){var n=e+(rnd(3)-2)*r,i=t+(rnd(3)-2)*r;if((n!=e||i!=t)&&canMove(n,i))return player.x=n,player.y=i,player.level.know[player.x][player.y]=KNOWALL,!0}o=20,r++}return debug("positionplayer: couldn't place player"),!1}function canMove(e,t){if(e<0)return!1;if(e>=MAXX)return!1;if(t<0)return!1;if(t>=MAXY)return!1;var a=itemAt(e,t);return!a.matches(OWALL)&&!a.matches(OCLOSEDDOOR)&&!monsterAt(e,t)}function recalc(){var e=player.AC,t=player.WCLASS;player.WCLASS=0,player.AC=0;var a,r=player.WEAR,o=player.WIELD,n=player.SHIELD;r&&(a=r.arg,r.matches(OSHIELD)&&(player.AC=2+a),r.matches(OLEATHER)&&(player.AC=2+a),r.matches(OSTUDLEATHER)&&(player.AC=3+a),r.matches(ORING)&&(player.AC=5+a),r.matches(OCHAIN)&&(player.AC=6+a),r.matches(OSPLINT)&&(player.AC=7+a),r.matches(OPLATE)&&(player.AC=9+a),r.matches(OPLATEARMOR)&&(player.AC=10+a),r.matches(OSSPLATE)&&(player.AC=12+a),r.matches(OELVENCHAIN)&&(player.AC=15+a)),n&&n.matches(OSHIELD)&&(player.AC+=2+n.arg),player.AC+=player.MOREDEFENSES,o&&(a=o.arg,o.matches(ODAGGER)&&(player.WCLASS=3+a),o.matches(OBELT)&&(player.WCLASS=7+a),o.matches(OSHIELD)&&(player.WCLASS=8+a),o.matches(OPSTAFF)&&(player.WCLASS=10+a),o.matches(OSPEAR)&&(player.WCLASS=10+a),o.matches(OFLAIL)&&(player.WCLASS=14+a),o.matches(OBATTLEAXE)&&(player.WCLASS=17+a),o.matches(OLANCE)&&(player.WCLASS=(ULARN?20:19)+a),o.matches(OLONGSWORD)&&(player.WCLASS=22+a),o.matches(OVORPAL)&&(player.WCLASS=22+a),o.matches(O2SWORD)&&(player.WCLASS=26+a),o.matches(OSWORDofSLASHING)&&(player.WCLASS=30+a),o.matches(OSLAYER)&&(player.WCLASS=30+a),o.matches(OSWORD)&&(player.WCLASS=32+a),o.matches(OHAMMER)&&(player.WCLASS=35+a)),player.WCLASS+=player.MOREDAM,player.REGEN=1;for(var i=player.ENERGY=0;i<player.inventory.length;i++){var l=player.inventory[i];l&&(l.matches(OBELT)&&(player.WCLASS+=2+(l.arg<<1)),l.matches(OPROTRING)&&(player.AC+=l.arg+1),l.matches(ODAMRING)&&(player.WCLASS+=l.arg+1),l.matches(OREGENRING)&&(player.REGEN+=l.arg+1),l.matches(ORINGOFEXTRA)&&(player.REGEN+=5*(l.arg+1)),l.matches(OENERGYRING)&&(player.ENERGY+=l.arg+1))}player.WCLASS=Math.max(0,player.WCLASS),player.AC=Math.max(0,player.AC),e!=player.AC&&(changedAC=millis()),t!=player.WCLASS&&(changedWC=millis())}function createGem(){var e,t;switch(rnd(4)){case 1:e=ODIAMOND,t=50;break;case 2:e=ORUBY,t=40;break;case 3:e=OEMERALD,t=30;break;default:e=OSAPPHIRE,t=20}return createObject(e,rnd(t)+t/10)}function createGold(e){return 250<e&&(e=100*Math.round(e/100)),createObject(OGOLDPILE,e)}function createRandomItem(e){return newobject(e)}function more(e){cltoeoln(),lprcat("Press <b>space</b> to continue"),e&&lprcat(", <b>escape</b> to cancel, letter to select: ")}function enchantarmor(e){var t;if(player.WEAR)t=player.WEAR;else{if(!player.SHIELD)return cursors(),beep(),e!=ENCH_FOUNTAIN&&updateLog("You feel a sense of loss".concat(period)),!1;t=player.SHIELD}if(!t.matches(OSCROLL)&&!t.matches(OPOTION)){if(e==ENCH_FOUNTAIN&&0<=t.arg)return!1;(t=ULARN?(t=rund(100)<50?player.SHIELD:player.WEAR)||(t==player.SHIELD?player.WEAR:player.SHIELD):t).arg++;var a=t===player.SHIELD?"shield":"armor";if(!ULARN)return updateLog("  You feel your ".concat(a," vibrate for a moment")),!0;if(!(10<=t.arg))return updateLog("  Your ".concat(a," glows for a moment").concat(period)),!0;if(e==ENCH_ALTAR)return t.arg--,updateLog("Your ".concat(t.toString(!0)," glows briefly").concat(period)),!1;if(rnd(10)<=9)return destroyInventory(t),updateLog("  Your ".concat(a," vibrates violently and crumbles into dust!")),!1}return!1}function enchweapon(e){var t=player.WIELD;return t?!t.matches(OSCROLL)&&!t.matches(OPOTION)&&(!(e==ENCH_FOUNTAIN&&0<=t.arg)&&(t.arg++,t.matches(OCLEVERRING)?player.setIntelligence(player.INTELLIGENCE+1):t.matches(OSTRRING)?player.setStrExtra(player.STREXTRA+1):t.matches(ODEXRING)&&player.setDexterity(player.DEXTERITY+1),ULARN?10<=t.arg&&rnd(10)<=9?(e==ENCH_ALTAR?(t.arg--,updateLog("  Your weapon glows a little".concat(period))):(destroyInventory(t),updateLog("  Your weapon vibrates violently and crumbles into dust!")),!1):(updateLog("  Your weapon glows for a moment".concat(period)),!0):(updateLog("  You feel your weapon vibrate for a moment".concat(period)),!0))):(cursors(),beep(),!e!=ENCH_FOUNTAIN&&updateLog((ULARN?"  You feel depressed":"  You feel a sense of loss").concat(period)),!1)}function destroyInventory(e){var t=player.inventory.indexOf(e);e===player.WEAR&&(player.WEAR=null),e===player.SHIELD&&(player.SHIELD=null),e===player.WIELD&&(player.WIELD=null),player.inventory[t]=null,player.adjustcvalues(e,!1)}function nearbymonst(){for(var e=player.x-1;e<player.x+2;e++)for(var t=player.y-1;t<player.y+2;t++)if(monsterAt(e,t))return!0;return!1}function nearbymonsters(){for(var e=[],t=player.x-1;t<player.x+2;t++)for(var a=player.y-1;a<player.y+2;a++){var r=monsterAt(t,a);r&&e.push(r)}return e}function nearPlayer(e){for(var t=vx(player.x-1);t<vx(player.x+2);t++)for(var a=vy(player.y-1);a<vy(player.y+2);a++)if(itemAt(t,a).matches(e))return!0;return!1}function makemonst(e){var t,a;for(e<1?e=1:12<e&&(e=12),a=e<5?rnd(t=0==(t=monstlevel[e-1])?1:t):rnd(t=0==(t=monstlevel[e-1]-monstlevel[e-4])?1:t)+monstlevel[e-4];isGenocided(a)&&a<monsterlist.length-1;)a++;return a=ULARN&&level<MAXLEVEL&&rnd(100)<10?LEMMING:a}function stealsomething(){for(var e=100;;){var t=rund(26),a=player.inventory[t];if(a&&a!==player.WIELD&&a!==player.WEAR&&a!==player.SHIELD)return updateLog("  ".concat(getCharFromIndex(t),") ").concat(a)),player.adjustcvalues(a,!1),player.inventory[t]=null,a;if(--e<=0)return null}}function emptyhanded(){for(var e=0;e<26;e++){var t=player.inventory[e];if(t&&t!==player.WIELD&&t!==player.WEAR&&t!==player.SHIELD)return!1}return!0}function packweight(){for(var e=player.GOLD/1e3,t=0;t<player.inventory.length;t++){var a=player.inventory[t];if(a)switch(a.id){case OSSPLATE.id:case OPLATEARMOR.id:e+=40;break;case OPLATE.id:e+=35;break;case OHAMMER.id:e+=30;break;case OSPLINT.id:e+=26;break;case OSWORDofSLASHING.id:e+=ULARN?15:23;break;case OCHAIN.id:case OBATTLEAXE.id:case O2SWORD.id:e+=23;break;case OLONGSWORD.id:case OPSTAFF.id:case OSWORD.id:case ORING.id:case OFLAIL.id:e+=20;break;case OELVENCHAIN.id:case OLANCE.id:case OSLAYER.id:case OVORPAL.id:case OSTUDLEATHER.id:e+=15;break;case OLEATHER.id:case OSPEAR.id:e+=8;break;case OORBOFDRAGON.id:case OORB.id:case OBELT.id:e+=4;break;case OSHIELD.id:e+=7;break;case OCHEST.id:e+=30+a.arg;break;default:e++}}return e}function revealLevel(){for(let t=0;t<MAXX;t++)for(let e=0;e<MAXY;e++)player.level.know[t][e]=KNOWALL}async function nap(t){return!!PARAMS.nonap&&"true"==PARAMS.nonap&&(t=10),new Promise(e=>{setTimeout(()=>{e("resolved")},t)})}var monsterlist,Monster=function(e,t,a,r,o,n,i,l,s,c,d,p,u){this.arg=d,this.char=e,this.desc=t,this.level=a,this.armorclass=r,this.damage=o,this.attack=n,this.intelligence=i,this.gold=l,this.experience=c,this.inventory=[],this.hitpoints=s,this.awake=p,this.moved=u,this.color=NO_COLOR};function createMonster(t){if(!t)return null;if(DEBUG_NO_MONSTERS)return null;var e=t.arg;e||(t=monsterlist[e=t]);var a=new Monster(t.char,t.desc,t.level,t.armorclass,t.damage,t.attack,t.intelligence,t.gold,t.hitpoints,t.experience,t.arg,t.awake,t.moved);if(t.inventory&&0<t.inventory.length)for(let e=0;e<t.inventory.length;e++)a.inventory[e]=createObject(t.inventory[e]);else a.initInventory();return ULARN&&e==MIMIC&&(a.mimicarg=t.mimicarg||createMimicArg(),a.mimiccounter=t.mimiccounter||0),a}function createMimicArg(){let e=rnd(REDDRAGON);return e==INVISIBLESTALKER&&e++,e}function randmonst(){player.TIMESTOP||--rmst<=0&&(rmst=120-(level<<2),fillmonst(makemonst(level)))}function newobject(e){var t=rnd(6<e?41:4<e?39:33),a=nobjtab[t],r=0;switch(t){case 1:case 2:case 3:case 4:r=newscroll();break;case 5:case 6:case 7:case 8:r=newpotion();break;case 9:case 10:case 11:case 12:r=rnd(10*(e+1))+10*e+10;break;case 13:case 14:case 15:case 16:r=e;break;case 17:case 18:case 19:r=newdagger();break;case 20:case 21:case 22:r=newleather();break;case 23:case 32:case 38:r=rund(e/3+1);break;case 24:case 26:r=rnd(e/4+1);break;case 25:r=rund(e/4+1);break;case 27:case 39:r=rnd(e/2+1);break;case 30:case 34:r=rund(e/2+1);break;case 28:case 36:r=rund(e/3+1);break;case 29:case 31:case 37:r=rund(e/2+1);break;case 33:r=0;break;case 35:r=newchain();break;case 40:r=newplate();break;case 41:r=newsword()}return createObject(a,r)}Monster.prototype={arg:0,char:"💩",desc:null,level:0,armorclass:0,damage:0,attack:0,defense:0,intelligence:0,gold:0,hitpoints:0,experience:0,awake:!1,moved:!1,matches:function(e){return this.arg==e},toString:function(){return 0==player.BLINDCOUNT?this.desc:"monster"},getChar:function(){let t=this.arg;if(ULARN&&this.arg==MIMIC&&this.mimicarg&&(t=this.mimicarg),amiga_mode){let e="";return t==INVISIBLESTALKER&&0<player.SEEINVISIBLE||ULARN&&this.isDemon()&&isCarrying(OLARNEYE)?e="v":!ULARN||t!=LEMMING&&t!=BITBUG&&t!=LAMANOBE||(e="u"),"".concat(DIV_START).concat("m").concat(t).concat(e).concat(DIV_END)}return t==INVISIBLESTALKER?(0<player.SEEINVISIBLE?monsterlist[INVISIBLESTALKER]:OEMPTY).char:ULARN&&this.isDemon()&&isCarrying(OLARNEYE)?"<font color='crimson'>".concat(demonchar[this.arg-DEMONLORD],"</font>"):show_color&&monsterlist[t].color?"<font color='".concat(monsterlist[t].color,"'>").concat(monsterlist[t].char,"</font>"):monsterlist[t].char},isDemon:function(){return this.arg>=DEMONLORD},initInventory:function(){this.inventory||(this.inventory=[]),this.addInventory(),this.addGold()},addInventory:function(){switch(this.arg){case ORC:case NYMPH:case ELF:case TROGLODYTE:case TROLL:case ROTHE:case VIOLETFUNGI:case PLATINUMDRAGON:case GNOMEKING:case REDDRAGON:return this.pickup(createRandomItem(level)),void(rnd(101)<8&&this.addInventory());case LEPRECHAUN:return 75<=rnd(101)&&this.pickup(createGem()),void(1==rnd(5)&&this.addInventory())}},addGold:function(){var e;this.gold<=0||(e=rnd(this.gold)+this.gold,this.pickup(createGold(e)))},pickup:function(e){e&&(this.inventory||this.initInventory(),this.inventory.push(e))},dropInventory:function(e,t){for(this.inventory||this.initInventory();0<this.inventory.length;)dropItem(e,t,this.inventory.pop())},isCarrying:function(t){if(!t)return!1;for(let e=0;e<this.inventory.length;e++){var a=this.inventory[e];if(t.matches(a))return!0}return!1},canBehead(){if(this.isDemon())return!1;switch(this.arg){case EYE:case CUBE:case METAMORPH:case VORTEX:case VIOLETFUNGI:case XORN:case POLTERGEIST:case SHAMBLINGMOUND:case YELLOWMOLD:case MIMIC:case WATERLORD:case SPIRITNAGA:case GREENURCHIN:return!1;default:return!0}},canFly(){if(ULARN&&this.arg==LEMMING)return!1;switch(this.arg){case BAT:case EYE:case SPIRITNAGA:case PLATINUMDRAGON:case WRAITH:case VAMPIRE:case SILVERDRAGON:case POLTERGEIST:case DEMONLORD:case DEMONLORD+1:case DEMONLORD+2:case DEMONLORD+3:case DEMONLORD+4:case DEMONLORD+5:case DEMONLORD+6:case DEMONPRINCE:case LUCIFER:return!0;default:return!1}},isSlow(){switch(this.arg){case TROGLODYTE:case HOBGOBLIN:case METAMORPH:case XVART:case INVISIBLESTALKER:case ICELIZARD:return!0}return!1},isVisible(){return this.isDemon()?ULARN&&isCarrying(OLARNEYE):!this.matches(INVISIBLESTALKER)||0<player.SEEINVISIBLE}};const nobjtab=[0,OSCROLL,OSCROLL,OSCROLL,OSCROLL,OPOTION,OPOTION,OPOTION,OPOTION,OGOLDPILE,OGOLDPILE,OGOLDPILE,OGOLDPILE,OBOOK,OBOOK,OBOOK,OBOOK,ODAGGER,ODAGGER,ODAGGER,OLEATHER,OLEATHER,OLEATHER,OREGENRING,OPROTRING,OENERGYRING,ODEXRING,OSTRRING,OSPEAR,OBELT,ORING,OSTUDLEATHER,OSHIELD,OCOOKIE,OFLAIL,OCHAIN,OBATTLEAXE,OSPLINT,O2SWORD,OCLEVERRING,OPLATE,OLONGSWORD],nlpts=[0,0,0,0,0,1,1,2,2,3,3,4,5,6,7],nch=[0,0,0,1,1,1,2,2,3,4],nplt=[0,0,0,0,1,1,2,2,3,4],ndgg=[0,0,0,1,1,1,1,2,2,3,3,4,5],nsw=[0,0,0,0,0,0,1,1,1,1,1,2,3];function newscroll(){return SCROLL_PROBABILITY[rund(81)]}function newpotion(){return POTION_PROBABILITY[rund(41)]}function newleather(){return nlpts[rund(getDifficulty()?13:15)]}function newchain(){return nch[rund(10)]}function newplate(){return nplt[rund(getDifficulty()?4:12)]}function newdagger(){return ndgg[rund(13)]}function newsword(){return nsw[rund(getDifficulty()?6:13)]}function monsterAt(e,t){return null==e||null==t||e<0||e>=MAXX||t<0||t>=MAXY?null:player.level.monsters[e][t]}function getMonster(e){return monsterAt(player.x+diroffx[e],player.y+diroffy[e])}function createmonster(a,r,o){if(a<1||a>monsterlist.length-1)debug("createmonst invalid ".concat(a));else{for(;isGenocided(a)&&a<monsterlist.length-1;)a++;let e=r=r||player.x,t=o=o||player.y;for(var n=r==player.x&&o==player.y,i=null!=r&&null!=o&&!n&&cgood(r,o,!1,!0),l=i?0:-8,s=rnd(8);l<0;l++,s++)8<s&&(s=1),e=r+diroffx[s],t=o+diroffy[s],cgood(e,t,!1,!0)&&(i=!0,l=0);if(i){var c=createMonster(a);if(c)switch(player.level.monsters[e][t]=c,player.level.know[e][t]&=~KNOWHERE,c.awake=!1,a){case ROTHE:case POLTERGEIST:case VAMPIRE:c.awake=!0}}else debug("failed to createmonst ".concat(a,", ").concat(e,",").concat(t))}}function cgood(e,t,a,r){var o=itemAt(e,t);if(t<0||t>MAXY-1||e<0||e>MAXX-1||!o||o.matches(OWALL)||o.matches(OCLOSEDDOOR)||o.matches(OHOMEENTRANCE))return!1;if(a&&!o.matches(OEMPTY))return!1;if(r){if(monsterAt(e,t))return!1;switch(o.id){case OPIT.id:case OANNIHILATION.id:case OTELEPORTER.id:case OTRAPARROW.id:case ODARTRAP.id:case OTRAPDOOR.id:case OELEVATORUP.id:case OELEVATORDOWN.id:return!1}}return!0}function createitem(e,t,a){for(var r,o,n=!0,i=rnd(8),l=-8;l<0;l++,i++){if(8<i&&(i=1),o=a?(r=player.x+diroffx[i],player.y+diroffy[i]):(r=lasthx+(n?0:diroffx[i]),lasthy+(n?0:diroffy[i])),cgood(r,o,!0,!1))return void setItem(r,o,createObject(e,t));n=!1}}function dropItemNearPlayer(e){dropItem(player.x,player.y,e,!0)}function dropItem(a,r,o,e){var n,i;if(!e&&cgood(a,r,!0,!1))setItem(a,r,o);else for(let e=rnd(8),t=-8;t<0;t++,e++)if(8<e&&(e=1),cgood(n=a+diroffx[e],i=r+diroffy[e],!0,!1))return void setItem(n,i,o)}function hitplayer(e,t){var a=player.level.monsters[e][t];if(a){lastnum=a;var r=1;if((a.matches(POLTERGEIST)||a.matches(SPIRITNAGA))&&(player.SPIRITPRO||isCarrying(OSPIRITSCARAB))){if(!ULARN)return;r=.5}if((a.matches(VAMPIRE)||a.matches(WRAITH)||a.matches(ZOMBIE))&&(player.UNDEADPRO||isCarrying(OCUBEofUNDEAD))){if(!ULARN)return;r=.5}0==(player.level.know[e][t]&KNOWHERE)&&show1cell(e,t);var o,n=getDifficulty()+1;if(hitflag=1,cursors(),ifblind(e,t),!ULARN||!a.matches(LEMMING))if((!ULARN||!a.isDemon())&&0<player.INVISIBILITY&&rnd(33)<20)updateLog("The ".concat(a," misses wildly").concat(period));else if((!ULARN||!a.isDemon()&&!a.matches(PLATINUMDRAGON))&&0<player.CHARMCOUNT&&rnd(30)+5*a.level-player.CHARISMA<30)updateLog("The ".concat(a," is awestruck at your magnificence!"));else{a.matches(BAT)?o=1:(o=a.damage,o+=rnd(o<1?1:o)+a.level),a.isDemon()&&player.WIELD&&player.WIELD.matches(OSLAYER)&&(o=1-.1*rnd(5)*o),o*=r;var i=!1,r=player.LIFEPROT;if(0<a.attack&&(o+n+8>player.AC||1==rnd(0<player.AC?player.AC:1))){if(spattack(a,a.attack,e,t))return;i=!0,n-=2}player.HP<=0||r!=player.LIFEPROT?debug("already killed"):((o+n>player.AC||1==rnd(0<player.AC?player.AC:1))&&(updateLog("  The ".concat(a," hit you").concat(period)),i=!0,0<(o=(o-=player.AC)<0?0:o)&&player.losehp(o)),i||updateLog("  The ".concat(a," missed").concat(period)))}}}function hitmonster(t,a){if(!(0<player.TIMESTOP)){var r=player.level.monsters[t][a],o=player.WIELD;if(r){var n=ifblind(t,a),i=0;let e=!1;var l=r.armorclass+player.LEVEL+player.DEXTERITY+player.WCLASS/4-12;rnd(20)<l||rnd(71)<5?(updateLog("You hit the ".concat(n?"monster":r).concat(period)),e=!0,(i=fullhit(1))<9999&&(i=rnd(i)+1)):(updateLog("You missed the ".concat(n?"monster":r).concat(period)),e=!1),e&&(r.matches(RUSTMONSTER)||r.matches(DISENCHANTRESS)||r.matches(CUBE))&&o&&o.isWeapon()&&(-10<o.arg?o.matches(OSWORDofSLASHING)||(updateLog("  Your weapon is dulled by the ".concat(r)),beep(),o.arg--):ULARN&&o.arg<=-10&&(destroyInventory(o),updateLog("  Your weapon disintegrates!"),e=!1)),e&&(o&&o.matches(OVORPAL)&&1==rnd(20)&&r.canBehead()&&(updateLog("  The Vorpal Blade beheads the ".concat(r,"!")),i=r.hitpoints),ULARN&&r.isDemon()&&(o&&o.matches(OLANCE)&&r.hitpoints>(i=300)&&updateLog("  Your lance of death tickles the ".concat(r)),o&&o.matches(OSLAYER)&&(i=1e4)),hitm(t,a,i)),!ULARN&&r.matches(VAMPIRE)&&0<r.hitpoints&&r.hitpoints<25&&(player.level.monsters[t][a]=createMonster(BAT),player.level.know[t][a]=0),ULARN&&r.matches(METAMORPH)&&0<r.hitpoints&&r.hitpoints<25&&(player.level.monsters[t][a]=createMonster(BRONZEDRAGON+rund(9)),player.level.know[t][a]=0),ULARN&&r.matches(LEMMING)&&rnd(100)<=40&&createmonster(LEMMING)}}}function hitm(e,t,a){var r=player.level.monsters[e][t],o=a;if(0<player.HALFDAM&&(a>>=1),a<=0&&(o=a=1),lasthx=e,lasthy=t,r.awake=!0,player.updateHoldMonst(-player.HOLDMONST),isCarrying(OORBOFDRAGON))switch(r.arg){case WHITEDRAGON:case REDDRAGON:case GREENDRAGON:case BRONZEDRAGON:case PLATINUMDRAGON:case SILVERDRAGON:a*=3}r.hitpoints>monsterlist[r.arg].hitpoints&&(r.hitpoints=monsterlist[r.arg].hitpoints);var n=r.hitpoints;return r.hitpoints-=a,debug("hitm(): ".concat(r.toString()," ").concat(r.hitpoints," / ").concat(monsterlist[r.arg].hitpoints)),r.hitpoints<=0?(player.MONSTKILLED++,updateLog("  The ".concat(r," died!")),player.raiseexperience(r.experience),r.dropInventory(e,t),killMonster(e,t),n):o}const spsel=[1,2,3,5,6,8,9,11,13,14],rustarm=[[OSTUDLEATHER,-2],[ORING,-4],[OCHAIN,-5],[OSPLINT,-6],[OPLATE,-8],[OPLATEARMOR,-9]];function spattack(t,e,a,r){if(player.CANCELLATION){if(!ULARN||!t.matches(DEMONPRINCE)&&!t.matches(LUCIFER))return 0;if(95<=rnd(100))return 0}if(ULARN&&t.matches(SPIRITNAGA)&&player.SPIRITPRO)return 0;if((t.matches(VAMPIRE)||t.matches(WRAITH))&&(isCarrying(OCUBEofUNDEAD)||player.UNDEADPRO))return 0;if(ULARN&&!t.matches(LUCIFER)&&(t.isDemon()||t.matches(WRAITH)||t.matches(VAMPIRE))&&isCarrying(OPSTAFF)&&rnd(100)<75)return 0;if(player.HP<=0)return debug("already dead"),0;var o=null,n=player.AC;switch(e){case 1:var i=0,l=player.WEAR,s=player.SHIELD;if(s&&0<=s.arg&&(--s.arg,i=1),0==i&&l)for(let e=0;e<rustarm.length;e++)if(l.matches(rustarm[e][0])){l.arg>rustarm[e][1]&&(--l.arg,i=1);break}0==i?(l&&l.matches(OLEATHER)&&updateLog("The ".concat(t," hit you -- you're lucky to be wearing leather armor!")),l&&l.matches(OSSPLATE)&&updateLog("The ".concat(t," hit you -- you're fortunate to have stainless steel armor!")),l&&l.matches(OELVENCHAIN)&&updateLog("The ".concat(t," hit you -- you are very lucky to have such strong elven chain!"))):updateLog("The ".concat(t," hit you -- your armor feels weaker").concat(period));break;case 2:o=rnd(15)+8-n;case 3:return null==o&&(o=rnd(20)+25-n),player.FIRERESISTANCE?updateLog("The ".concat(t,"'s flame doesn't faze you!")):(updateLog("The ".concat(t," breathes fire at you!")),player.losehp(o)),0;case 4:3<player.STRENGTH?(updateLog("The ".concat(t," stung you! You feel weaker").concat(period)),player.setStrength(player.STRENGTH-1)):updateLog("The ".concat(t," stung you!"));break;case 5:return updateLog("The ".concat(t," blasts you with its cold breath").concat(period)),o=rnd(15)+18-n,player.losehp(o),0;case 6:return isCarrying(OLIFEPRESERVER)?0:(updateLog("The ".concat(t," drains you of your life energy!")),player.loselevel(),t.matches(DEMONPRINCE)&&player.losemspells(1),t.matches(LUCIFER)&&(player.loselevel(),player.losemspells(2)),0);case 7:return updateLog("The ".concat(t," got you with a gusher!")),o=rnd(15)+25-n,player.losehp(o),0;case 8:return isCarrying(ONOTHEFT)?0:(player.GOLD?(updateLog("The ".concat(t," hit you -- your purse feels lighter").concat(period)),32767<player.GOLD?player.setGold(player.GOLD>>1):player.setGold(player.GOLD-rnd(1+(player.GOLD>>1)))):updateLog("The ".concat(t," couldn't find any gold to steal").concat(period)),teleportMonster(a,r),beep(),1);case 9:for(var c=50;;){var d=rund(26);let e=player.inventory[d];if(e&&0<e.arg&&!e.matches(OSCROLL)&&!e.matches(OPOTION))return(e.arg-=3)<0&&(e.arg=0),updateLog("The ".concat(t," hits you with a spell of disenchantment!")),updateLog("  ".concat(getCharFromIndex(d),") ").concat(e)),beep(),recalc(),0;--c<=0&&updateLog("The ".concat(t," nearly misses").concat(period));break}break;case 10:return updateLog("The ".concat(t," hit you with its barbed tail").concat(period)),o=rnd(25)-n,player.losehp(o),0;case 11:updateLog("The ".concat(t," has confused you").concat(period)),player.CONFUSE+=10+rnd(10);break;case 12:return spattack(t,spsel[rund(10)],a,r);case 13:return updateLog("The ".concat(t," flattens you with its psionics!")),o=rnd(15)+30-n,player.losehp(o),0;case 14:if(isCarrying(ONOTHEFT))return 0;if(emptyhanded()){updateLog("The ".concat(t," couldn't find anything to steal").concat(period));break}updateLog("The ".concat(t," picks your pocket and takes: "));s=stealsomething();return s||updateLog("  nothing".concat(period)),monsterAt(a,r).pickup(s),teleportMonster(a,r),beep(),recalc(),1;case 15:o=rnd(10)+5-n;case 16:return null==o&&(o=rnd(15)+10-n),updateLog("The ".concat(t," bit you!")),player.losehp(o),0}return recalc(),0}function teleportMonster(e,t){var a=monsterAt(e,t);killMonster(e,t);let r=fillmonst(a.arg);r&&(r.inventory=a.inventory,r.hitpoints=a.hitpoints)}function killMonster(e,t){player.level.monsters[e][t]=null,lasthx==e&&lasthy==t&&(lasthy=lasthx=0),player.level.know[e][t]&=~KNOWHERE}const monstlevel=[5,11,17,22,27,33,39,42,46,50,53,56],LARN_monsterlist=[new Monster(" "," ",0,0,0,0,3,0,0,0,0),new Monster("B","bat",1,0,1,0,3,0,1,1,1),new Monster("G","gnome",1,10,1,0,8,30,2,2,2),new Monster("H","hobgoblin",1,14,2,0,5,25,3,2,3),new Monster("J","jackal",1,17,1,0,4,0,1,1,4),new Monster("K","kobold",1,20,1,0,7,10,1,1,5),new Monster("O","orc",2,12,1,0,9,40,4,2,6),new Monster("S","snake",2,15,1,0,3,0,3,1,7),new Monster("c","giant centipede",2,14,0,4,3,0,1,2,8),new Monster("j","jaculi",2,20,1,0,3,0,2,1,9),new Monster("t","troglodyte",2,10,2,0,5,80,4,3,10),new Monster("A","giant ant",2,8,1,4,4,0,5,5,11),new Monster("E","floating eye",3,8,1,0,3,0,5,2,12),new Monster("L","leprechaun",3,3,0,8,3,1500,13,45,13),new Monster("N","nymph",3,3,0,14,9,0,18,45,14),new Monster("Q","quasit",3,5,3,0,3,0,10,15,15),new Monster("R","rust monster",3,4,0,1,3,0,18,25,16),new Monster("Z","zombie",3,12,2,0,3,0,6,7,17),new Monster("a","assassin bug",4,9,3,0,3,0,20,15,18),new Monster("b","bugbear",4,5,4,15,5,40,20,35,19),new Monster("h","hell hound",4,5,2,2,6,0,16,35,20),new Monster("i","ice lizard",4,11,2,10,6,50,16,25,21),new Monster("C","centaur",4,6,4,0,10,40,24,45,22),new Monster("T","troll",5,4,5,0,9,80,50,300,23),new Monster("Y","yeti",5,6,4,0,5,50,35,100,24),new Monster("d","white dragon",5,2,4,5,16,500,55,1e3,25),new Monster("e","elf",5,8,1,0,15,50,22,35,26),new Monster("g","gelatinous cube",5,9,1,0,3,0,22,45,27),new Monster("m","metamorph",6,7,3,0,3,0,30,40,28),new Monster("v","vortex",6,4,3,0,3,0,30,55,29),new Monster("z","ziller",6,15,3,0,3,0,30,35,30),new Monster("F","violet fungi",6,12,3,0,3,0,38,100,31),new Monster("W","wraith",6,3,1,6,3,0,30,325,32),new Monster("f","forvalaka",6,2,5,0,7,0,50,280,33),new Monster("l","lawless",7,7,3,0,6,0,35,80,34),new Monster("o","osequip",7,4,3,16,4,0,35,100,35),new Monster("r","rothe",7,15,5,0,3,100,50,250,36),new Monster("X","xorn",7,0,6,0,13,0,60,300,37),new Monster("V","vampire",7,3,4,6,17,0,50,1e3,38),new Monster("I","invisible stalker",7,3,6,0,5,0,50,350,39),new Monster("p","poltergeist",8,1,4,0,3,0,50,450,40),new Monster("q","disenchantress",8,3,0,9,3,0,50,500,41),new Monster("s","shambling mound",8,2,5,0,6,0,45,400,42),new Monster("y","yellow mold",8,12,4,0,3,0,35,250,43),new Monster("U","umber hulk",8,3,7,11,14,0,65,600,44),new Monster("k","gnome king",9,-1,10,0,18,2e3,100,3e3,45),new Monster("M","mimic",9,5,6,0,8,0,55,99,46),new Monster("w","water lord",9,-10,15,7,20,0,150,15e3,47),new Monster("D","bronze dragon",9,2,9,3,16,300,80,4e3,48),new Monster("D","green dragon",9,3,8,10,15,200,70,2500,49),new Monster("P","purple worm",9,-1,11,0,3,100,120,15e3,50),new Monster("x","xvart",9,-2,12,0,13,0,90,1e3,51),new Monster("n","spirit naga",10,-20,12,12,23,0,95,2e4,52),new Monster("D","silver dragon",10,-1,12,3,20,700,100,1e4,53),new Monster("D","platinum dragon",10,-5,15,13,22,1e3,130,24e3,54),new Monster("u","green urchin",10,-3,12,0,3,0,85,5e3,55),new Monster("D","red dragon",10,-2,13,3,19,800,110,14e3,56),new Monster(OEMPTY.char,"type I demon lord",12,-30,18,0,20,0,140,5e4,57),new Monster(OEMPTY.char,"type II demon lord",13,-30,18,0,21,0,160,75e3,58),new Monster(OEMPTY.char,"type III demon lord",14,-30,18,0,22,0,180,1e5,59),new Monster(OEMPTY.char,"type IV demon lord",15,-35,20,0,23,0,200,125e3,60),new Monster(OEMPTY.char,"type V demon lord",16,-40,22,0,24,0,220,15e4,61),new Monster(OEMPTY.char,"type VI demon lord",17,-45,24,0,25,0,240,175e3,62),new Monster(OEMPTY.char,"type VII demon lord",18,-70,27,6,26,0,260,2e5,63),new Monster(OEMPTY.char,"demon prince",25,-127,30,6,28,0,345,3e5,64)],ULARN_monsterlist=[new Monster(" "," ",0,0,0,0,3,0,0,0,0),new Monster("l","lemming",1,0,0,0,3,0,0,1,1),new Monster("G","gnome",1,10,1,0,8,30,2,2,2),new Monster("H","hobgoblin",1,13,2,0,5,25,3,2,3),new Monster("J","jackal",1,7,1,0,4,0,1,1,4),new Monster("K","kobold",1,15,1,0,7,10,1,1,5),new Monster("O","orc",2,15,3,0,9,40,5,2,6),new Monster("S","snake",2,10,1,0,3,0,3,1,7),new Monster("c","giant centipede",2,13,1,4,3,0,2,2,8),new Monster("j","jaculi",2,9,1,0,3,0,2,1,9),new Monster("t","troglodyte",2,10,2,0,5,80,5,3,10),new Monster("A","giant ant",2,8,1,4,4,0,5,4,11),new Monster("E","floating eye",3,8,2,0,3,0,7,2,12),new Monster("L","leprechaun",3,3,0,8,3,1500,15,40,13),new Monster("N","nymph",3,3,0,14,9,0,20,40,14),new Monster("Q","quasit",3,5,3,0,3,0,14,10,15),new Monster("R","rust monster",3,5,0,1,3,0,18,20,16),new Monster("Z","zombie",3,12,3,0,3,0,9,7,17),new Monster("a","assassin bug",4,4,3,0,3,0,23,13,18),new Monster("b","bitbug",4,5,4,15,5,40,24,33,19),new Monster("h","hell hound",4,5,2,2,6,0,20,33,20),new Monster("i","ice lizard",4,11,3,10,6,50,19,23,21),new Monster("C","centaur",4,6,4,0,10,40,25,43,22),new Monster("T","troll",5,9,5,0,9,80,55,250,23),new Monster("Y","yeti",5,8,4,0,5,50,45,90,24),new Monster("d","white dragon",5,4,5,5,16,500,65,1e3,25),new Monster("e","elf",5,3,3,0,15,50,25,33,26),new Monster("g","gelatinous cube",5,9,3,0,3,0,24,43,27),new Monster("m","metamorph",6,9,3,0,3,0,32,40,28),new Monster("v","vortex",6,5,4,0,3,0,33,53,29),new Monster("z","ziller",6,15,3,0,3,0,34,33,30),new Monster("F","violet fungus",6,12,3,0,3,0,39,90,31),new Monster("W","wraith",6,3,1,6,3,0,36,300,32),new Monster("f","forvalaka",6,3,5,0,7,0,55,270,33),new Monster("l","lama nobe",7,14,7,0,6,0,36,70,34),new Monster("o","osequip",7,4,7,16,4,0,36,90,35),new Monster("r","rothe",7,15,5,0,3,100,53,230,36),new Monster("X","xorn",7,6,7,0,13,0,63,290,37),new Monster("V","vampire",7,5,4,6,17,0,55,950,38),new Monster("I","invisible stalker",7,5,6,0,5,0,55,330,39),new Monster("p","poltergeist",8,1,8,0,3,0,55,430,40),new Monster("q","disenchantress",8,3,1,9,3,0,57,500,41),new Monster("s","shambling mound",8,13,5,0,6,0,47,390,42),new Monster("y","yellow mold",8,12,4,0,3,0,37,240,43),new Monster("U","umber hulk",8,6,7,11,14,0,67,600,44),new Monster("k","gnome king",9,-1,10,0,18,2e3,120,3e3,45),new Monster("M","mimic",9,9,7,0,8,0,57,100,46),new Monster("w","water lord",9,-10,15,7,20,0,155,15e3,47),new Monster("D","bronze dragon",9,5,9,3,16,300,90,4e3,48),new Monster("D","green dragon",9,4,4,10,15,200,80,2500,49),new Monster("P","purple worm",9,-1,13,0,3,100,130,15e3,50),new Monster("x","xvart",9,-2,14,0,13,0,100,1e3,51),new Monster("n","spirit naga",10,-20,15,12,23,0,100,2e4,52),new Monster("D","silver dragon",10,-4,10,3,20,700,110,1e4,53),new Monster("D","platinum dragon",10,-7,15,13,22,1e3,150,25e3,54),new Monster("u","green urchin",10,-5,12,0,3,0,95,5e3,55),new Monster("D","red dragon",10,-4,13,3,19,800,120,14e3,56),new Monster(OEMPTY.char,"type I demon lord",12,-40,20,3,20,0,150,5e4,57),new Monster(OEMPTY.char,"type II demon lord",13,-45,25,5,22,0,200,75e3,58),new Monster(OEMPTY.char,"type III demon lord",14,-50,30,9,24,0,250,1e5,59),new Monster(OEMPTY.char,"type IV demon lord",15,-55,35,11,26,0,300,125e3,60),new Monster(OEMPTY.char,"type V demon lord",16,-60,40,13,28,0,350,15e4,61),new Monster(OEMPTY.char,"type VI demon lord",17,-65,45,13,30,0,400,175e3,62),new Monster(OEMPTY.char,"type VII demon lord",18,-70,50,6,32,0,450,2e5,63),new Monster(OEMPTY.char,"demon prince",19,-100,80,6,40,0,1e3,5e5,64),new Monster(OEMPTY.char,"God of Hellfire",20,-127,127,6,100,0,32767,1e6,65)],demonchar=["1","2","3","4","5","6","7","9","0"],BAT=1,LEMMING=1,GNOME=2,HOBGOBLIN=3,JACKAL=4,KOBOLD=5,ORC=6,SNAKE=7,CENTIPEDE=8,JACULI=9,TROGLODYTE=10,ANT=11,EYE=12,LEPRECHAUN=13,NYMPH=14,QUASIT=15,RUSTMONSTER=16,ZOMBIE=17,ASSASSINBUG=18,BUGBEAR=19,BITBUG=19,HELLHOUND=20,ICELIZARD=21,CENTAUR=22,TROLL=23,YETI=24,WHITEDRAGON=25,ELF=26,CUBE=27,METAMORPH=28,VORTEX=29,ZILLER=30,VIOLETFUNGI=31,WRAITH=32,FORVALAKA=33,LAWLESS=34,LAMANOBE=34,OSEQUIP=35,ROTHE=36,XORN=37,VAMPIRE=38,INVISIBLESTALKER=39,POLTERGEIST=40,DISENCHANTRESS=41,SHAMBLINGMOUND=42,YELLOWMOLD=43,UMBERHULK=44,GNOMEKING=45,MIMIC=46,WATERLORD=47,BRONZEDRAGON=48,GREENDRAGON=49,PURPLEWORM=50,XVART=51,SPIRITNAGA=52,SILVERDRAGON=53,PLATINUMDRAGON=54,GREENURCHIN=55,REDDRAGON=56,DEMONLORD=57,DEMONPRINCE=64,LUCIFER=65;var Player=function(){this.inventory=[];for(var e=0;e<MAXINVEN;e++)this.inventory[e]=null;this.gender="Male",this.char_picked="Adventurer",this.ramboflag=!1,this.knownPotions=[],this.knownScrolls=[],this.knownSpells=[],this.x=0,this.y=0,this.level=null,this.char="▓",this.WEAR=null,this.WIELD=null,this.SHIELD=null,this.SPELLS=1,this.SPELLMAX=1,this.AC=0,this.WCLASS=0,this.LEVEL=1,this.EXPERIENCE=0,this.HP=10,this.HPMAX=10,this.STRENGTH=12,this.START_STRENGTH=this.STRENGTH,this.INTELLIGENCE=12,this.WISDOM=12,this.CONSTITUTION=12,this.DEXTERITY=12,this.CHARISMA=12,this.GOLD=0,this.BANKACCOUNT=0,this.ENERGY=0,this.ECOUNTER=96,this.REGEN=1,this.REGENCOUNTER=16,this.MOREDEFENSES=0,this.STREXTRA=0,this.GIANTSTR=0,this.HERO=0,this.COKED=0,this.AWARENESS=0,this.SEEINVISIBLE=0,this.SPIRITPRO=0,this.UNDEADPRO=0,this.FIRERESISTANCE=0,this.STEALTH=0,this.LIFEPROT=0,this.MOREDAM=0,this.PROTECTIONTIME=0,this.DEXCOUNT=0,this.CHARMCOUNT=0,this.STRCOUNT=0,this.INVISIBILITY=0,this.CANCELLATION=0,this.HASTESELF=0,this.GLOBE=0,this.SCAREMONST=0,this.HOLDMONST=0,this.TIMESTOP=0,this.WTW=0,this.ALTPRO=0,this.AGGRAVATE=0,this.HASTEMONST=0,this.HALFDAM=0,this.CONFUSE=0,this.BLINDCOUNT=0,this.ITCHING=0,this.CLUMSINESS=0,this.LAUGHING=0,this.DRAINSTRENGTH=0,this.INFEEBLEMENT=0,this.TELEFLAG=0,this.LAMP=!1,this.WAND=!1,this.SLAYING=!1,this.NEGATESPIRIT=!1,this.CUBEofUNDEAD=!1,this.NOTHEFT=!1,this.TALISMAN=!1,this.HAND=!1,this.ORB=!1,this.ELVEN=!1,this.SLASH=!1,this.BESSMANNINTEL=0,this.BESSMANN=!1,this.SLAY=!1,this.VORPAL=!1,this.STAFF=!1,this.PRESERVER=!1,this.PAD=!1,this.ELEVDOWN=!1,this.ELEVUP=!1,this.MOVESMADE=0,this.MONSTKILLED=0,this.SPELLSCAST=0,this.hasPickedUpPotion=!1,this.getChar=function(){return amiga_mode?"".concat(DIV_START,"player").concat(DIV_END):retro_mode?"<b><font color='white'>@</font></b>":"▓"},this.losehp=function(e){(e=Math.round(e))<=0||(changedHP=millis(),debug("losehp: ".concat(lastmonst,":").concat(e)),this.HP-=e,this.HP<=0&&(beep(),died(lastnum,!0)))},this.losemhp=function(e){e<=0||(changedHP=millis(),changedHPMax=millis(),this.HP=Math.max(1,this.HP-e),this.HPMAX=Math.max(1,this.HPMAX-e))},this.raisehp=function(e){e<=0||(changedHP=millis(),this.HP=Math.min(this.HP+e,this.HPMAX))},this.raisemhp=function(e){e<=0||(changedHP=millis(),changedHPMax=millis(),this.HP+=e,this.HPMAX+=e)},this.raisemspells=function(e){e<=0||(changedSpells=millis(),changedSpellsMax=millis(),this.SPELLMAX+=e,player.SPELLS+=e)},this.losemspells=function(e){e<=0||(changedSpells=millis(),changedSpellsMax=millis(),player.SPELLMAX=Math.max(1,player.SPELLMAX-e),player.SPELLS=Math.max(1,player.SPELLS-e))},this.raiselevel=function(){player.LEVEL<MAXPLEVEL&&(changedLevel=millis(),player.raiseexperience(SKILL[player.LEVEL]-player.EXPERIENCE))},this.loselevel=function(){1<player.LEVEL&&(changedLevel=millis(),player.loseexperience(player.EXPERIENCE-SKILL[player.LEVEL-1]+1))},this.raiseexperience=function(e){changedExp=millis();var t=player.LEVEL;for(player.EXPERIENCE+=e;player.EXPERIENCE>=SKILL[player.LEVEL]&&player.LEVEL<MAXPLEVEL;){var a=player.CONSTITUTION-getDifficulty()>>1;player.LEVEL++,player.raisemhp(rnd(3)+rnd(0<a?a:1)),player.raisemspells(rund(3)),player.LEVEL<7-getDifficulty()&&player.raisemhp(player.CONSTITUTION>>2)}if(player.LEVEL!=t)switch(beep(),changedLevel=millis(),updateLog("Welcome to level ".concat(player.LEVEL).concat(period)),player.LEVEL){case 94:player.WTW=99999;break;case 95:player.INVISIBILITY=99999;break;case 96:player.FIRERESISTANCE=99999;break;case 97:player.CANCELLATION=99999;break;case 98:player.HASTESELF=99999;break;case 99:player.STEALTH=99999,player.SPIRITPRO=99999;break;case 100:updateLog("You are now The Creator!"),learnAll(),revealLevel()}},this.loseexperience=function(e){changedExp=millis();var t=player.LEVEL;for(player.EXPERIENCE=Math.max(0,player.EXPERIENCE-e);player.EXPERIENCE<SKILL[player.LEVEL-1];){--player.LEVEL<=1&&(player.LEVEL=1);var a=player.CONSTITUTION-getDifficulty()>>1;player.losemhp(rnd(0<a?a:1)),player.LEVEL<7-getDifficulty()&&player.losemhp(player.CONSTITUTION>>2),player.losemspells(rund(3))}t!=player.LEVEL&&(cursors(),beep(),changedLevel=millis(),updateLog("  You went down to level ".concat(player.LEVEL,"!")))},this.adjustcvalues=function(e,t){var a,r=player.DEXTERITY,o=player.STREXTRA,n=player.INTELLIGENCE;e.matches(ODEXRING)&&player.setDexterity(player.DEXTERITY+(t?e.arg+1:-1*(e.arg+1))),e.matches(OSTRRING)&&player.setStrExtra(player.STREXTRA+(t?e.arg+1:-1*(e.arg+1))),e.matches(OCLEVERRING)&&player.setIntelligence(player.INTELLIGENCE+(t?e.arg+1:-1*(e.arg+1))),e.matches(OHAMMER)&&(player.setDexterity(player.DEXTERITY+(t?10:-10)),player.setStrExtra(player.STREXTRA+(t?10:-10)),a=player.INTELLIGENCE,t?(player.setIntelligence(player.INTELLIGENCE-10),player.BESSMANNINTEL=a-player.INTELLIGENCE):player.setIntelligence(player.INTELLIGENCE+player.BESSMANNINTEL)),e.matches(OSWORDofSLASHING)&&player.setDexterity(player.DEXTERITY+(t?5:-5)),e.matches(OSLAYER)&&player.setIntelligence(player.INTELLIGENCE+(t?10:-10)),e.matches(OPSTAFF)&&player.setWisdom(player.WISDOM+(t?10:-10)),e.matches(OORB)&&t&&player.AWARENESS++,r!=player.DEXTERITY&&(changedDEX=millis()),o!=player.STREXTRA&&(changedSTR=millis()),n!=player.INTELLIGENCE&&(changedINT=millis()),ULARN&&e.matches(OLARNEYE)&&0==player.BLINDCOUNT&&(updateLog("Your sight fades for a moment..."),updateLog(t?"Your sight returns, and everything looks crystal-clear!":"Your sight returns but everything looks dull and faded".concat(period)))},this.setStrExtra=function(e){changedSTR=millis(),this.STREXTRA=e},this.setMoreDefenses=function(e){changedAC=millis(),this.MOREDEFENSES=e},this.setHP=function(e){changedHP=millis(),this.HP=e},this.setSpells=function(e){changedSpells=millis(),this.SPELLS=e},this.setStrength=function(e){changedSTR=millis(),this.STRENGTH=Math.max(3,e)},this.setIntelligence=function(e){changedINT=millis(),this.INTELLIGENCE=Math.max(3,e)},this.setWisdom=function(e){changedWIS=millis(),this.WISDOM=Math.max(3,e)},this.setConstitution=function(e){changedCON=millis(),this.CONSTITUTION=Math.max(3,e)},this.setDexterity=function(e){changedDEX=millis(),this.DEXTERITY=Math.max(3,e)},this.setCharisma=function(e){changedCHA=millis(),this.CHARISMA=Math.max(3,e)},this.setGold=function(e){changedGold=millis(),this.GOLD=Math.max(0,e)},this.updateStealth=function(e){var t=this.STEALTH;return this.STEALTH=Math.max(0,this.STEALTH+e),changedStealth=getUpdateTime(t,e,this.STEALTH,changedStealth),this.STEALTH},this.updateUndeadPro=function(e){var t=this.UNDEADPRO;return this.UNDEADPRO=Math.max(0,this.UNDEADPRO+e),changedUndeadPro=getUpdateTime(t,e,this.UNDEADPRO,changedUndeadPro),this.UNDEADPRO},this.updateSpiritPro=function(e){var t=this.SPIRITPRO;return this.SPIRITPRO=Math.max(0,this.SPIRITPRO+e),changedSpiritPro=getUpdateTime(t,e,this.SPIRITPRO,changedSpiritPro),this.SPIRITPRO},this.updateCharmCount=function(e){var t=this.CHARMCOUNT;return this.CHARMCOUNT=Math.max(0,this.CHARMCOUNT+e),changedCharmCount=getUpdateTime(t,e,this.CHARMCOUNT,changedCharmCount),this.CHARMCOUNT},this.updateTimeStop=function(e){var t=this.TIMESTOP;return this.TIMESTOP=Math.max(0,this.TIMESTOP+e),changedTimeStop=getUpdateTime(t,e,this.TIMESTOP,changedTimeStop),0<e&&(lasthy=lasthx=0),this.TIMESTOP},this.updateHoldMonst=function(e){var t=this.HOLDMONST;return this.HOLDMONST=Math.max(0,this.HOLDMONST+e),changedHoldMonst=getUpdateTime(t,e,this.HOLDMONST,changedHoldMonst),0<e&&(lasthy=lasthx=0),this.HOLDMONST},this.updateGiantStr=function(e){var t=this.GIANTSTR;return this.GIANTSTR=Math.max(0,this.GIANTSTR+e),changedGiantStr=getUpdateTime(t,e,this.GIANTSTR,changedGiantStr),t<=0&&0<this.GIANTSTR&&this.setStrExtra(this.STREXTRA+21),0<t&&this.GIANTSTR<=0&&this.setStrExtra(this.STREXTRA-20),this.GIANTSTR},this.updateFireResistance=function(e){var t=this.FIRERESISTANCE;return this.FIRERESISTANCE=Math.max(0,this.FIRERESISTANCE+e),changedFireResistance=getUpdateTime(t,e,this.FIRERESISTANCE,changedFireResistance),this.FIRERESISTANCE},this.updateDexCount=function(e){var t=this.DEXCOUNT;return this.DEXCOUNT=Math.max(0,this.DEXCOUNT+e),changedDexCount=getUpdateTime(t,e,this.DEXCOUNT,changedDexCount),t<=0&&0<this.DEXCOUNT&&this.setDexterity(this.DEXTERITY+3),0<t&&this.DEXCOUNT<=0&&this.setDexterity(this.DEXTERITY-3),this.DEXCOUNT},this.updateStrCount=function(e){var t=this.STRCOUNT;return this.STRCOUNT=Math.max(0,this.STRCOUNT+e),changedStrCount=getUpdateTime(t,e,this.STRCOUNT,changedStrCount),t<=0&&0<this.STRCOUNT&&this.setStrExtra(this.STREXTRA+3),0<t&&this.STRCOUNT<=0&&this.setStrExtra(this.STREXTRA-3),this.STRCOUNT},this.updateScareMonst=function(e){var t=this.SCAREMONST;return this.SCAREMONST=Math.max(0,this.SCAREMONST+e),changedScareMonst=getUpdateTime(t,e,this.SCAREMONST,changedScareMonst),this.SCAREMONST},this.updateHasteSelf=function(e){var t=this.HASTESELF;return this.HASTESELF=Math.max(0,this.HASTESELF+e),changedHasteSelf=getUpdateTime(t,e,this.HASTESELF,changedHasteSelf),this.HASTESELF},this.updateCancellation=function(e){var t=this.CANCELLATION;return this.CANCELLATION=Math.max(0,this.CANCELLATION+e),changedCancellation=getUpdateTime(t,e,this.CANCELLATION,changedCancellation),this.CANCELLATION},this.updateInvisibility=function(e){var t=this.INVISIBILITY;return this.INVISIBILITY=Math.max(0,this.INVISIBILITY+e),changedInvisibility=getUpdateTime(t,e,this.INVISIBILITY,changedInvisibility),this.INVISIBILITY},this.updateAltPro=function(e){var t=this.ALTPRO;this.ALTPRO=Math.max(0,this.ALTPRO+e),changedAltPro=getUpdateTime(t,e,this.ALTPRO,changedAltPro);e=ULARN?5:3;return t<=0&&0<this.ALTPRO&&this.setMoreDefenses(this.MOREDEFENSES+e),0<t&&this.ALTPRO<=0&&this.setMoreDefenses(this.MOREDEFENSES-e),this.ALTPRO},this.updateProtectionTime=function(e){var t=this.PROTECTIONTIME;return this.PROTECTIONTIME=Math.max(0,this.PROTECTIONTIME+e),changedProtectionTime=getUpdateTime(t,e,this.PROTECTIONTIME,changedProtectionTime),t<=0&&0<this.PROTECTIONTIME&&this.setMoreDefenses(this.MOREDEFENSES+2),0<t&&this.PROTECTIONTIME<=0&&this.setMoreDefenses(this.MOREDEFENSES-2),this.PROTECTIONTIME},this.updateWTW=function(e){var t=this.WTW;return this.WTW=Math.max(0,this.WTW+e),changedWTW=getUpdateTime(t,e,this.WTW,changedWTW),this.WTW},this.getStatString=function(e){if(level<0)return"";var t=LEVELNAMES[level];e&&(t=e),0==level&&(this.TELEFLAG=0);e="".concat(pad(this.HP,2,changedHP),"(").concat(pad(this.HPMAX,2,changedHPMax),")");return"Spells: ".concat(pad(this.SPELLS,2,changedSpells),"(").concat(pad(this.SPELLMAX,2,changedSpellsMax),")  AC: ").concat(pad(this.AC,-4,changedAC)," WC: ").concat(pad(this.WCLASS,-4,changedWC)," Level ").concat(pad(this.LEVEL,-2,changedLevel)," Exp: ").concat(pad(this.EXPERIENCE,-10,changedExp)).concat(pad(CLASSES[this.LEVEL-1],16,changedLevel),"               \nHP: ").concat(pad(e,-1)," STR=").concat(pad(this.STRENGTH+this.STREXTRA,-2,changedSTR)," INT=").concat(pad(this.INTELLIGENCE,-2,changedINT)," WIS=").concat(pad(this.WISDOM,-2,changedWIS)," CON=").concat(pad(this.CONSTITUTION,-2,changedCON)," DEX=").concat(pad(this.DEXTERITY,-2,changedDEX)," CHA=").concat(pad(this.CHARISMA,-2,changedCHA)," LV: ").concat(pad(this.TELEFLAG?"?":t,-2,changedDepth)," Gold: ").concat(pad(Number(this.GOLD).toLocaleString(),1,changedGold),"            ")},this.setCharacterClass=function(e){let t=!1;var a,r,o;return"Ogre"===(this.char_picked=e)?(learnSpell("mle"),this.SPELLMAX=1,this.SPELLS=1,this.HPMAX=16,this.HP=16,this.STRENGTH=18,this.INTELLIGENCE=4,this.WISDOM=6,this.CONSTITUTION=16,this.DEXTERITY=6,this.CHARISMA=4,take(createObject(OPOTION,rund(6))),take(createObject(OPOTION,rund(6))),t=!0):"Wizard"===e?(learnSpell("mle"),learnSpell("chm"),this.SPELLMAX=2,this.SPELLS=2,this.HPMAX=8,this.HP=8,this.STRENGTH=8,this.INTELLIGENCE=16,this.WISDOM=16,this.CONSTITUTION=6,this.DEXTERITY=6,this.CHARISMA=8,take(createObject(OSCROLL,rund(6))),take(createObject(OSCROLL,rund(6))),take(createObject(OPOTION,19)),t=!0):"Klingon"===e?(learnSpell("ssp"),this.SPELLMAX=1,this.SPELLS=1,this.HPMAX=14,this.HP=14,this.STRENGTH=14,this.INTELLIGENCE=12,this.WISDOM=4,this.CONSTITUTION=12,this.DEXTERITY=8,this.CHARISMA=3,take(a=createObject(OSTUDLEATHER)),this.WEAR=a,take(createObject(OPOTION,rund(6))),t=!0):"Elf"===e?(learnSpell("pro"),this.SPELLMAX=2,this.SPELLS=1,this.HPMAX=8,this.HP=8,this.STRENGTH=8,this.INTELLIGENCE=14,this.WISDOM=12,this.CONSTITUTION=8,this.DEXTERITY=8,this.CHARISMA=14,take(r=createObject(OLEATHER)),this.WEAR=r,take(createObject(OSCROLL,rund(6))),t=!0):"Rogue"===e?(learnSpell("mle"),this.SPELLMAX=1,this.SPELLS=1,this.HPMAX=12,this.HP=12,this.STRENGTH=8,this.INTELLIGENCE=12,this.WISDOM=8,this.CONSTITUTION=10,this.DEXTERITY=14,this.CHARISMA=6,take(r=createObject(OLEATHER)),this.WEAR=r,take(r=createObject(ODAGGER)),this.WIELD=r,take(createObject(OSCROLL,14)),t=!0):"Adventurer"===e?(learnSpell("mle"),learnSpell("pro"),this.SPELLMAX=1,this.SPELLS=1,this.HPMAX=10,this.HP=10,this.STRENGTH=12,this.INTELLIGENCE=12,this.WISDOM=12,this.CONSTITUTION=12,this.DEXTERITY=12,this.CHARISMA=12,!ULARN&&0!=getDifficulty()||(take(o=createObject(OLEATHER)),this.WEAR=o,take(o=createObject(ODAGGER)),this.WIELD=o),t=!0):"Dwarf"===e?(learnSpell("pro"),this.SPELLMAX=1,this.SPELLS=1,this.HPMAX=12,this.HP=12,this.STRENGTH=16,this.INTELLIGENCE=6,this.WISDOM=8,this.CONSTITUTION=16,this.DEXTERITY=4,this.CHARISMA=4,take(o=createObject(OSPEAR)),this.WIELD=o,t=!0):"Rambo"===e&&(this.SPELLMAX=0,this.SPELLS=0,this.HPMAX=1,this.HP=1,this.STRENGTH=3,this.INTELLIGENCE=3,this.WISDOM=3,this.CONSTITUTION=3,this.DEXTERITY=3,this.CHARISMA=3,take(e=createObject(OLANCE)),this.WIELD=e,this.ramboflag=!0,t=!0),this.START_STRENGTH=this.STRENGTH,t},this.setGender=function(e){return"Male"===(this.gender=e)||"Female"===e||"Other"===e},this.getConductString=function(e){let t=1;function a(e){return e.filter(e=>null!=e).length}"Wizard"===this.char_picked||"Adventurer"===this.char_picked?t=2:"Rambo"===this.char_picked&&(t=0);var r=0===this.MONSTKILLED,o=0===a(this.knownScrolls)&&a(this.knownSpells)===t,n=1===a(this.knownPotions),i=0===this.SPELLSCAST;let l="";e=e?" ":"\n";return r&&(l+="pacifist".concat(e)),n&&(l+="thirsty".concat(e)),o&&(l+="illiterate".concat(e)),i&&(l+="spellbound".concat(e)),""===l&&(l="none".concat(e)),l}};function getUpdateTime(e,t,a,r){return 0<t||0!=e&&a<=0?millis():r}var changedHP=0,changedHPMax=0,changedSpells=0,changedSpellsMax=0,changedAC=0,changedWC=0,changedLevel=0,changedExp=0,changedSTR=0,changedINT=0,changedWIS=0,changedCON=0,changedDEX=0,changedCHA=0,changedDepth=0,changedGold=0,changedStealth=0,changedUndeadPro=0,changedSpiritPro=0,changedCharmCount=0,changedTimeStop=0,changedHoldMonst=0,changedGiantStr=0,changedFireResistance=0,changedDexCount=0,changedStrCount=0,changedScareMonst=0,changedHasteSelf=0,changedCancellation=0,changedInvisibility=0,changedAltPro=0,changedProtectionTime=0,changedWTW=0;function ifblind(e,t){return 0<player.BLINDCOUNT?(lastnum=DIED_UNSEEN_ATTACKER,lastmonst="monster",!0):(lastnum=player.level.monsters[e][t],lastmonst=player.level.monsters[e][t].toString(),!1)}function wield(e){if((a=itemAt(player.x,player.y)).isWeapon()){if(appendLog(" wield".concat(period)),!take(a))return setMazeMode(!0),1;forget()}else{if("*"==e||" "==e||"I"==e)return mazeMode?showinventory(!0,wield,showwield,!1,!1,!0):setMazeMode(!0),nomove=1,0;if("-"==e)return player.WIELD&&(updateLog("You unwield your weapon".concat(period)),player.WIELD=null),setMazeMode(!0),1;var t=getIndexFromChar(e);if(!(a=player.inventory[t]))return 0<=t&&t<26&&updateLog("  You don't have item ".concat(e,"!")),t<=-1&&(appendLog(" cancelled".concat(period)),nomove=1),setMazeMode(!0),1;if(!a.canWield())return updateLog("  You can't wield that!"),setMazeMode(!0),1}if(player.SHIELD&&a.matches(O2SWORD))return updateLog("  But one arm is busy with your shield!"),setMazeMode(!0),1;if(!ULARN||player.SHIELD!=a&&player.WEAR!=a)return e===a&&(e=getCharFromIndex(player.inventory.indexOf(a))),updateLog("  You wield:"),updateLog("".concat(e,") ").concat(a.toString(!0))),player.WIELD=a,setMazeMode(!0),1;var a=a.matches(OSHIELD)?"shield":"armor";return updateLog("  You can't wield your ".concat(a," while you're wearing it!")),1}function wear(e){if((t=itemAt(player.x,player.y)).isArmor()){if(appendLog(" wear".concat(period)),!take(t))return setMazeMode(!0),1;forget()}else{if("*"==e||" "==e||"I"==e)return mazeMode?showinventory(!0,wear,showwear,!1,!1,!0):setMazeMode(!0),nomove=1,0;if("-"==e)return player.SHIELD?(player.SHIELD=null,updateLog("Your shield is off".concat(period))):player.WEAR?(player.WEAR=null,updateLog("Your armor is off".concat(period))):updateLog("You aren't wearing anything".concat(period)),setMazeMode(!0),1;var t,a=getIndexFromChar(e);if(!(t=player.inventory[a]))return 0<=a&&a<26&&updateLog("  You don't have item ".concat(e,"!")),a<=-1&&(appendLog(" cancelled".concat(period)),nomove=1),setMazeMode(!0),1}if(!t.isArmor())return updateLog("  You can't wear that!"),setMazeMode(!0),1;if(ULARN&&player.WIELD==t){a=t.matches(OSHIELD)?"shield":"armor";return updateLog("  You can't wear your ".concat(a," while you're wielding it!")),1}if(t.matches(OSHIELD)){if(player.WIELD&&player.WIELD.matches(O2SWORD))return updateLog("  Your hands are busy with the two handed sword!"),setMazeMode(!0),1;player.SHIELD=t}else player.WEAR=t;return e===t&&(e=getCharFromIndex(player.inventory.indexOf(t))),updateLog("  You wear:"),updateLog("".concat(e,") ").concat(t.toString(!0))),setMazeMode(!0),1}function game_stats(a,r){a=a||player;var o=r?"Inventory:\n":"";r&&(o+=".) "+Number(a.GOLD).toLocaleString()+" gold pieces\n");for(var n=showinventory(!1,null,showall,!1,!1,!1,a),i=0;i<n.length;i++){var l=n[i][1];if(l){let e=n[i][0]+") "+l.toString(!1,r||DEBUG_STATS,a),t=[e];39<e.length&&(t=e.split("(")),e=padString(t[0],-39),2<=t.length&&(e+="\n   ("+t[1]),3==t.length&&(e+="("+t[2]),o+=e+"\n"}}var t=amiga_mode?" ":"";for(let e=0;e<maxcarry(a);e++)a.inventory[e]||(o+="".concat(getCharFromIndex(e),") -").concat(t,"-").concat(t,"-\n"));!r&&pocketempty()||(o+="\n"),o+="Known Spells:\n";for(var e=0,s=0;s<a.knownSpells.length;s++){var c=a.knownSpells[s];c&&(o+=c+" ",++e%6==0&&(o+="\n"))}return e%6!=0&&(o+="\n"),o}function debug_stats(e,t){if(e=e||player){var a=gtime,r=rmst;t&&t.extra&&(a=t.extra[EXTRA_GTIME],r=t.extra[EXTRA_RMST]);var o=game_stats(e,null!=t);o+="\nKnown Scrolls:\n";for(var n=0;n<e.knownScrolls.length;n++){var i=e.knownScrolls[n];i&&(o+=SCROLL_NAMES[i.arg]+"\n")}o+="\nKnown Potions:\n";for(var l=0;l<e.knownPotions.length;l++){var s=e.knownPotions[l];s&&(o+=POTION_NAMES[s.arg]+"\n")}return o+="\nBank Account:\n",o+=Number(e.BANKACCOUNT).toLocaleString()+" gold pieces\n",o+="\nBonuses:\n",o+="+AC:   "+e.MOREDEFENSES+"\n",o+="STREX: "+e.STREXTRA+"\n",o+="GIAST: "+e.GIANTSTR+"\n",o+="HERO:  "+e.HERO+"\n",o+="AWARE: "+e.AWARENESS+"\n",o+="SEEIN: "+e.SEEINVISIBLE+"\n",o+="SPRO:  "+e.SPIRITPRO+"\n",o+="UPRO:  "+e.UNDEADPRO+"\n",o+="FIRE:  "+e.FIRERESISTANCE+"\n",o+="STEL:  "+e.STEALTH+"\n",o+="LIFE:  "+e.LIFEPROT+"\n",o+="\nMagic:\n",o+="PRO2:  "+e.PROTECTIONTIME+"\n",o+="DEX:   "+e.DEXCOUNT+"\n",o+="CHM:   "+e.CHARMCOUNT+"\n",o+="STR:   "+e.STRCOUNT+"\n",o+="INV:   "+e.INVISIBILITY+"\n",o+="CAN:   "+e.CANCELLATION+"\n",o+="HAS:   "+e.HASTESELF+"\n",o+="GLO:   "+e.GLOBE+"\n",o+="SCA:   "+e.SCAREMONST+"\n",o+="HLD:   "+e.HOLDMONST+"\n",o+="STP:   "+e.TIMESTOP+"\n",o+="WTW:   "+e.WTW+"\n",o+="PRO3:  "+e.ALTPRO+"\n",o+="\nCurses:\n",o+="AGGR:  "+e.AGGRAVATE+"\n",o+="HSTM:  "+e.HASTEMONST+"\n",o+="POIS:  "+e.HALFDAM+"\n",o+="CONF:  "+e.CONFUSE+"\n",o+="BLIND: "+e.BLINDCOUNT+"\n",o+="ITCH:  "+e.ITCHING+"\n",o+="CLMSY: "+e.CLUMSINESS+"\n",o+="\nSpecial Items Created:\n",ULARN&&(o+="LAMP:  ".concat(booleanToNumberString(e.LAMP),"\n")),ULARN&&(o+="WAND:  ".concat(booleanToNumberString(e.WAND),"\n")),o+="DRGSL: ".concat(booleanToNumberString(e.SLAYING),"\n"),o+="NEGAT: ".concat(booleanToNumberString(e.NEGATESPIRIT),"\n"),o+="CUBE:  ".concat(booleanToNumberString(e.CUBEofUNDEAD),"\n"),o+="THEFT: ".concat(booleanToNumberString(e.NOTHEFT),"\n"),ULARN&&(o+="TALIS: ".concat(booleanToNumberString(e.TALISMAN),"\n")),ULARN&&(o+="HAND:  ".concat(booleanToNumberString(e.HAND),"\n")),ULARN&&(o+="ORB:   ".concat(booleanToNumberString(e.ORB),"\n")),ULARN&&(o+="ELVEN: ".concat(booleanToNumberString(e.ELVEN),"\n")),o+="SLASH: ".concat(booleanToNumberString(e.SLASH),"\n"),o+="BESSM: ".concat(booleanToNumberString(e.BESSMANN),"\n"),ULARN&&(o+="SLAYR: ".concat(booleanToNumberString(e.SLAY),"\n")),ULARN&&(o+="VORP:  ".concat(booleanToNumberString(e.VORPAL),"\n")),ULARN&&(o+="STAFF: ".concat(booleanToNumberString(e.STAFF),"\n")),ULARN&&(o+="PRSVR: ".concat(booleanToNumberString(e.PRESERVER),"\n")),ULARN&&(o+="PAD:   ".concat(booleanToNumberString(e.PAD),"\n")),ULARN&&(o+="ELEDN: ".concat(booleanToNumberString(e.ELEVDOWN),"\n")),ULARN&&(o+="ELEUP: ".concat(booleanToNumberString(e.ELEVUP),"\n")),o+="\nLocation:\nx,y:   ".concat(e.x,",").concat(e.y,"\n"),o+="\nCounters:\n",o+="TIME:  "+a+"\n",o+="RMST:  "+r+"\n",o+="ENERG: ".concat(e.ENERGY,", ").concat(e.ECOUNTER,"\n"),o+="REGEN: ".concat(e.REGEN,", ").concat(e.REGENCOUNTER,"\n"),o+="\nStats:\n",o+="MOVES: "+e.MOVESMADE+"\n",o+="KILLS: "+e.MONSTKILLED+"\n",o+="CAST:  "+e.SPELLSCAST+"\n"}}function booleanToNumberString(e){return e?"1":"0"}var MAZES,USED_MAZES=[];const COMMON_MAZES=["####################################################################  ..                                                             ## ############## ############################################## # ##         #    # #                                #     ..    # # ##         #D## # # ############D################# ########### # # ########## #- # # # #-    D    # # ~  #          # #         # # # ##       # #  # # # #   ### #  # #    D   -      # # ####### # # # ##  .... # #### # # #   #!# #  # ######      ..  #.# #     # # # # ##  .... #      # # # ### # #  # #    #########D#### # ### # # # # ##  .... ######## # # D   # #- # #..  #       ...#.# # #.# # # # # ##       #        # ###   # #### #.-  D   -      #.# #.#.# # # # # ######DD## ######## #     #    D D.   #          # # #...# # # # # ## #   ..# #    # # ############################## # ##### # # # # ## ......# #  #   #                                #       # # # # ## ####### ###### ################################ ######### # ### ##               .D.                                         #     ####################################################################","####################################################################                  ##        ##            ###                ##  ##  #####            ## ..-  ##            ##.##              ##   ##  # ! ##            ## .  ##            ##  .##    ..      ##    ##  #....######        ##  ##            ##  .  ##          ##     ##  # -  #    ##        ##D#            ##  .    ##        ##      ##  #####D  ~  ####### ###........     ## ...     ##      ##       ##  #    #     ##        ##   ....    ##  .        ##    ##        ##  #.   ########         ##         ##   .     -  ####D####   -   ##  #.-  #...## ##   ...   ##        ###  ......  ##       ##      ##  #.   #..##   ##         #########  ##    ... ##   ###   ## ..  ##  #..  #.##     ## ## -  ##  .  ####  ##      ##   #####   ##    ##  #####D##          ##  ##     ######  ##    ##   #######   ##   ##  D  -.##            ####     ########  ##DD##    ########   #D  ##  ######   ...        ##     ##########                       ## #####                                                 .     .    ######################################################################","####################################################################                                                                 ##     ####.########################################## ## ###########     #      #.#.#.#                   #.. #.   #           #     ########    # # # # #       #####       #!  #    ########### # ### ##     #    # # # # #      ##...##      #   #    #         # # #-# ## ..- D    # # # # #     ## .   ##     ####D#####  .. ### #   # # ##     #    #       #    ##.   ~ .##    #   #    ###   # # ##### # ############# # # # #   ##  . .   .##   #...# .. #.#   # #       # ##  ..     .# # # # #   ##     -   ##   #   #    D.D   # ######### ##      .   D # # # #    ##.......##    ####D#####.#   #           ##   - .    # # # # #     ##     ##     # . #    ###   ########### ############# #.#.# #      ###D###      # . #....#               # ##            # #-# D               ..  #  .#    ###....##  ##-### #####   ########################################## ######    ###   ##         .                                                       ####################################################################","####################################################################                                                                 ##                        ###########################D#######  ##  ##  #######################                    # ##...... ##   ##  ##                        ########D######  #   # !##.... ##    ##  ##   ############    ##  ##    ...      #  #   #...## ~ ## ######  ##   #          #    #    # ......      #  #   # .. #####      ##  ##   #    - ..  #    #    #   ###########  #   #  .  ######### ##  ##   #####  #####    #    #   #            #   #...   ##       ##  ##       #  #        ##########  ########  ########DD#### #######  ##       #  #  ....  #        #  #             #     #  ##     ##  ##   #####  #        #    ....#  #  #########  #     #   ##### ##  ##   #-    ######D##########..#  #  #########  #  -  #..  ##   ##  ##   #####  #                 #  #             #...  #.....##      ##       #  ###################  ###############...  ####   # #######       #                                                         ####################################################################","####################################################################                                                                 ############ #####      #####     #####D####    #####       ###### ##..       # #-..D ######   ##    # ##     #   ## ..##    ### #### ##  #### ### ##### #         ##   #  ##### #  ## ### ##   #   #    ##  #  # #       # # ##### #  ##  #      # ####  # #..##### - ###  ##  #  # ####### ### #...# #   ########  #       # #~.   ....   #  ##  #  #       #     #...# #          #  ######### ##############  ##  #  ######  #######   # ###   ###  #       ..                #  ##  #       #          - # #-#####!#  # #      ####  ## ####    #  ##  ######  #   ########## #.. ....#  # ########  #  #  #  ##   ## ##     -.#  #####          ####...##  #    .  .#  #..#  #   ##   # ##    ####        ######      #.###   #####.####  ####  ###  ##  # ##    #-    #######....####   ......      #.#       .     #   ## # ##    #######             ##### ###########.###############    ### ##                                         .                       ####################################################################","####################################################################   #     #-   .      #   # # # # # #   #                         ## # #     #####.##### # # # # # # # # # # ###########D########### ## # #####     # # ### # # # # # # # # # ###     #....    #  #   # ## #     #     #       # # # # # # # # # #       #.!. -.. #.##.# # ## # . - #     # ####### # # # # # # # # #       ########## ## #   ##.#######     #         #       D     #        .              # # ##.     -#     ################################################### ##   #####     D.                                             .    ##  #         ###  ###D### ### ### ###D### ### ### ###D### ###.### ##  # ######  ### .#    .# #.    # #     # #     # #     # # .   # ##  ### # -#  ### .#. - .# #     # #...- # # ..  # #  -..# # .   # ##      #  #  ###  #. ~ .# #     # #     # #     # # .. .# #     # ##.######  #  ###  #     # #.....# #     # #     # #     # #     # ## #      #######  ####### ####### ####### ####### ####### ####### ## # ...                                       ..                  ####################################################################","####################################################################.. .       #           D                   .                 #-  #### ######### ######### # ## ### ##### ## ########### ####### ### ##.# #   #   #       .-# # #-   #    #   # # -# #      #           ## # #.#  .  #   ####### # #    #    #   # #  # #      #       ###### # ..#######   #     # # #### #    ## ## ##!# ###### ####### #   ## - ..D #   D   #   . D # #  # #.##### ## ## # #. #.# #..#  # ### ######## ####### ###   # # #    # #      # D  # D  D   #..D  #     ##-                #   # # #### # ###### # ## # #. #   #..#    ######## #######################- # # #    ######################  #   ##   ...       #   .       #..# ###    #   - ..  .          #. ### ##             #           #  # #-#    #################### #  #   ##                         #     -#                                #################################-################################ ##-.....             # ####D    ###    #          #            #   ##~.....              #    #            #                   #  D   ####################################################################","####################################################################  ..                                                             ## ############## ############################################## # ##         #    # #                                #     ..    # # ##         #D## # # ############D################# ########### # # ########## #- # # # #-    D    # #.!..#          # #         # # # ##   #   # #  # # # #   ### ## # #....D   -      # # ####### # # # ##  .... # #### # # #   #~# #  # ######      ..  #.# #     # # # # ####....##      # # # ###.# #  #      #########D## # # ### # # # # ##  .... ######## # # D  .# #- #  ..  #       ...#.# # #.# # # # # ##   #  ##        # ###  .# ####  .-  D   -      #.# #.#.# # # # # ######DD## ######## #... .#       .   #          # # #.#.  # # # # ## #   ..# #      # ############################## # # ##### # # # ## ......# #  # # #                                # #       # # # ## ####### ###### ################################D# ######### ### ##               .D.                                           #-.-####################################################################","####################################################################                  ##        ##         ##        ##          ##  ##  ##############   ## ..-  ##          ##  .     ##         ##   ##  #    #       ##   ## .  ##           ##   .    ##..      ##    ##  #....######   ##   ##  ######## #######  .     ##       ##     ##  # -  #    ##   ##   ##D#            ##  .      ##      ##      ##  #          D###### ###........     ## ...      ##     ######   ##  #    #     ##        ##   ....    ##  .        ##    ##  - #   ##  #.   ########         ##         ##   .     -  ####D####.. D   ##  #.-  #...## ##   ...   ##        ###  ......  ##       #####   ##  #.   #..##   ##         #########  ##    ... ##   ###   ## ..  ##  #..  #.##     ## ## -  ##  .  ####  ##      ##   #####   ##    ##  #####D#######  #  ##  ##     ##..##  ##    ##   ##   ##   ##   ##  D  -.##     #  #   ####     ##.-.-##  ##DD##    ### ####   ##  ##  ######.  ...# ####  ##     #### #####                ##     ##D#####~!....     D                                     .     .      ####################################################################","####################################################################                                                                 ##     ####.########################################## ## ###########     #      #.#.#.#                   #..  .   #           #     ########    # # # # #   #############   #        ########### # ### ##     #    # # # # #    --##...##--    #        #         # # #-# ## ..- D    # # # # #   #-## .   ##-#   ####D#####  .. ### #   # # ##     #    #       #   ###.     .###   # ~ #    ###   ### ##### # ############# # # # #   ##  . .   .##   #...# .. #.#             # ##  ..     .# # # # #   ##     -   ##   #   #    D.    # ######### ##      .   D # # # #   ###.......###   ####D#####.#   #           ##   - .    # # # # #    -##     ##-    # .      ###   ########### ############# #.#.# #   ######D######   # .  ....#               # ##            #!#-# #               ..  #  .     ###....##  ##-### #####   ##############################  ########## ######    ###   ##  D      .                                                       ####################################################################","####################################################################                                                                 ##                        ###############D####################D#   ##  #######################                    # ##......      #   ##                        ########D######  #   #  ##....       #   ##   ############### ##  ##    ...      #  #   #...##      #####   ##   #    ~        # #    #!......      #  #   # .. #####      #   ##   #    - ..     # #    #   ###########  #   #  .  ######### #   ##   #####  ######## #    #   #         #  #   #...   ##       #   ##    .  #  #      # ##########  ########  ########D #### ######   ##    .  #  #  ....# #        #  #             #     #  ##     #   ##   #####  # ###### #    ....#  #  #########  #     #   #####D#   ##   #-    ## #      #######..#  #  #########  #  -  #..           ##   #####  #                 #  #             #...  #.....        ##       #  ###################  ###############...  ####     #######       #                                                         ####################################################################","####################################################################                      #                                          ############ #####      #         #####D####    #####       ###### ##..       # #~..D ######   ##    # ##     #   ## ..##    ### #### ##  #### ### ##### #         ##   #  ##### #  ## ### ##   #   #    ##  #  # #       # # ##### #  ##  #      # ####  # #..##### - ###  ##  #  # ####### ### #...# #   ########  #       # #!.   ....   #  ##  #  #       #     #...# #          #  ######### ##############  ##  #  ######  #######   # ###   ###  #       ..                #  ##  #       #          - # #-    # #  #        ######## ####    #  ##  #       #   ########## #.. ....#  # ########        #  ##   ## ##  #  -.   #####          ####...##  #    .  .#   ..   #        # ##  #             ######      #####   #####.####        #######  # ##  #  -    #######....####   ......      #.#       .     #   ## # ##  #########             ##### ###########.###############    ### ##                                         .                       ####################################################################"],LARN_MAZES=["####################################################################           #  .        #                 #     #     #     #   . ##           D           D  .                       .        D .   ####D##########################################  #     #     ###D####          -#                 #.    #      # ################ .  .##     ####### ######## ############ D #### #                #     ## ... #.#   # #  # . # #            # #### # ############ # ###D####     #.# # # ## #   # # ############ #### # #-  #      # # #.    ##  .  # # # # ## #-  # # #    -     D #### # # . D    # #.# # ... ##     # #.# #    #   # # #   . .    # #    # #   #    # #-# # ~.! ####D### ### #######D## # ############ ###### ########## ### ########                    #  #          .#        #     .....       ...####D###########################################################D####  .  #.....#     #     #     #    -#     #     #     #     #     ##      .....    .       D           D                 D     D.    ##     #.....#     #     #     #     #     #    .#     #     #     ####################################################################","####################################################################     D                    ##           ##  ##     ##      #   #  ## - . #   #######           ##   -.-   ##  ##      ## ####     D  #####  #   #.#-#.#  .#.    # .##       ##   #  ####### .  ###   #  ##     # - ##-#.#D  ###    # ..##     ##  ##D   ### ### ### #####  ## .   #   # # #.#  .#.    #-   ##...##..######  #      # # #   #  ##  ####   #######         ###  -## ##--########   ####     # -.D  ##     # #         #         ######D############# ###########   #  ######D# ###########              D D               # # #  .##D##  ##     # #         # # #### # #####D############  ###-  D  ##   ##### #####   #######   # #!.#-#   #     # . D      ## #   #  .#   #~.##     #   #     #   # #..#####.#     #   ### # ##  ##D######   #..###### #   D #.# # - # #  #   ###     ##### # #    .#   #   ##.##..##  .  #   #     #   # #D## #   #######    .  #    .## .D  ##   #  ###### #   #######   #      # #         ### # # ##  #  -#   #   D  ##                   #      # ###########   #   ### #####       #  ####################################################################","####################################################################.. .                   D  #                .  #              #-  ############## ######### # ## ### ##### ## #### ###### ####### ### ##.#!#~# #   #       .-# # #-   #    #   # # -# #      #           ## # #.#  .  #   ####### # #    #    #   # #  # #      #       ###### # ..# #####   #     # # #### #    ## ## ## # ###### ####### #   ## - ..D #   D   #   . D # #  # #.##### ## ## # #. #.# #..#  # ### ######## ####### ###   # # #    # #      # D  # D  D   #..D  #     ##-                #   # # #### # ###### # ## # #. #   #..#    ######## #######################- # # #    ######################  #   ##   ...       #   .       #..# ###    #   - ..  .          #. ### ##             #           #  # ###    #################### #  #   ##                              ###                                ################################################################## ##-                        D    ###    #          #            #   ##  .                      #            #                   #  D   ####################################################################","####################################################################           #  .        #     ###         #     #     #     #   . ##           D           D  .        #              .        D .   ################################################ #     #     ###D####          -#                 #.    #      # ################ .  .##     #######D######## ############ # #### #                #     ## ... #.    # #!~  . # #            # #--# # ############ #####D####     #.# # # ## #   # # ############ #--# # #-  #      # # #.    ##  .  # #-# # ## #-  # # #    -     D ## # # # . D #### #.# # ... ##     # #-# #    #   # # #   . .    # #    # #   #    # #-# # -.- ####D### ### ####### ## # ############ ###### ########## ### ###D####                    #  #          .               .....       ...######################################           ###############D####  .  #.....#     #     #     #    -#           #     #     #     ##      .....    .       D           D                 D     D.    ##     #.....#     #     #     #     #          .#     #     #     ####################################################################","#################################################################### D D     #-..........#     #   #   #   #                         ##D#D#     #####.#####.# #   #   #   # # #############D########### ## # #####     #.#~###.# #   #   #   # # ###      ....    #  #   # ##D#     #     #.......# #   #   #   # # #        . . -.. #. #.# # ## # . - #     #.####### #   #   #   # # ##################    #   ##D#######     #.        #       D     #        .              # # ##. D D -#     ################################################### ##  ######      .                                             .    ##  #    D    ###  ###D### ####### ###D### ####### ###D### ####### ##  # ######  # # .#    .# #.    # #     # #     # #     # # .   # ##  ###   -#  # # .#. - .# #     # #...- # # ..  # #  -..# # .   # ##DD#      #  # #  #.   .# #     # #     # #     # # .. .# #     # ##.######  #    #  #     # #.....# #     # #     # # !   # #     # ## #      #######  ####### ### ### ####### ### ### ####### ### ### ## # ...                                       ..                  ####################################################################","####################################################################     #   #                  #                                    ##  #  D   #  #########         #########################.####     ######.#   #  #       ####D#### #               #.#.#.#      #     ##   # #   #  # ##### #   #   # # #    #D#      # # # # #    ######## #   #####  # #...# # . # - # #     ## ##     # # # # #    # .   ## #  ##  # - # D.#~#-#   #   # #    ##...##    # # # # #    D..!  ## ####  ###  ###.. #.####D#### #   ##     ##   # # # # #    # .   ## #      #   # #####.#   #   # #   #. -   .#   D D D D #############    ##      #    ## #   # . # #   ##     ##   # # # # #.     ..  ## ######.### #   ## ##   #   # #    ##   ##    # # # # D   .      ##    ##      #  ## ##..##D#### #     ## ##     # # # # #    . -   ## #.     #   #D## ##  ##  #  # #.     ###    # #.#.# # ############# ###   ###        ####   #    #-.             # #-# #         D  ## #   #. #   ### #   #  -    # ########D#################### . #####     #      #   # #   #  #  #                                 D  ####################################################################","####################################################################  #         -            #            ##  ###   #                ## ## # ################## #            ##   #### # #####    #D### ##  . # #                  #        #####     D # #  -  # .. #   # ## #### # #  ###D###   -   #   --    .  D     D   # ### #    #   # ##    ### #  ##  ##        #        ######   #### # # # #    #   # ####      ####  ##   ##### #        ######  ###     #   #    #   # ## # ########- ##   ##   # #        ############################## ## # ###  ##  ##   ###   D                                    .    ## # ##  ####  ## ##!#   # ###D### ####### ###D### ####### ###D### ##   #  ##  ## .###..##### #     # #..~..# #     # #     # # .   # ####D#D###   ##..#..##   # # .- .# #  .  # # ..  # #  -..# # .   # ##   #   #    ##...##  - # # .  .# #     # #     # # .. .# #     # ## . #     .. ######     # #    .# #.    # #     # #     # #     # ##   D        #########  # ####### ###D### ####### ###D### ####### ##   #   #    D            #                                       ####################################################################","####################################################################         #    #   #          ##     ##   ##   ##       D         ## #. # -# #  # #   #  ####### D##...## ####### ### ###### ######  ##         #  # ## ##  #!  .##.# ## ##          D.#      # #~.. D  #####D######  #  # .####...## ##  # #######D### #######. # # .### ###  #         #  ##  ####D## ##   #          #   ##   .. # #### # ###  ########  #   ## ###  ### ## ## #### ### #   ##      #      #  ##  ########  ###### # .    ## ###   #     # ######D#############  ##                      .   ##     - ####### #        #            ##           ####### #   .  ## ###   ##   D.   #####D###########D########D##### #     # ###. ### ##### ### - ## ###  #   #   #   #    ##.       -# #.#   # ####### ##     # #   ## #    # .   -   . D    ######D##### # #   #         ##   # # ###### #     #  #   #   #    ##-       .# # #   #####D######   # # . #  # #### ######D################ ##### # #   D   #  #   D   # # # # ####                     ##         D   #   D   #  #   D   #   #             ..             ####################################################################","####################################################################     D                    ##           ##  ##     ##      #   #  ## - . #   #######           ##   -.-   ##  ##      ## ####     D  #####  #   #.#-#.#  .#.    # .##       ##   #  ####### .  ###   #  ##     # - ##-#.#D  ###    # ..##     ##  ##D   ### ### ### #####  ## .   #   # # #.#  .#.    #-   ##...##..######  #      # # #   #  ##  ####   #######      #  ###  -## ##--## #####   ###      # -.D  ##     # #         #   ##    ######D######  ##### ####D######   #  ######D# ###########              D D               #   # ..##D##  ##     # #         # # #### # #####D############  ###-  D  ##   ##### #####   #######   # # .#-#   #     # . D      ## #   # .!#   #  ##     #   #  .. #   # #. #####.#     #   ### # ##  ######### . #  ###### #   D #.#~# - # #  #   ###     ##### # #    .#   #   ##D##..##  .  #   #  .. #   # #D## #   #######    .  #    .## .D  ##   #  ###### #   #######   #      # #         ### # # ##  #  -#   #   D  ##                   #      # #         #   #   ### #####       #  ####################################################################","####################################################################     # . #                  #                                    ##  #  D .!#  #########         #########################.####     ######.# . #  #       ####D#### #               #.#.#.#      #     ##   # #.. #  # ##### #   #   # # ##   #D#   ## # # # # #    ###D#### #   #####  # #.  # # . # - # # #-  ## ##  -# # # # # #    # .   ## #  ##  # - # D.# #-#   #   # #    ##...##    # # # # #    #..   ## ####  ###  ###.  #.######### #   ##     ##   # # # # #    # .   ## #      #   #~#####.#   #   # D   #. -   .#   # D D D #############    ##      #   .## #   # . # #   ##     ##   # # # # #.     ..  ## ######.### #...##  #.. #   # #    ##   ##    # # # # D   .      ##    ##      #..##  #####D#### # #   ## ##   # # # # # #    . -   ## #.     #   #D##   #     #  # #.##   ###   ## #.#.# # ############# ###   ###         ####  #    #-.             # #-# #         D  ## #   #. #   ### #   #  -    # ############################# . #####     #      #   # #   #  #  #                                 D  ####################################################################","####################################################################  #         -            #        #   #   ###   #                ## ## # ################## #          # #    #### # #####    #D### ##  . # #                  #        #####     D   #  -  # .. #   # ## #### # #  ###D##### -   #   --    .  D     D   # ### #    #   # ##    ### #  ##  ##  D     #        #####    #### # # # #    #   # ####      ####  ##   ##### #        #####   ###     #   #    #   # ## # ########- ##   ##   # #        ############################## ## # ###~.##  ##   ###   D                                    .    ## # ##..####  ## ## #   # ###D### ####### ###D### ####### ###D### ##   #. ##  ## .###. ##### #     # #.   .# #     # #     # #.....# ###D##D###   ##. #. ##   # # .- .# #  .  # # ..  # #  -..# #.....# ##   #   #    ##.  ##  - # # .  .# #     # #     # # .. .# #     # ## . #     .. ######  .. # #    .# #.    # #     # #     # #  !  # ##   D        #########D## ####### ### ### ####### ### ### ####### ##   #   #    D            #                                       ####################################################################","####################################################################         #    #   #          ##     ##   #     #       D         ## #. # -# #  # #   #  ####### D##...## ####### ### ###### ######  ## #  #  # #  # ## ##  # .. ##.# ## ##          D.#      # # .  D  ##      .  #  #  # .####   ### #  # #######D### #######. # # .### ######D######  #  ##  ####D#### #  #          #    #  ##. # #### # ###         #  #   ## ###  #### # ## #### ### #    #    . #      #  ##  #####  #  ###### # .    ## ###   #     # ######D#############  ##  #####  #            .   ##     - #######          #            ##           ####### #   .  ##  ##    #   D.  ##D########################D##### #     # ###. ###  ###  # # - ##  #   #   #   #   # ...##.       -# #.#   # #######  ##    # #   ##  #     .   -   . D ..!############ # #   #         ##   # ###########   #   #   #   # ...##-       .# # #   #####D######   # # . #   # ##D######################## ##### # #   D   #..#   D   # # # # # #                      ##         D   #   D   #.~#   D   #   #   #         ..             ####################################################################"],ULARN_MAZES=["####################################################################           #  .        #                 #     #     #     #   . ##           D           D  .                       .        D .   ####D##########################################  #     #     ###D####          -#                 #.    #      # ################ .  .##     ####### ######## ############ D #### #                #     ## ... #.#   # #  # . # #            # #### # ############ # ###D####     #.# # # ## #   # # ############ #### # #-  #      # # #.    ##  .  # # # # ## #-  # # #    -     D #### # # . D    # #.# # ... ##     # #.# #    #   # # #   . .    # #    # #   #    # #-# # ~.! ####D### ### #######D## # ############ ###### ########## ### ########                    #            .#        #      .....       ...####D###########################################################D####  .  #.....#     #     #     #    -#     #     #     #     #     ##      .....    .       D           D                 D     D.    ##     #.....#     #     #     #     #     #    .#     #     #     ####################################################################","#################################################################### #             . - .                          .             .    ## #D############################################################ .## # #       .                          -                     . # ###.#.#D#######################################################  #. ## # # #   .                     .              .            #  ##-## #-# #D################################################### #  # .## # # # # .     # -     #       #  .   -#  .    #.......#!# #  # ### # # # # ### ### ### ###.### ### ### ### ### ###.###.###~# #  #. ##.# # # .   # .  .  #    .  #    -  # . .   #   ....#.....# #  ## ## #.# ##################################################### #  # .## # #                            ..            .            #. #-### # #########################################################  #. ## #        ..     -                      .         .       . . ## ##-##############################################################  ##.                                                              . ####################################################################","######################################################################   #    ##  #...#           .  . .  .     #  #  #  ##       .#### ##     #  ##   #   ####################### #  #.   ##  #####D#D ## D########  ##  #####   #    D D      #   # #  #   ##  ## -..##  ## # ##..- #   ##     #   #   ## ##  .  # # # #  #  ###  ###  ###  ## #  ##-..#    ## .  ##  #  ##-. ## .  # # # #    ## #  #-.-## #  ## #   ## -##### ##   #  .  ## . - ##   # # # #   ##  #  #..##  #  ##.#### ##D##-.#  ##  #  . ## .....-##  # # # #..##  -#### ##   #  ## #  # DD ##-.D   ## # ..######D###### # # # #.DD  ###  D##  ###  ## #.## ## #####  ## ###    #  #D#   #    #   #..##   #    ##...#  ## #.# ##..##    ##  #    #   ##.##    ########   ##  ##  ####..#  ##-#. ##...##   ##.  ###### ### .-##    #  -  #    ##  ##    ## #  ## # ##..#.##  ##. ###  # # ##.-. .##   #   ######  ##  ####  ##D. ## ### #####  ##         .###!. . .~##.   ##  #      ##  ##   -##  ## ## ##     ############ #####################  ###  ##  ####  ## ####     #   D    . .    .      -             ..       ##.....  #######################################################################","####################################################################.  #   #      #   .            #     #  #       ##    ####    .. ## # # # ###### #  #    .       . .  #      . #      .#  . ##.  .. ## #.  #  .     .  #  # . #     #D######################## #D##  - ## #################    #      ##.## . .                   #..##   ## #     .#   .    #   ###    ##. .##  #####################   ##  ## #  -  .D   . -  #  # - #  ##  #  ##   #.  #   #   #   #   ## ## ## ########  ..    #        ##  ###  ##  # # # # # # # # #   ##  #### D.              #       ##  ##!##  ##   # # # # # # # #     .. ### ################# .    ##  ##.~.##  ##### # # # # # # ##### ... ## D.     #      . #     ##. ## .#. ##  ## ..# # #.# # #.#    . -. ## # .- . #.    -  #    ##  ## ..#.. ##  ##  # # #-# # # #    ####### #      D.       #   ##  ##  #####- ##  ##   # # # # # #  #.#    ## ##############D##  ##  ## .. ... .. ##  ##### #.# # # ## #   - ### #.     .        # ##  ########D########  ## . # # # # #  # #  . ## #     -       . ###     -    . .          ##.   #   #   #### #  ####################################################################","#################################################################### # .- . #.    -  #    ##  ## ..#.  ##  ##  # # #-# # # #    ####### #      D.       #   ##  ##  #####- ##  ## .   # # # # #  #.#    ## ##############D##  ##  ## .      .. ##  ##### #.# # # ## #   - ###.  #   #      #   .            ##### #  #        #    ####    .. ## #D# # ###### #  #    .       . .  #      . #      .#  . ##.  .. ## #.  #  .     .  #  # . #    ##D#### ###################  D##  - ## ################# .    ##  ##. .##  ##### # # # # # # ##### ... ## D.     #      . #     ##. ## .#. ##  ## ..# # #.# # #.#    . -. ## #.     .        # ##  ########D########  ## . # # # # #  # #  . ## #################    #      ##.## . .                   #..##   ## #     .#   .    #  ####    ##. .##DD#####################   ##  ## #  -  .D   . -  #  # -##  ##  #  ##   #.  #   #   #.  #   ## ## ## ########  ..    #  #  #  ## .### .##  # # # # # # # # #   ##  #### D.              #     # ##  ##!##  ##   #   # # # # # #     .. ### #     -       . ###    -## . .~. . ##     ###.  #   #   #### #  ####################################################################","####################################################################.. .                   D  #                .  #              #-  ############## ######### # ## ### ##### ## #### ###### ####### ### ##.#!#~# #   #       .-# # #-   #    #   # # -# #      #           ## # #.#  .  #   ####### # #    #    #   # #  # #      #       ###### # ..# #####   #     # # #### #    ## ## ## # ###### ####### #   ## - ..D #   D   #   . D # #  # #.##### ## ## # #. #.# #..#  # ### ######## ####### ###   # # #    # #      # D  # D  D   #..D  #     ##-                #   # # #### # ###### # ## # #. #   #..#    ######## #######################- # # #    ######################  #   ##   ...       #   . #     #..# ###    #   - ..  .          #. ### ## ########    #     #     #  # ###    #################### #  #   ##        #                     ###                                ################################################################## ##-     #             #    D    ###    #          #            #   ##  .         #            #            #                   #  D   ####################################################################","####################################################################           #  .        #     ###         #     #     #     #   . ##           D           D  .        #              .        D .   ################################################ #     #     ###D####          -#                 #.    #      # ################ .  .##     #######D######## ############ # #### #                #     ## ... #.    # #!~  . # #            # #--# # ############ #####D####     #.# # # ## #   # # ############ #--# # #-  #      # # #.    ##  .  # #-# # ## #-  # # #    -     D ## # # # . D #### #.# # ... ##     # #-# #    #   # # #   . .    # #    # #   #    # #-# # -.- ####D### ### ####### ## # ############ ###### ########## ### ###D####                    #             .               .....       ...######################################         # ###############D####  .  #.....#     #     #     #    -########### #     #     #     ##      .....    .       D           D         #       D     D.    ##     #.....#     #     #     #     #          .#     #     #     ####################################################################","#################################################################### D D     #-..........#     #   #   #   #                         ## # #     #####.#####.# #   #   #   # # #############D########### ## # #####  #.-#.#~###.# #   #   #   # # ###      ....    #  #   # ## # .   # #D###.......# #   #   #   # # #        . . -.. #. #.# # ## # . - # ##. #.####### #   #   #   # # ##################    #   ##D####### #  ##.        #       D     #        .              # # ##. D D -# #   ################################################### ##  ###### ##   .                                             .    ##  #    D    ###  ###D###D####### ###D###D####### ###D###D####### ##  # ######  # # .#    .# #.    # #     # #     # #     # # .   # ##  ###   -#  # # .#. - .# #     # #...- # # ..  # #  -..# # .   # ##DD#      #  # #  #.   .# #     # #     # #     # # .. .# #     # ##.######  #    #  #     # #.....# #     # #     # # !   # #     # ## #      #######  ####### ### ###D####### ### ###D####### ### ###D## # ...                                       ..                  ####################################################################","####################################################################-D  .      -#               .             #   #   --  .          ## # ######## # ########################### # # #   --  .-######## ## # #   .    # #                         # # # # ######### .    . ## # # ######## # ####################### # # # #- .      # ######### # #          # #.                 . .# # #.# ######### #        ## # ############ #. ####### ############ # # #-          ######## ## # #.--.        ## #       #       #    # # #############    .   ## # #-..- ######### # ####### ##### # #### #-            # ######### # ##### #   #   # #      -#     # #    # ############# #        ##.#  .  #.# # # # # ####### ##### # #### # #   #   #   # ######## ## ##### # #.# #.# #.#       #    .#.     # # # # # # # # #    .   ## # . # # # # # # # # ####### ############ #.# # #.# # # # ######### # # # # # # # # # #       #              # # # # # # # #        ## # # # # # # # # # ####### ################ # # # # # # ######## ##   #   #   #   #   #!~---D                  #   #   #    .     . ####################################################################"];var GAMENAME,MAXLEVEL,MAXVLEVEL,DBOTTOM,VBOTTOM,TIMELIMIT,MAX_BANK_BALANCE,FORTUNES,Level={items:[],monsters:[],know:[]},images=null;function loadImages(){var t;images=[],console.log("loading images");for(let e=0;e<=65;e++)t="img/m".concat(e,".png"),images[t]=createImage(t);for(let e=0;e<=100;e++)t="img/o".concat(e,".png"),images[t]=createImage(t);for(let e=0;e<=30;e+=2)t="img/w".concat(e,".png"),images[t]=createImage(t);images[t="img/player.png"]=createImage(t)}function createImage(e){var t=new Image;return t.onload=function(){},t.src=e,t}function newcavelevel(e){if(level!=e&&(changedDepth=millis()),lasthy=lasthx=0,screen=initGrid(MAXX,MAXY),LEVELS[e])return player.level=LEVELS[e],level=e,sethp(!1),positionplayer(player.x,player.y,!0),void checkgen();if(initNewLevel(e),makemaze(e),updateWalls(),makeobject(e),sethp(!0),positionplayer(player.x,player.y,!0),checkgen(),wizard||0==level)for(var t=0;t<MAXY;t++)for(var a=0;a<MAXX;a++)player.level.know[a][t]=KNOWALL}function initNewLevel(e){var t=Object.create(Level);t.items=initGrid(MAXX,MAXY),t.monsters=initGrid(MAXX,MAXY),t.know=initGrid(MAXX,MAXY),LEVELS[e]=t,player.level=t,level=e}function loadcanned(){for(var e;e=rund(MAZES.length),-1<USED_MAZES.indexOf(e););return USED_MAZES.push(e),MAZES[e]}function cannedlevel(e){for(var t=loadcanned(),a=player.level.monsters,r=0,o=0;o<MAXY;o++)for(var n=0;n<MAXX;n++){switch(t[r++]){case"#":setItem(n,o,OWALL);break;case"D":setItem(n,o,createObject(OCLOSEDDOOR,rnd(30)));break;case"-":setItem(n,o,createRandomItem(e+1));break;case".":if(e<(ULARN?MAXLEVEL-6:MAXLEVEL))break;a[n][o]=createMonster(makemonst(e+1));break;case"~":if(e!=DBOTTOM)break;setItem(n,o,OLARNEYE),create_guardian(ULARN?DEMONPRINCE:rund(8)+DEMONLORD,n,o);break;case"!":if(e!=VBOTTOM)break;setItem(n,o,createObject(OPOTION,21)),create_guardian(ULARN?LUCIFER:DEMONPRINCE,n,o)}player.level.items[n][o]||setItem(n,o,OEMPTY)}}function makemaze(a){var e=!1;if(a==DBOTTOM||a==VBOTTOM?e=!0:1<a&&(e=ULARN?rnd(100)<50:rnd(17)<=4),e)cannedlevel(a);else{var t=player.level.monsters;for(let t=0;t<MAXY;t++)for(let e=0;e<MAXX;e++)setItem(e,t,0==a?OEMPTY:OWALL);if(0!=a){eat(1,1),1==a&&setItem(33,MAXY-1,OHOMEENTRANCE);var r,o,n,i=rnd(3)+3;for(let e=0;e<i;e++)for(var l,s=(l=rnd(11)+2)-rnd(2),c=l+rnd(2),d=a<MAXLEVEL?(o=(r=rnd(44)+5)-rnd(4),n=r+rnd(12)+3,null):(o=(r=rnd(60)+3)-rnd(2),n=r+rnd(2),makemonst(a)),p=o;p<n;p++)for(var u=s;u<c;u++)setItem(p,u,OEMPTY),t[p][u]=d?createMonster(d):null;l=rnd(MAXY-2);for(let e=1;e<MAXX-1;e++)setItem(e,l,OEMPTY);(ULARN?4:1)<a&&treasureroom(a)}}}function updateWalls(e,t,a){var r,o,n,i=null==e?(r=0,o=MAXX-1,n=0,MAXY-1):(r=e-a,o=e+a,n=t-a,t+a);for(t=n;t<=i;t++)for(e=r;e<=o;e++)setWallArg(e,t)}function eat(e,t){for(var a=rnd(4),r=2;r;){switch(a){case 1:if(e<=2)break;if(!itemAt(e-1,t).matches(OWALL)||!itemAt(e-2,t).matches(OWALL))break;setItem(e-1,t,OEMPTY),setItem(e-2,t,OEMPTY),eat(e-2,t);break;case 2:if(e>=MAXX-3)break;if(!itemAt(e+1,t).matches(OWALL)||!itemAt(e+2,t).matches(OWALL))break;setItem(e+1,t,OEMPTY),setItem(e+2,t,OEMPTY),eat(e+2,t);break;case 3:if(t<=2)break;if(!itemAt(e,t-1).matches(OWALL)||!itemAt(e,t-2).matches(OWALL))break;setItem(e,t-1,OEMPTY),setItem(e,t-2,OEMPTY),eat(e,t-2);break;case 4:if(t>=MAXY-3)break;if(!itemAt(e,t+1).matches(OWALL)||!itemAt(e,t+2).matches(OWALL))break;setItem(e,t+1,OEMPTY),setItem(e,t+2,OEMPTY),eat(e,t+2)}4<++a&&(a=1,--r)}}function treasureroom(e){for(var t=1+rnd(10);t<MAXX-10;t+=10)2==rnd(ULARN?13:10)&&troom(e,rnd(6)+3,rnd(3)+3,t,rnd(MAXY-9)+1,rnd(9))}function troom(t,a,e,r,o,n){for(var i,l=player.level.monsters,s=o-1;s<=o+e;s++)for(i=r-1;i<=r+a;i++)setItem(i,s,OEMPTY);for(s=o;s<o+e;s++)for(i=r;i<r+a;i++)setItem(i,s,OWALL),l[i][s]=null;for(s=o+1;s<o+e-1;s++)for(i=r+1;i<r+a-1;i++)setItem(i,s,OEMPTY);switch(rnd(2)){case 1:setItem(i=r+rund(a),s=o+(e-1)*rund(2),createObject(OCLOSEDDOOR,n));break;case 2:setItem(i=r+(a-1)*rund(2),s=o+rund(e),createObject(OCLOSEDDOOR,n))}var c=o+(e>>1);if(getDifficulty()<2)for(let e=r+1;e<=r+a-2;e+=2)for(i=0,s=rnd(6);i<=s;i++)dropItem(e,c,createRandomItem(t+2)),rnd(101)<8&&i--,createmonster(makemonst(t+(ULARN?2:1)),e,c);else for(let e=r+1;e<=r+a-2;e+=2)for(i=0,s=rnd(4);i<=s;i++)dropItem(e,c,createRandomItem(t+2)),rnd(101)<8&&i--,createmonster(makemonst(t+(ULARN?4:3)),e,c)}function makeobject(e){if(0==e)return fillroom(OENTRANCE,0),fillroom(ODNDSTORE,0),fillroom(OSCHOOL,0),fillroom(OBANK,0),fillroom(OVOLDOWN,0),fillroom(OHOME,0),fillroom(OTRADEPOST,0),void fillroom(OLRS,0);var t,a;for(1==e&&(LEVELS[e].items[Math.floor(MAXX/2)][MAXY-1]=createObject(OHOMEENTRANCE)),e==MAXLEVEL&&fillroom(OVOLUP,0),0<e&&e!=DBOTTOM&&e!=VBOTTOM&&fillroom(OSTAIRSDOWN,0),1<e&&(ULARN&&e==MAXLEVEL||e!=MAXLEVEL)&&fillroom(OSTAIRSUP,0),ULARN&&(3<e&&e!=DBOTTOM&&e!=MAXLEVEL&&e!=VBOTTOM&&createArtifact(OELEVATORUP,player.ELEVUP,85<rnd(100)),0<e&&(e<=DBOTTOM-5||e==DBOTTOM||e==VBOTTOM)&&createArtifact(OELEVATORDOWN,player.ELEVDOWN,85<rnd(100))),fillmroom(rund(3),OBOOK,e),fillmroom(rund(3),OALTAR,0),fillmroom(rund(3),OSTATUE,0),fillmroom(rund(3),OFOUNTAIN,0),fillmroom(rund(2),OTHRONE,0),fillmroom(rund(2),OMIRROR,0),fillmroom(rund(3),OCOOKIE,0),ULARN&&MAXLEVEL+MAXVLEVEL-3<=e&&(fillroom(OPIT,0),fillroom(OIVTRAPDOOR,0)),fillmroom(rund(3),OPIT,0),(ULARN||e!=DBOTTOM&&e!=VBOTTOM)&&fillmroom(rund(2),OIVTRAPDOOR,0),fillmroom(rund(2),OTRAPARROWIV,0),fillmroom(rnd(3)-2,OIVDARTRAP,0),fillmroom(rnd(3)-2,OIVTELETRAP,0),fillmroom(1==e?1:rund(2),OCHEST,e),e<MAXLEVEL&&(fillmroom(rund(2),ODIAMOND,rnd(10*e+1)+10),fillmroom(rund(2),ORUBY,rnd(6*e+1)+6),fillmroom(rund(2),OEMERALD,rnd(4*e+1)+4),fillmroom(rund(2),OSAPPHIRE,rnd(3*e+1)+2)),t=0;t<rnd(4)+3;t++)fillroom(OPOTION,newpotion());for(t=0;t<rnd(5)+3;t++)fillroom(OSCROLL,newscroll());for(t=0;t<rnd(12)+11;t++)fillroom(OGOLDPILE,12*rnd(e+1)+(e<<3)+10);e==(ULARN?8:5)&&fillroom(OBANK2,0),ULARN&&4<=e&&createArtifact(OPAD,player.PAD,75<rnd(100)),froom(2,ORING,0),froom(1,OSTUDLEATHER,0),froom(3,OSPLINT,0),froom(5,OSHIELD,rund(3)),froom(2,OBATTLEAXE,rund(3)),froom(5,OLONGSWORD,rund(3)),froom(5,OFLAIL,rund(3)),froom(7,OSPEAR,rnd(5)),froom(4,OREGENRING,rund(3)),froom(1,OPROTRING,rund(3)),froom(2,OSTRRING,1+rnd(3)),froom(2,ORINGOFEXTRA,0),ULARN?(a=!1,a|=createArtifact(OBRASSLAMP,player.LAMP,rnd(120)<8),a|=createArtifact(OWWAND,player.WAND,!a&&rnd(120)<8),a|=createArtifact(OORBOFDRAGON,player.SLAYING,!a&&rnd(120)<8),a|=createArtifact(OSPIRITSCARAB,player.NEGATESPIRIT,!a&&rnd(120)<8),a|=createArtifact(OCUBEofUNDEAD,player.CUBEofUNDEAD,!a&&rnd(120)<8),a|=createArtifact(ONOTHEFT,player.NOTHEFT,!a&&rnd(120)<8),a|=createArtifact(OSWORDofSLASHING,player.SLASH,!a&&rnd(120)<8),a|=createArtifact(OHAMMER,player.BESSMANN,!a&&rnd(120)<8),a|=createArtifact(OSPHTALISMAN,player.TALISMAN,!a&&rnd(120)<8),a|=createArtifact(OHANDofFEAR,player.HAND,!a&&rnd(120)<8),a|=createArtifact(OORB,player.ORB,!a&&rnd(120)<8),a|=createArtifact(OELVENCHAIN,player.ELVEN,!a&&rnd(120)<8),a|=createArtifact(OSLAYER,player.SLAY,!a&&10<=e&&rnd(100)>85-(e-10)),a|=createArtifact(OVORPAL,player.VORPAL,!a&&rnd(120)<8),a|=createArtifact(OPSTAFF,player.STAFF,!a&&8<=e&&rnd(100)>85-(e-10)),a|=createArtifact(OLIFEPRESERVER,player.PRESERVER,!a&&5<=e&&rnd(120)<8)):(createArtifact(OORBOFDRAGON,player.SLAYING,rnd(151)<3),createArtifact(OSPIRITSCARAB,player.NEGATESPIRIT,rnd(151)<4),createArtifact(OCUBEofUNDEAD,player.CUBEofUNDEAD,rnd(151)<4),createArtifact(ONOTHEFT,player.NOTHEFT,rnd(151)<3),createArtifact(OSWORDofSLASHING,player.SLASH,rnd(151)<2),createArtifact(OHAMMER,player.BESSMANN,rnd(151)<4)),(getDifficulty()<3||3==rnd(4))&&3<e&&(froom(3,OSWORD,rund(6)),froom(5,O2SWORD,rnd(6)),froom(3,OBELT,rund(7)),froom(3,OENERGYRING,rund(6)),froom(4,OPLATE,rund(8)),ULARN||froom(3,OCLEVERRING,1+rnd(2)))}function createArtifact(e,t,a){var r=!1;if(!t&&a&&(e=fillroom(e),r=!0,debug("created ".concat(e," on ").concat(level))),r){switch(e.id){case OBRASSLAMP.id:player.LAMP=!0;break;case OWWAND.id:player.WAND=!0;break;case OORBOFDRAGON.id:player.SLAYING=!0;break;case OSPIRITSCARAB.id:player.NEGATESPIRIT=!0;break;case OCUBEofUNDEAD.id:player.CUBEofUNDEAD=!0;break;case ONOTHEFT.id:player.NOTHEFT=!0;break;case OSPHTALISMAN.id:player.TALISMAN=!0;break;case OHANDofFEAR.id:player.HAND=!0;break;case OORB.id:player.ORB=!0;break;case OELVENCHAIN.id:player.ELVEN=!0;break;case OSWORDofSLASHING.id:player.SLASH=!0;break;case OHAMMER.id:player.BESSMANN=!0;break;case OSLAYER.id:player.SLAY=!0;break;case OVORPAL.id:player.VORPAL=!0;break;case OPSTAFF.id:player.STAFF=!0;break;case OLIFEPRESERVER.id:player.PRESERVER=!0;break;case OPAD.id:player.PAD=!0;break;case OELEVATORUP.id:player.ELEVUP=!0;break;case OELEVATORDOWN.id:player.ELEVDOWN=!0;break;default:debug("unidentified artifact created: ".concat(e))}return r}}function fillmroom(e,t,a){for(var r=0;r<e;r++)fillroom(t,a)}function froom(e,t,a){rnd(151)<e&&fillroom(t,a)}function fillroom(e,t){for(var a=100,r=rnd(MAXX-2),o=rnd(MAXY-2);!itemAt(r,o).matches(OEMPTY);)if(r+=rnd(3)-2,o+=rnd(3)-2,(r=r>MAXX-2?1:r)<1&&(r=MAXX-2),(o=o>MAXY-2?1:o)<1&&(o=MAXY-2),0==a--){debug("fillroom: SAFETY!");break}t=createObject(e,t);return setItem(r,o,t),t}function fillmonst(e,t){for(var a=createMonster(e),r=10;0<r;--r){var o=rnd(MAXX-2),n=rnd(MAXY-2);if(itemAt(o,n).matches(OEMPTY)&&!player.level.monsters[o][n]&&(player.x!=o||player.y!=n))return player.level.monsters[o][n]=a,t&&(a.awake=t),player.level.know[o][n]&=~KNOWHERE,a}return null}function sethp(e){if(0!=level){var t=e?rnd(12)+2+(level>>1):1+(level>>1);for(let e=0;e<t;e++)fillmonst(makemonst(level));if(ULARN&&e&&!DEBUG_NO_MONSTERS){var a=0;if(MAXLEVEL-5<=level&&level<MAXLEVEL){a=level-10;for(let e=1;e<=a;e++)fillmonst(DEMONLORD+rund(7))||e--}else if(MAXLEVEL<=level){a=level-MAXLEVEL+1;for(let e=1;e<=a;e++)fillmonst(DEMONPRINCE)||e--}}}else player.TELEFLAG=0}function checkgen(){for(var e=0;e<MAXY;e++)for(var t=0;t<MAXX;t++){var a=player.level.monsters[t][e];a&&isGenocided(a.arg)&&(player.level.monsters[t][e]=null)}}const LOG_SIZE=5,LOG_SAVE_SIZE=20,MAXINVEN=26,MAXX=67,MAXY=17,TAXRATE=.05,MAXPLEVEL=100,LEVELNAMES=[],MEG=1e6,SKILL=[0,10,20,40,80,160,320,640,1280,2560,5120,10240,20480,40960,1e5,2e5,4e5,7e5,+MEG,2*MEG,3*MEG,4*MEG,5*MEG,6*MEG,8*MEG,10*MEG,12*MEG,14*MEG,16*MEG,18*MEG,20*MEG,22*MEG,24*MEG,26*MEG,28*MEG,30*MEG,32*MEG,34*MEG,36*MEG,38*MEG,40*MEG,42*MEG,44*MEG,46*MEG,48*MEG,50*MEG,52*MEG,54*MEG,56*MEG,58*MEG,60*MEG,62*MEG,64*MEG,66*MEG,68*MEG,70*MEG,72*MEG,74*MEG,76*MEG,78*MEG,80*MEG,82*MEG,84*MEG,86*MEG,88*MEG,90*MEG,92*MEG,94*MEG,96*MEG,98*MEG,100*MEG,105*MEG,110*MEG,115*MEG,120*MEG,125*MEG,130*MEG,135*MEG,140*MEG,145*MEG,150*MEG,155*MEG,160*MEG,165*MEG,170*MEG,175*MEG,180*MEG,185*MEG,190*MEG,195*MEG,200*MEG,210*MEG,220*MEG,230*MEG,240*MEG,250*MEG,260*MEG,270*MEG,280*MEG,290*MEG,300*MEG,320*MEG,340*MEG,370*MEG],CLASSES=["novice explorer","apprentice explorer","practiced explorer","expert explorer","novice adventurer","adventurer","apprentice conjurer","conjurer","master conjurer","apprentice mage","mage","experienced mage","master mage","apprentice warlord","novice warlord","expert warlord","master warlord","apprentice gorgon","gorgon","practiced gorgon","master gorgon","demi-gorgon","evil master","great evil master","great evil master","mighty evil master","mighty evil master","mighty evil master","mighty evil master","mighty evil master","mighty evil master","mighty evil master","mighty evil master","mighty evil master","mighty evil master","mighty evil master","mighty evil master","mighty evil master","mighty evil master","apprentice demi-god","apprentice demi-god","apprentice demi-god","apprentice demi-god","apprentice demi-god","apprentice demi-god","apprentice demi-god","apprentice demi-god","apprentice demi-god","minor demi-god","minor demi-god","minor demi-god","minor demi-god","minor demi-god","minor demi-god","minor demi-god","minor demi-god","minor demi-god","major demi-god","major demi-god","major demi-god","major demi-god","major demi-god","major demi-god","major demi-god","major demi-god","major demi-god","minor deity","minor deity","minor deity","minor deity","minor deity","minor deity","minor deity","minor deity","minor deity","major deity","major deity","major deity","major deity","major deity","major deity","major deity","major deity","major deity","novice guardian","novice guardian","novice guardian","apprentice guardian","apprentice guardian","apprentice guardian","apprentice guardian","apprentice guardian","apprentice guardian","earth guardian","air guardian","fire guardian","water guardian","time guardian","ethereal guardian","The Creator","The Creator","The Creator"],DIED_ANNIHILATED_SELF=258,DIED_ARROW=259,DIED_DART=260,DIED_PIT=261,DIED_BOTTOMLESS_PIT=262,DIED_SOLID_ROCK=264,DIED_FAILED=269,DIED_WAYWARD_FINGER=270,DIED_BOTTOMLESS_TRAPDOOR=271,DIED_TRAPDOOR=272,DIED_BAD_WATER=273,DIED_ELECTRIC_SHOCK=274,DIED_VOLCANO_SLIP=275,DIED_DEMON=277,DIED_OWN_MAGIC=278,DIED_UNSEEN_ATTACKER=279,DIED_DREADFUL_SLEEP=280,DIED_EXPLODING_CHEST=281,DIED_ANNIHILATED=283,DIED_GENIE=286,DIED_BOTTOMLESS_ELEVATOR=287,DIED_SAVED_GAME=299,DIED_QUITTER=300,DIED_WINNER=301;let DEATH_REASONS=new Map([[DIED_ANNIHILATED_SELF,"self - annihilated"],[DIED_ARROW,"shot by an arrow"],[DIED_DART,"hit by a dart"],[DIED_PIT,"fell into a pit"],[DIED_BOTTOMLESS_PIT,"fell into a bottomless pit"],[DIED_SOLID_ROCK,"trapped in solid rock"],[DIED_FAILED,"failed"],[DIED_WAYWARD_FINGER,"erased by a wayward finger"],[DIED_BOTTOMLESS_TRAPDOOR,"fell through a bottomless trap door"],[DIED_TRAPDOOR,"fell through a trap door"],[DIED_BAD_WATER,"drank some poisonous water"],[DIED_ELECTRIC_SHOCK,"fried by an electric shock"],[DIED_VOLCANO_SLIP,"slipped in a volcano shaft"],[DIED_DEMON,"attacked by a revolting demon"],[DIED_OWN_MAGIC,"hit by own magic"],[DIED_UNSEEN_ATTACKER,"demolished by an unseen attacker"],[DIED_DREADFUL_SLEEP,"fell into the dreadful sleep"],[DIED_EXPLODING_CHEST,"killed by an exploding chest"],[DIED_ANNIHILATED,"annihilated in a sphere"],[DIED_GENIE,"wasted by a pissed off genie"],[DIED_BOTTOMLESS_ELEVATOR,"took an elevator straight to HELL"],[DIED_SAVED_GAME,"died in a savegame mishap"],[DIED_QUITTER,"a quitter"],[DIED_WINNER,"a winner"]]);const SCROLL_PROBABILITY=[0,0,0,0,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,4,4,4,5,5,5,5,5,6,6,6,6,6,7,7,7,7,8,8,8,9,9,9,9,10,10,10,10,11,11,11,12,12,12,13,13,13,13,14,14,15,15,16,16,16,17,17,18,18,19,19,19,20,20,20,20,21,22,22,22,23],POTION_PROBABILITY=[0,0,1,1,1,2,3,3,4,4,5,5,6,6,7,7,8,9,9,9,10,10,10,11,11,12,12,13,14,15,16,17,18,19,19,19,20,20,22,22,23,23],SCROLL_NAMES=["enchant armor","enchant weapon","enlightenment","blank paper","create monster","create artifact","aggravate monsters","time warp","teleportation","expanded awareness","haste monsters","monster healing","spirit protection","undead protection","stealth","magic mapping","hold monsters","gem perfection","spell extension","identify","remove curse","annihilation","pulverization","life protection"],POTION_NAMES=["sleep","healing","raise level","increase ability","wisdom","strength","raise charisma","dizziness","learning","object detection","monster detection","forgetfulness","water","blindness","confusion","heroism","sturdiness","giant strength","fire resistance","treasure finding","instant healing","cure dianthroritis","poison","see invisible"],COMMON_FORTUNES=["Sitting down can have unexpected results","Don't pry into the affairs of others","Drinking can be hazardous to your health","Beware of the gusher!","Some monsters are greedy","Nymphs have light fingers","Try kissing a disenchantress!","Hammers and brains don't mix","What does a potion of cure dianthroritis taste like?","Hit point gain/loss when raising a level depends on constitution","Be sure to pay your taxes","Some dragons can fly","Dost thou strive for perfection?","Patience is a virtue, unless your daughter dies","A level 25 player casts like crazy!","Difficulty affects regeneration","Control of the pesky spirits is most helpful","Don't fall into a bottomless pit","Dexterity allows you to carry more","You can get 2 points of WC for the price of one","Never enter the dungeon naked! The monsters will laugh at you!","Did someone put itching powder in your armor?","Avoid opening doors. You never know what's on the other side.","The greatest weapon in the game has not the highest Weapon Class","Identify things before you use them","There's more than one way through a wall"],LARN_FORTUNES=["Gem value = gem * 2 ^ perfection","The Eye of Larn improves with time","Healing a mighty wizard can be exhilarating","Are Vampires afraid of something?","What does the Eye of Larn see in its guardian?","Energy rings affect spell regeneration","My, aren't you clever!","You klutz!","Infinite regeneration ---\x3e temptation","You can't buy the most powerful scroll"],ULARN_FORTUNES=["A perfect gem is twice as beautiful","Ask the genie","Are monsters afraid of something?","What can the Eye of Larn see for its guardian?","Spells not regenerating?  You need more energy","Watch out for trap doors","Take the express","The most powerful scroll isn't for sale","Try Dealer McDope's for all your recreational needs!","Who is tougher than a demon prince?","Slayer has a grudge","Wonderful wands prevent you from falling","It is said that the king is never far from his throne"],ESC="escape",ENTER="return",SPACE="space",TAB="tab",DEL="backspace",CAPS="CAPS";var blocking_callback,keyboard_input_callback,UPPERCASE=!1;function mousetrap(e,t){return(t=t==SPACE?" ":t)==TAB||mainloop(e,t),!1}function setCharCallback(e){blocking_callback=e,nomove=1}function setTextCallback(e){blocking_callback=getTextInput,keyboard_input_callback=e}function setNumberCallback(e,t){blocking_callback=t?getNumberOrAsterisk:getNumberInput,keyboard_input_callback=e}function shouldRun(e,t){return!!e&&e.shift}function parseDirectionKeys(e){var t=0;return 7==e||"y"==e||"Y"==e||0<=e.indexOf("home")?t=6:9==e||"u"==e||"U"==e||0<=e.indexOf("pageup")?t=5:8==e||"k"==e||"K"==e||0<=e.indexOf("up")?t=3:4==e||"h"==e||"H"==e||0<=e.indexOf("left")?t=4:6==e||"l"==e||"L"==e||0<=e.indexOf("right")?t=2:1==e||"b"==e||"B"==e||0<=e.indexOf("end")?t=8:3==e||"n"==e||"N"==e||0<=e.indexOf("pagedown")?t=7:(2==e||"j"==e||"J"==e||0<=e.indexOf("down"))&&(t=1),t}function parse(e,t){if(t==CAPS)return nomove=1,void(UPPERCASE=!UPPERCASE);if(blocking_callback){var a=blocking_callback,r=blocking_callback(t);return Promise.resolve(r)==r?void debug("parse: ispromise"):(a==blocking_callback&&r&&(blocking_callback=null),void(r||(nomove=1)))}if(player){a=itemAt(player.x,player.y),r=parseDirectionKeys(t);if(0<r)(shouldRun(e,t)?run:moveplayer)(r);else if("."!=t&&"5"!=t)if("c"!=t)if("d"!=t){if("e"!=t)if("f"!=t){if("g"==t)return nomove=1,void updateLog("The stuff you are carrying presently weighs ".concat(Math.round(packweight())," pounds"));if("i"!=t){if("o"!=t&&"O"!=t)if("p"!=t)if("q"!=t)if("r"!=t)if("s"!=t)if("t"!=t&&","!=t){if("v"==t){nomove=1;r=ULARN?"The Addiction of JS Ularn":"JS Larn";return updateLog("".concat(r,", Version ").concat(VERSION," Build ").concat(BUILD)),updateLog("  ".concat(logname)),ULARN&&appendLog(", ".concat(player.char_picked)),ULARN&&appendLog(", ".concat(player.gender)),appendLog(", Difficulty ".concat(getDifficulty())),debug_used&&updateLog("  Debug"),wizard&&updateLog("  Wizard"),void(cheat&&updateLog("  Cheater"))}if("w"!=t)if("z"==t&&loadScores(null,!0,!(nomove=1)),"A"!=t){if("C"==t)return 0==player.TIMESTOP?0<player.CONFUSE?(updateLog("You're too confused!"),void beep()):a.matches(OOPENDOOR)?void close_something(0):(nearPlayer(OOPENDOOR)?prepare_direction_event(close_something):updateLog("There is nothing to close!"),void(dropflag=1)):void 0;if("D"!=t)if("E"!=t&&"e"!=t&&t!=ENTER){if("I"==t)return seemagic(!(nomove=1)),void setCharCallback(parse_see_all);if("P"==t)return nomove=1,void updateLog((0<outstanding_taxes?"You presently owe ".concat(outstanding_taxes," gold pieces in taxes"):"You do not owe any taxes").concat(period));if("Q"==t)return nomove=1,setCharCallback(parseQuit),void updateLog("Do you really want to quit (all progress will be lost) [<b>y</b>/<b>n</b>] ? ");if("R"!=t){if("S"==t)return nomove=1,void(saveGame()&&died(DIED_SAVED_GAME,!1));if("T"!=t)if("W"!=t)if("V"!=t){if("Z"==t)return 9<player.LEVEL?void(0==player.TIMESTOP&&oteleport(1)):(cursors(),void updateLog("As yet, you don't have enough experience to use teleportation".concat(period)));if("<"!=t){if(">"==t)return DEBUG_STAIRS_EVERYWHERE&&!a.matches(OVOLDOWN)&&level!=DBOTTOM&&level!=VBOTTOM?void newcavelevel(level+1):void(0==player.TIMESTOP&&down_stairs());if("^"!=t){if(":"!=t){if("?"==t)return nomove=1,currentpage=0,setCharCallback(parse_help),void print_help();if("!"==t)return nomove=1,keyboard_hints=!keyboard_hints,updateLog("Keyboard hints: ".concat(keyboard_hints?"on":"off")),void(keyboard_hints&&lookforobject(!0,!1));if("@"==t)return nomove=1,auto_pickup=!auto_pickup,void updateLog("Auto-pickup: ".concat(auto_pickup?"on":"off"));if("#"==t)return nomove=1,side_inventory=!side_inventory,updateLog("Inventory view: ".concat(side_inventory?"on":"off")),void setMode(amiga_mode,retro_mode,original_objects);if("$"==t)return nomove=1,show_color=!show_color,void updateLog("Colors: ".concat(show_color?"on":"off"));if("}"==t)return nomove=1,original_objects&&!amiga_mode?(original_objects=!1,updateLog("Switching to Hack mode")):original_objects||amiga_mode?(original_objects=!(amiga_mode=!1),updateLog("Switching to Classic mode")):(original_objects=amiga_mode=!0,updateLog("Switching to Amiga mode")),void setMode(amiga_mode,retro_mode,original_objects);if("{"!=t)return"%"==t?(nomove=1,bold_objects=!bold_objects,void updateLog("Bold objects: ".concat(bold_objects?"on":"off"))):"_"==t?(nomove=1,updateLog("Enter Password: "),void setTextCallback(wizardmode)):void(nomove=1);{nomove=1,localStorageSetObject("retro",retro_mode=!retro_mode);let e=amiga_mode?retro_mode?"Amiga 500":"Amiga 1200":retro_mode?"DOS":"Modern";return updateLog("Font: ".concat(e)),void setMode(amiga_mode,retro_mode,original_objects)}}lookforobject(!0,!(nomove=1))}else{for(var o=0,n=vy(player.y-1);n<=vy(player.y+1);n++)for(var i=vx(player.x-1);i<=vx(player.x+1);i++){var l=itemAt(i,n);switch(l.id){case OTRAPDOOR.id:case ODARTRAP.id:case OTRAPARROW.id:case OTELEPORTER.id:case OPIT.id:case OELEVATORUP.id:case OELEVATORDOWN.id:updateLog("It's ".concat(l).concat(period)),o++}}0==o&&updateLog("No traps are visible".concat(period))}}else{if(DEBUG_STAIRS_EVERYWHERE){if(level==MAXLEVEL)return void newcavelevel(0);if(0!=level)return void newcavelevel(level-1)}0==player.TIMESTOP&&up_stairs()}}else updateLog("Conducts observed: ".concat(player.getConductString(!0)));else a.isArmor()?wear(a):(updateLog("What do you want to wear (-) for nothing [<b>space</b> to view] ? "),setCharCallback(wear));else player.SHIELD?(player.SHIELD=null,updateLog("Your shield is off".concat(period))):player.WEAR?(player.WEAR=null,updateLog("Your armor is off".concat(period))):updateLog("You aren't wearing anything".concat(period))}else 0==player.TIMESTOP&&((a.matches(OBRASSLAMP)?act_rub_lamp:remove_gems)(),dropflag=1)}else 0==player.TIMESTOP&&enter();else 0==player.TIMESTOP&&(drink_fountain(null),dropflag=1)}else 0==player.TIMESTOP&&(desecrate_altar(),dropflag=1);else a.isWeapon()?wield(a):(updateLog("What do you want to wield (-) for nothing [<b>space</b> to view] ? "),setCharCallback(wield))}else 0==player.TIMESTOP&&lookforobject(!1,!0);else 0==player.TIMESTOP&&(a.matches(OSPEED)?(doSpeed(),forget()):a.matches(OHASH)?(smokeHash(),forget()):a.matches(OCOKE)?(doCoke(),forget()):(sit_on_throne(),dropflag=1));else 0<player.BLINDCOUNT?(cursors(),updateLog("You can't read anything when you're blind!"),dropflag=1):0==player.TIMESTOP&&(a.matches(OBOOK)?(readbook(a),forget()):a.matches(OSCROLL)?(forget(),read_scroll(a)):(updateLog("What do you want to read [<b>space</b> to view] ? "),setCharCallback(act_read_something)));else 0==player.TIMESTOP&&(a.matches(OPOTION)?(forget(),quaffpotion(a,!0)):(updateLog("What do you want to quaff [<b>space</b> to view] ? "),setCharCallback(act_quaffpotion)));else 0==player.TIMESTOP&&(pray_at_altar(),prayed=dropflag=1);else if(0==player.TIMESTOP){if(0<player.CONFUSE)return updateLog("You're too confused!"),void beep();if(a.matches(OCHEST))return act_open_chest(player.x,player.y),void(dropflag=1);nearPlayer(OCLOSEDDOOR)||nearPlayer(OCHEST)?prepare_direction_event(open_something):updateLog("There is nothing to open!"),dropflag=1}}else showinventory(!(nomove=1),parse_inventory,showall,!0,!0,!0)}else 0==player.TIMESTOP&&(wash_fountain(null),dropflag=1);else if(0==player.TIMESTOP){if(a.isStore())return void enter();a.matches(OCOOKIE)?(outfortune(),forget()):a.matches(OSHROOMS)?(eatShrooms(),forget()):a.matches(OACID)?(dropAcid(),forget()):(updateLog("What do you want to eat [<b>space</b> to view] ? "),setCharCallback(act_eatcookie))}}else 0==player.TIMESTOP&&(updateLog("What do you want to drop [<b>space</b> to view] ? "),setCharCallback(drop_object));else pre_cast();else viewflag=1}}function parseQuit(e){return nomove=1,e==ESC||"n"==e||"N"==e?(appendLog(" no".concat(period)),1):"y"==e||"Y"==e?(appendLog(" yes".concat(period)),died(DIED_QUITTER,!1),1):0}Mousetrap.prototype.handleKey=function(e,t,a){a.shift="shift"===t[0];return this._handleKey.apply(this,arguments)};var LAST_MOUSE_BUTTON,MOUSE_DOWN_EVENT,BUTTONS="",BUTTON_SPACE=createButton(" ","space"),BUTTON_DEL=createButton(DEL,"del"),BUTTON_CAPS=createButton(CAPS,"caps"),BUTTON_HELP=createButton("?","Help"),BUTTON_WIELD=createButton("w","wield"),BUTTON_WEAR=createButton("W","wear"),BUTTON_QUAFF=createButton("q","quaff"),BUTTON_READ=createButton("r","read"),BUTTON_CAST=createButton("c","cast"),BUTTON_INVENTORY=createButton("i","inventory"),BUTTON_INVENTORY_FULL=createButton("I","known items"),BUTTON_TELEPORT=createButton("Z","teleport"),BUTTON_EAT=createButton("E","eat"),BUTTON_TAKEOFF=createButton("T","remove armor"),BUTTON_AUTOPICKUP=createButton("@","auto-pickup"),BUTTON_PACKWEIGHT=createButton("g","pack weight"),BUTTON_VERSION=createButton("v","version"),BUTTON_SCORES=createButton("z","scores"),BUTTON_TAXES=createButton("P","taxes"),BUTTON_QUIT=createButton("Q","quit"),BUTTON_SAVE=createButton("S","save game"),BUTTON_MODE=createButton("}","mode"),BUTTON_TAKE=createButton("t","pick up"),BUTTON_DROP=createButton("d","drop"),BUTTON_OPEN=createButton("o","open"),BUTTON_CLOSE=createButton("C","close"),BUTTON_TRAPS=createButton("^","identify trap"),BUTTON_ENTER=createButton("e","enter"),BUTTON_FOUNTAIN_TIDY=createButton("f","tidy up"),BUTTON_FOUNTAIN_DRINK=createButton("D","drink"),BUTTON_THRONE_PRY=createButton("R","pry gems"),BUTTON_THRONE_SIT=createButton("s","sit down"),BUTTON_ALTAR_PRAY=createButton("p","pray"),BUTTON_ALTAR_DESECRATE=createButton("A","desecrate"),BUTTON_UPSTAIRS=createButton("<","go up"),BUTTON_DOWNSTAIRS=createButton(">","go down"),BUTTON_UP_LEFT=createButton("y","↖","Y"),BUTTON_UP=createButton("k","↑","K"),BUTTON_UP_RIGHT=createButton("u","↗","U"),BUTTON_LEFT=createButton("h","←","H"),BUTTON_NOMOVE=createButton(".","."),BUTTON_RIGHT=createButton("l","→","L"),BUTTON_DOWN_LEFT=createButton("b","↙","B"),BUTTON_DOWN=createButton("j","↓","J"),BUTTON_DOWN_RIGHT=createButton("n","↘","N"),BUTTON_EXIT=createButton(ESC,"exit"),BUTTON_CANCEL=createButton(ESC,"cancel"),BUTTON_DEPOSIT=createButton("d","deposit"),BUTTON_WITHDRAW=createButton("w","withdraw"),BUTTON_SELL=createButton("s","sell"),BUTTON_PAY_TAXES=createButton("p","pay taxes"),BUTTON_YES=createButton("y","yes"),BUTTON_NO=createButton("n","no"),BUTTON_SPACE_ENDGAME=createVariableButton(" ","Congratulations! View Scoreboard");function is_touch_device(){return"ontouchstart"in window||navigator.maxTouchPoints}function createButton(e,t,a,r){var o;return a?is_touch_device()?(o="ontouchstart='larnmousedown(\"".concat(e,"\")' ontouchend='larnmouseup()'"),document.ontouchend=larnmouseup):(o="onmousedown='larnmousedown(\"".concat(e,"\")'"),document.onmouseup=larnmouseup):o="onclick='mousetrap(null, \"".concat(e,"\")'"),"<button class=".concat(r=r||"'button'"," ").concat(o,">").concat(t,"</button>")}function createNarrowButton(e,t,a){return createButton(e,t,!1,"narrowbutton")}function createVariableButton(e,t,a){return createButton(e,t,!1,"variablebutton")}var MOUSE_EVENTS=0;function larnmousedown(e){var t=e;mousetrap(null,t),MOUSE_DOWN_EVENT=setInterval(function(){4<MOUSE_EVENTS++&&mousetrap(null,t)},50)}function larnmouseup(){clearInterval(MOUSE_DOWN_EVENT),MOUSE_EVENTS=0}function addButton(e){BUTTONS+=" "+e}function newButtonRow(){BUTTONS+="<p>"}function setButtons(){if(game_started){var e,t,a,r,o,n;if(BUTTONS="",!mobile)return player&&mazeMode&&(addButton(BUTTON_HELP),e=keyboard_hints?"on":"off",t=auto_pickup?"on":"off",a=side_inventory?"on":"off",r=bold_objects?"on":"off",o=show_color?"on":"off",n=amiga_mode?retro_mode?"Amiga 500":"Amiga 1200":retro_mode?"DOS":"modern",addButton(createVariableButton("!","Keyboard hints: ".concat(e))),addButton(createVariableButton("@","Auto pickup: ".concat(t))),addButton(createVariableButton("#","Show inventory: ".concat(a))),addButton(createVariableButton("$","Show color: ".concat(o))),addButton(createVariableButton("%","Bold objects: ".concat(r))),addButton(createVariableButton("{","Font: ".concat(n)))),void setDiv("FOOTER",BUTTONS);if(!player)return keyboard_input_callback===setname&&(n=KEYBOARD_INPUT||logname,addButton(createVariableButton(ENTER,n)),newButtonRow(),keyboardButtons()),keyboard_input_callback===startgame&&(i=KEYBOARD_INPUT||getDifficulty(),addButton(createButton(ENTER,i)),newButtonRow(),numberButtons(),newButtonRow(),addButton(BUTTON_DEL)),void setDiv("FOOTER",BUTTONS);if(keyboard_input_callback===act_donation_pray)return numberButtons(),void setDiv("FOOTER",BUTTONS);var i=itemAt(player.x,player.y);if(mazeMode){if(movementButtons(),newButtonRow(),0<player.SPELLS&&null==newSpellCode&&addButton(BUTTON_CAST),null!=newSpellCode){for(spellIndex=0;spellIndex<player.knownSpells.length;spellIndex++)player.knownSpells[spellIndex]&&(spellIndex%5==0&&newButtonRow(),addButton(createButton(spelcode[spellIndex],spelname[spellIndex])));newButtonRow(),addButton(createButton(ESC,"cancel")),newButtonRow()}inventoryButtons(drop_object,showall),inventoryButtons(act_quaffpotion,showquaff),inventoryButtons(act_read_something,showread),inventoryButtons(act_eatcookie,showeat),inventoryButtons(wear,showwear),inventoryButtons(wield,showwield),addButton(BUTTON_QUAFF),addButton(BUTTON_READ),addButton(BUTTON_WIELD),addButton(BUTTON_WEAR),newButtonRow(),addButton(BUTTON_INVENTORY),addButton(BUTTON_EAT),addButton(BUTTON_TELEPORT),i.isStore()&&addButton(BUTTON_ENTER),i.isWeapon(),i.isArmor(),i.matches(OPOTION),i.matches(OBOOK)||i.matches(OSCROLL),i.matches(OCOOKIE),i.matches(OFOUNTAIN)&&(addButton(BUTTON_FOUNTAIN_DRINK),addButton(BUTTON_FOUNTAIN_TIDY)),i.matches(OTHRONE)&&(addButton(BUTTON_THRONE_PRY),addButton(BUTTON_THRONE_SIT)),i.matches(ODEADTHRONE)&&addButton(BUTTON_THRONE_SIT),i.matches(OALTAR)&&(addButton(BUTTON_ALTAR_PRAY),addButton(BUTTON_ALTAR_DESECRATE)),i.matches(OSTAIRSUP)&&addButton(BUTTON_UPSTAIRS),i.matches(OSTAIRSDOWN)&&addButton(BUTTON_DOWNSTAIRS),canTake(i)&&!pocketfull()&&addButton(BUTTON_TAKE),i.matches(OEMPTY)&&addButton(BUTTON_DROP),(nearPlayer(OCLOSEDDOOR)||nearPlayer(OCHEST))&&addButton(BUTTON_OPEN),nearPlayer(OOPENDOOR)&&addButton(BUTTON_CLOSE)}else{if(keyboard_input_callback&&console.log("kbd",keyboard_input_callback.name),blocking_callback&&console.log("callback",blocking_callback.name),(i.matches(OBANK)||i.matches(OBANK2))&&(blocking_callback===bank_parse&&(addButton(BUTTON_DEPOSIT),addButton(BUTTON_WITHDRAW),addButton(BUTTON_SELL)),keyboard_input_callback===bank_deposit&&(addButton(createButton(ENTER,"deposit ".concat(KEYBOARD_INPUT))),addButton(createButton("*","deposit all")),addButton(BUTTON_CANCEL),newButtonRow(),numberButtons()),keyboard_input_callback===bank_withdraw&&(addButton(createButton(ENTER,"withdraw ".concat(KEYBOARD_INPUT))),addButton(createButton("*","withdraw all")),addButton(BUTTON_CANCEL),newButtonRow(),numberButtons()),blocking_callback===bank_sell&&(addButton(BUTTON_CANCEL),addButton(createButton("*","sell all")),newButtonRow(),alphaButtons(!1)),newButtonRow()),i.matches(OLRS)&&(blocking_callback===parse_lrs?addButton(BUTTON_PAY_TAXES):keyboard_input_callback===parse_lrs_pay&&(addButton(createButton(ENTER,"pay ".concat(KEYBOARD_INPUT))),addButton(BUTTON_CANCEL),newButtonRow(),numberButtons())),i.matches(ODNDSTORE)&&blocking_callback===dnd_parse&&alphaButtons(!1),i.matches(OSCHOOL)&&blocking_callback===parse_class&&alphaButtons(!1,8),i.matches(OTRADEPOST)){if(blocking_callback===parse_tradepost)for(var l,s=0,c=0;c<player.inventory.length;c++)null!=player.inventory[c]&&(addButton(createNarrowButton(l=getCharFromIndex(c),l)),13==++s&&newButtonRow());blocking_callback===parse_sellitem&&(addButton(BUTTON_YES),addButton(BUTTON_NO))}newButtonRow(),addButton(BUTTON_EXIT)}""===BUTTONS&&addButton(BUTTON_SCORES),setDiv("FOOTER",BUTTONS)}}function inventoryButtons(e,t){if(blocking_callback===e){console.log(e.name),newButtonRow();var a=showinventory(!1,e,t,!1,!1,!1);for(i=0;i<a.length;i++){newButtonRow();var r=a[i];addButton(createVariableButton(r[0],r[1])),newButtonRow()}addButton(createButton(ESC,"cancel")),newButtonRow()}}function movementButtons(){addButton(BUTTON_UP_LEFT),addButton(BUTTON_UP),addButton(BUTTON_UP_RIGHT),newButtonRow(),addButton(BUTTON_LEFT),addButton(BUTTON_NOMOVE),addButton(BUTTON_RIGHT),newButtonRow(),addButton(BUTTON_DOWN_LEFT),addButton(BUTTON_DOWN),addButton(BUTTON_DOWN_RIGHT)}function numberButtons(){for(var e=1;e<10;e++)addButton(createNarrowButton(e,e));addButton(createNarrowButton(0,0))}function alphaButtons(e,t){t=t||26;for(var a=e?"A":"a",r=1;r<=t;r++,a=a.nextChar())addButton(createNarrowButton(a,a)),r%13==0&&newButtonRow()}function keyboardButtons(){alphaButtons(UPPERCASE),addButton(BUTTON_CAPS),addButton(BUTTON_SPACE),addButton(BUTTON_DEL)}var scoreBoard=[];const EXTRA_VERSION=0,EXTRA_BUILD=1,EXTRA_RMST=2,EXTRA_GTIME=3;var LocalScore=function(){this.createdAt=Date.now(),this.winner=lastmonst==DIED_WINNER;var e=this.winner?1e5*getDifficulty():0;this.who=logname,this.gender=player?player.gender:"Male",this.character=player?player.char_picked:"Adventurer",this.hardlev=getDifficulty(),this.score=player?player.GOLD+player.BANKACCOUNT+e:0,this.timeused=Math.floor(gtime/100),this.what=getWhyDead(lastmonst),this.level=LEVELNAMES[level],this.playerID=playerID,this.playerIP=playerIP,this.gameID=gameID+(dofs?"+":""),this.debug=debug_used,this.gamelog=LOG,this.extra=[],this.extra[EXTRA_VERSION]=VERSION,this.extra[EXTRA_BUILD]=BUILD,this.extra[EXTRA_RMST]=rmst,this.extra[EXTRA_GTIME]=gtime,this.explored="";for(var t=0;t<LEVELS.length;t++)this.explored+=LEVELS[t]?"".concat(LEVELNAMES[t]):".",this.explored+=t==level?"x":" ";player&&(e=player.level,player.level=null,this.player=JSON.stringify(player),player.level=e),this.browser="".concat(navigator.vendor," (").concat(navigator.userAgent,")")};function createLocalScore(){let e=new LocalScore;return e.gamelog=null,e.player=null,e.extra=null,e.browser=null,e.ularn=ULARN,e}function getStatString(t,e){if(!t)return"no info";var a,r="";if(e){try{let e=t.extra[EXTRA_BUILD];if(e&&(e=e.substr(0,3),481<=Number(e))){let e=window.location.href.split("?")[0];e=e.split("/larn.html")[0]+"/tv/?gameid=".concat(t.gameID.split("+")[0]),e="<b><a href='".concat(e,"'>Watch this game</a></b>"),r+="".concat(e,"\n\n")}}catch(e){}r+="Date: ".concat(new Date(t.createdAt),"\n")}return a=t.player.inventory?loadPlayer(t.player):loadPlayer(JSON.parse(t.player)),r+="Player: ".concat(t.who,"\n"),ULARN&&t.character&&(r+="Class:  ".concat(t.character,"\n")),r+="Diff:   ".concat(t.hardlev,"\n"),r+="Score:  ".concat(t.score,"\n"),r+="Mobuls: ".concat(t.timeused,"\n"),r+="Winner: ".concat(t.winner?"Yes":"No","\n"),t.winner||(r+="Fate: ".concat(t.what," on ").concat(t.level,"\n")),r+="\n".concat(debug_stats(a,t),"\n"),t.explored&&(r+="Levels Visited:\n".concat(t.explored,"\n\n")),t.gamelog&&((e=t.gamelog.join("\n").trim()).includes("Replay")&&!e.endsWith(">")&&(e+=">"),r+="Final Moments: \n".concat(e,"\n\n")),r+="Bottom Line:\n".concat(a.getStatString(t.level),"\n\n"),r+="Conducts observed:\n".concat(a.getConductString(),"\n\n"),t.debug&&(r+="Debug mode used!\n\n"),r}function isEqual(e,t){var a=!0;return a&=e.gameID==t.gameID,a&=e.who==t.who,a&=e.hardlev==t.hardlev,a&=e.winner==t.winner,a&=e.score==t.score,a&=e.timeused==t.timeused,a&=e.what==t.what,a&=e.level==t.level,a&=e.explored==t.explored,a&=e.debug==t.debug,a&=compareArrays(e.gamelog,t.gamelog),a&=JSON.stringify(e.player)==JSON.stringify(t.player)}function sortScore(e,t){return e||t?e?t?e.hardlev!=t.hardlev?t.hardlev-e.hardlev:e.winner?e.timeused!=t.timeused?e.timeused-t.timeused:t.score-e.score:e.score!=t.score?t.score-e.score:e.level!=t.level?t.level-e.level:t.timeused-e.timeused:1:-1:0}LocalScore.prototype.toString=function(){return getStatString(this)};var winners=[],losers=[],scoreIndex=0;const MAX_SCORES_PER_PAGE=18,MAX_SCORES_TO_READ=72,MIN_TIME_PLAYED=50,ENDPOINT="test";var endGameScore,ONLINE=!0;let A,R,O;function loadScores(e,t,a){A=amiga_mode,R=retro_mode,O=original_objects,amiga_mode=mazeMode=!1,clear(),lprcat("Loading Scoreboard...\n"),GAMEOVER&&detachDisplay(),dbQueryHighScores(e,t,a)}function dbQueryHighScores(o,n,i){var e;navigator.onLine?(e={FunctionName:ENDPOINT,Payload:'{ "gamename" : "'.concat(GAMENAME,'", "gameID" : "board" }'),InvocationType:"RequestResponse",LogType:"None"},lambda.invoke(e,function(e,t){var a=t?JSON.parse(t.Payload):null,r=a?a.statusCode:444;200==r?(a=JSON.parse(a.body),winners=a[0].slice(0,MAX_SCORES_TO_READ),console.log("loaded winners: ".concat(winners.length)),losers=a[1].slice(0,MAX_SCORES_TO_READ),console.log("loaded visitors: ".concat(losers.length)),showScores(o,!(ONLINE=!0),n,i,0)):404==r?(ONLINE=!"Couldn't find global scoreboard, showing local scoreboard",showLocalScoreBoard(o,n,i,0,"Couldn't find global scoreboard, showing local scoreboard")):(t=t?t.StatusCode:555,console.log("lambda error: lambda status=".concat(t," larn status=").concat(r)),e&&console.log(e,e.stack),ONLINE=!"Error loading global scoreboard, showing local scoreboard",showLocalScoreBoard(o,n,i,0,"Error loading global scoreboard, showing local scoreboard"))})):(ONLINE=!1,showLocalScoreBoard(o,n,i,0,"Offline: showing local scoreboard"))}function showLocalScoreBoard(e,t,a,r,o){showScores(e,!0,t,a,r),setDiv("STATS",o)}const WINNER_HEADER_LARN="     <b>Score   Difficulty   Winner                    Time Needed</b>                      ",WINNER_HEADER_ULARN="     <b>Score  Diff  Winner                   Class        Time Needed</b>                         ",VISITOR_HEADER_LARN="     <b>Score   Difficulty   Visitor                   Fate</b>                             ",VISITOR_HEADER_ULARN="     <b>Score  Diff  Visitor                  Class       Fate</b>                                 ";let bound_exitscores;function exitscores(e,t,a){if(a==ESC||a==ENTER)return scoreIndex=0,setMode(A,R,O),nomove=1,exitbuilding();" "==a&&(scoreIndex<winners.length?showScores(e,t,!0,!1,0):(showScores(e,t,!1,!0,winners.length),scoreIndex>=winners.length+losers.length&&(scoreIndex=0)))}function showScores(e,t,a,r,o){mazeMode=!1,GAMEOVER||clear(),t?(lprcat("                    <b>".concat(GAMENAME," Scoreboard</b> (Global scoreboard not available)\n\n")),winners=localStorageGetObject("winners",[]),losers=localStorageGetObject("losers",[])):lprcat(a&&!r?"                  <b>".concat(GAMENAME," Winners Scoreboard</b>\n\n"):"                  <b>".concat(GAMENAME,r&&!a?" Visitors Scoreboard</b> (Games > ":" Scoreboard</b> (Games > ").concat(MIN_TIME_PLAYED," mobuls)\n\n")),GAMEOVER&&(lprc("<b>This game</b> (Click score for more info)"),lprc("<hr>"),e.winner?printWithoutSpacesAtTheEnd(ULARN?WINNER_HEADER_ULARN:WINNER_HEADER_LARN):printWithoutSpacesAtTheEnd(ULARN?VISITOR_HEADER_ULARN:VISITOR_HEADER_LARN),lprc("\n"),printScore(e),lprc("<hr>\n")),0!=winners.length||0!=losers.length?(a&&(printScoreBoard(winners,e,ULARN?WINNER_HEADER_ULARN:WINNER_HEADER_LARN,printScore,o),lprc("\n")),r&&printScoreBoard(losers,e,ULARN?VISITOR_HEADER_ULARN:VISITOR_HEADER_LARN,printScore,o)):lprcat("\n  The scoreboard is empty"),cursor(1,23),GAMEOVER&&lprc("\n"),lprcat("                     Click on a score for more information\n"),GAMEOVER?lprcat("                 ----  Reload your browser to play again  ----"):(lprcat("             ----  Press <b>space</b> for next page, <b>escape</b> to exit  ----"),bound_exitscores=exitscores.bind(null,e,t),setCharCallback(bound_exitscores)),blt()}function printScore(e){let t;t=e.winner?(ULARN?"".concat(padString(Number(e.score).toLocaleString(),10),"  ").concat(padString(""+e.hardlev,4),"  ").concat(padString(e.who,-23),"  ").concat(padString(e.character,-10),"  "):"".concat(padString(Number(e.score).toLocaleString(),10),"   ").concat(padString(""+e.hardlev,10),"   ").concat(padString(e.who,-25))).concat(padString(""+e.timeused,5)," Mobuls"):(ULARN?"".concat(padString(Number(e.score).toLocaleString(),10),"  ").concat(padString(""+e.hardlev,4),"  ").concat(padString(e.who,-23),"  ").concat(padString(e.character,-10),"  "):"".concat(padString(Number(e.score).toLocaleString(),10),"   ").concat(padString(""+e.hardlev,10),"   ").concat(padString(e.who,-25)," ")).concat(e.what," on ").concat(e.level);var a=GAMEOVER?"<br>":"";lprc("<a href='javascript:dbQueryLoadGame(\"".concat(e.gameID,'", ').concat(!ONLINE,", ").concat(e.winner,")'>")),printWithoutSpacesAtTheEnd("".concat(t,"</a>").concat(a)),GAMEOVER||lprc("\n")}function printWithoutSpacesAtTheEnd(t){for(let e=0;e<Math.min(78,t.length);e++)lprc(t[e]);lprc(t.substr(78))}function printScoreBoard(e,t,a,r,o){printWithoutSpacesAtTheEnd(a),lprc("\n");for(var n=GAMEOVER?0:scoreIndex-o,i=0;n<e.length&&(GAMEOVER||!(++i>MAX_SCORES_PER_PAGE));n++,scoreIndex++){var l=e[n],s=!!t&&l.gameID==t.gameID;s&&lprc(START_BOLD),r(l),s&&lprc(END_BOLD)}}function dbQueryLoadGame(n,e,t){e?setDiv("STATS",getStatString(getHighScore(localStorageGetObject(t?"winners":"losers",[]),n))):(console.log("loading game: ".concat(n)),t={FunctionName:ENDPOINT,Payload:'{ "gamename" : "'.concat(GAMENAME,'", "gameID" : "').concat(n,'" }'),InvocationType:"RequestResponse",LogType:"None"},lambda.invoke(t,function(e,t){var a=t?JSON.parse(t.Payload):null,r=a?a.statusCode:666,o="";200==r?(ONLINE=!0,o=getStatString(JSON.parse(a.body),!0)):404==r?(o="Couldn't load game ".concat(n),console.log("larn status=".concat(r))):(t=t?t.StatusCode:777,console.log("lambda error: lambda status=".concat(t," larn status=").concat(r)),e&&console.log(e,e.stack),o="Couldn't load game ".concat(n)),setDiv("STATS",o)}))}function localWriteHighScore(t){if(t.winner){let e=localStorageGetObject("winners",[]);isHighestScoreForPlayer(e,t)&&(a=getHighScoreIndex(e,t.who),console.log("writing high score to local winners scoreboard"),e[a]=t,localStorageSetObject("winners",e)),localStorageSetObject(t.who,t)}else{let e=localStorageGetObject("losers",[]);var a;isHighestScoreForPlayer(e,t)&&(a=getHighScoreIndex(e,t.who),console.log("writing high score to local visitors scoreboard"),e[a]=t,localStorageSetObject("losers",e))}}function dbWriteHighScore(r){if(console.log("dbWriteHighScore: ".concat(r.gameID)),!navigator.onLine)return console.log("dbWriteHighScore: offline"),void(ONLINE=!1);var e={FunctionName:ENDPOINT,Payload:'{ "gamename" : "'.concat(GAMENAME,'", "newScore" : ').concat(JSON.stringify(r)," }"),InvocationType:"RequestResponse",LogType:"None"};lambda.invoke(e,function(e,t){var a;t?200==(a=JSON.parse(t.Payload).statusCode)?(ONLINE=!0,console.log("dbWriteHighScore: success: "+r.who+" "+r.score+" "+r.hardlev)):404==a?console.log("Couldn't save game ".concat(gameId)):(console.log("lambda error: lambda status=".concat(t.StatusCode," larn status=").concat(a)),e&&console.log(e,e.stack)):(console.log("no data lambda error: "),e&&console.log(e,e.stack))});try{Rollbar&&(r.winner?Rollbar.info("".concat(BUILD," ").concat(GAMENAME," winner: ").concat(r.who,", diff=").concat(r.hardlev,", time=").concat(r.timeused,", score=").concat(r.score,", ").concat(r.playerID,", ").concat(r.gameID)):50<r.timeused&&3<r.hardlev&&Rollbar.info("".concat(BUILD," ").concat(GAMENAME," visitor: ").concat(r.who,", diff=").concat(r.hardlev,", time=").concat(r.timeused,", score=").concat(r.score,", ").concat(r.what," on ").concat(r.level,", ").concat(r.playerID,", ").concat(r.gameID)))}catch(e){console.error("caught: ".concat(e))}}function getHighScore(e,t){return e[getHighScoreIndex(e,t)]}function getHighScoreIndex(e,t){for(var a=0,a=0;a<e.length;a++)if(e[a].gameID==t)return a;return a}function isHighestScoreForPlayer(e,t){for(var a=0;a<e.length;a++){var r=e[a];if(r.who==t.who&&r.winner==t.winner&&sortScore(r,t)<0)return!1}return!0}function paytaxes(e){return 0}function getWhyDead(e){var t="";return t+="number"==typeof e?DEATH_REASONS.get(e):"killed by a ".concat(lastmonst)}function canProtect(e){var t=!0;switch(e="number"!=typeof e?0:e){case DIED_WINNER:case DIED_SAVED_GAME:case DIED_FAILED:case DIED_QUITTER:case DIED_BOTTOMLESS_PIT:case DIED_BOTTOMLESS_TRAPDOOR:case DIED_BOTTOMLESS_ELEVATOR:case DIED_GENIE:t=!1}return t}function died(e,t){var a=e==DIED_WINNER;if(0<player.LIFEPROT&&canProtect(e))return--player.LIFEPROT,player.setConstitution(player.CONSTITUTION-1),player.setHP(1),void updateLog("You feel wiiieeeeerrrrrd all over!");if(ULARN){let e="their";"Male"==player.gender&&(e="his"),"Female"==player.gender&&(e="her"),DEATH_REASONS.set(DIED_FAILED,"killed ".concat(e," family and committed suicide"))}if(a||t&&updateLog("You have been slain!"),paint(),dropflag=nomove=1,localStorageRemoveItem("checkpoint"),e!=DIED_SAVED_GAME){a=mazeMode?updateLog:lprcat;lastmonst=e;t=a==lprcat?"\n":"";try{if(isRecording()){let e=window.location.href.split("?")[0];e=e.split("/larn.html")[0]+"/tv/?gameid=".concat(gameID),a("Replay Link: <b><a href='".concat(e,"'>").concat(e,"</a></b>").concat(t).concat(t))}}catch(e){}a("Press <b>enter</b> to view the scoreboard ".concat(t)),wizard&&a("(sorry, wizard scores are not recorded) "),cheat&&a("(sorry, cheater scores are not recorded) "),writeScoreToDatabase(),setCharCallback(endgame),paint()}else updateLog("----  Reload your browser to play again  ----"),setCharCallback(dead),paint(),recordFrame({LARN:"",STATS:""}),mazeMode=!(napping=!(game_started=!(side_inventory=GAMEOVER=!0)));endGameScore=endGameScore||new LocalScore,endRecording(e==DIED_SAVED_GAME?null:endGameScore,ULARN)}function writeScoreToDatabase(){endGameScore=endGameScore||new LocalScore,console.log("wizard == "+wizard),console.log("cheater == "+cheat),console.log("debug == "+debug_used),console.log("endGameScore.score == "+endGameScore.score),!(0<endGameScore.score||endGameScore.winner)||wizard||cheat||(localWriteHighScore(endGameScore),dbWriteHighScore(endGameScore))}function endgame(e){if(e!=ENTER)return 0;setCharCallback(dead),GAMEOVER=!0,side_inventory||(side_inventory=!0,onResize()),mazeMode=!(napping=!(game_started=!1)),loadScores(endGameScore=endGameScore||new LocalScore,!0,!0)}function dead(e){return 0}function showinventory(e,t,a,r,o,n,i){i=i||player;var l=[];t&&(nomove=1),n&&(mazeMode=!1);var s=0;t&&setCharCallback(t),n&&cursor(1,1),r&&(i.GOLD?(n&&cltoeoln(),n&&lprcat(".) ".concat(Number(i.GOLD).toLocaleString()," gold pieces\n")),s++):r=!1);var c=40,d=23;d-=o?1:0;var p=i.inventory.slice();p.sort(inv_sort);for(var u=0;u<p.length;u++){var h,O=p[u];a(O)&&(++s<=d?(n&&cltoeoln(),c=Math.max(c,O.toString().length+5)):n&&cursor(c,s%d+(r?1:0)),h=i.inventory.indexOf(O),n&&lprcat("".concat(getCharFromIndex(h),") ").concat(O,"\n")),l.push([getCharFromIndex(h),O]))}return n&&cursor(1,Math.min(1+d,++s)),o&&(n&&cltoeoln(),n&&lprcat("Elapsed time is ".concat(elapsedtime(),". You have ").concat(timeleft()," mobuls left\n"))),n&&cltoeoln(),n&&more(e),n&&blt(),l}function showall(e){return null!=e}function showwield(e){return e&&e.isWeapon()}function showwear(e){return e&&e.isArmor()}function showeat(e){return e&&e.matches(OCOOKIE)}function showread(e){return e&&(e.matches(OSCROLL)||e.matches(OBOOK))}function showquaff(e){return e&&e.matches(OPOTION)}const sortorder=[OLARNEYE.id,OELVENCHAIN.id,OSSPLATE.id,OPLATEARMOR.id,OPLATE.id,OSPLINT.id,OCHAIN.id,ORING.id,OSTUDLEATHER.id,OLEATHER.id,OSHIELD.id,OLANCE.id,OSLAYER.id,OHAMMER.id,OSWORDofSLASHING.id,OVORPAL.id,OSWORD.id,O2SWORD.id,OLONGSWORD.id,OBATTLEAXE.id,OBELT.id,OFLAIL.id,OSPEAR.id,ODAGGER.id,ORINGOFEXTRA.id,OPROTRING.id,OCLEVERRING.id,OREGENRING.id,OENERGYRING.id,ODEXRING.id,OSTRRING.id,ODAMRING.id,OSCROLL.id,OPOTION.id,OBOOK.id,OCHEST.id,OAMULET.id,OBRASSLAMP.id,OWWAND.id,OORBOFDRAGON.id,OSPIRITSCARAB.id,OCUBEofUNDEAD.id,ONOTHEFT.id,OSPHTALISMAN.id,OHANDofFEAR.id,OORB.id,OPSTAFF.id,OLIFEPRESERVER.id,ODIAMOND.id,ORUBY.id,OEMERALD.id,OSAPPHIRE.id,OCOKE.id,OSHROOMS.id,OHASH.id,OACID.id,OSPEED.id,OCOOKIE.id];function inv_sort(e,t){return null==e&&null==t?0:null==e?1:null==t?-1:e.getSortCode()-t.getSortCode()}function parse_inventory(e){return nomove=1,e==ESC||" "==e?(setMazeMode(!0),1):0}function canTake(e){return itemlist[e.id].carry}function take(e){if(0==canTake(e))return!1;for(var t=maxcarry(),a=0;a<t;a++)if(!player.inventory[a])return mazeMode&&(updateLog("  You pick up:"),updateLog("".concat(getCharFromIndex(a),") ").concat(e))),e.matches(OPOTION)&&21==e.arg&&(player.hasPickedUpPotion=!0),debug("take(): "+e),player.adjustcvalues(e,!(t=0)),player.inventory[a]=e,!0;return updateLog("You can't carry anything else".concat(period)),!1}function drop_object(e){dropflag=1;var t=itemAt(player.x,player.y).matches(OPIT);if("*"==e||" "==e||"I"==e)return mazeMode?showinventory(!0,drop_object,showall,!1,!1,!0):setMazeMode(!0),nomove=1,0;if("."==e)return nomove=1,setMazeMode(!0),updateLog("How much gold will you drop? "),setNumberCallback(drop_object_gold,!0),1;var a=getIndexFromChar(e),r=player.inventory[a];return r?!t&&isItemAt(player.x,player.y)?(beep(),updateLog("  There's something here already".concat(period))):(updateLog("  You drop: "),updateLog("".concat(getCharFromIndex(a),") ").concat(r)),player.inventory[a]=null,t?updateLog("  It disappears down the pit".concat(period)):setItem(player.x,player.y,r),player.WIELD===r&&(player.WIELD=null),player.WEAR===r&&(player.WEAR=null),player.SHIELD===r&&(player.SHIELD=null),player.adjustcvalues(r,!1)):(0<=a&&a<26&&updateLog("  You don't have item ".concat(e,"!")),a<=-1&&(appendLog(" cancelled".concat(period)),nomove=1)),setMazeMode(!0),1}function drop_object_gold(e){dropflag=1;var t=itemAt(player.x,player.y).matches(OPIT);if(e==ESC)return appendLog(" cancelled".concat(period)),nomove=1;if("*"==e&&(e=player.GOLD),0==(e=Number(e)))return 1;if(e>player.GOLD)return updateLog("  You don't have that much!"),1;var a=itemAt(player.x,player.y).matches(OGOLDPILE);return t||!isItemAt(player.x,player.y)||a?(player.setGold(player.GOLD-e),updateLog("  You drop ".concat(Number(e).toLocaleString()," gold pieces")),t?updateLog("  The gold disappears down the pit".concat(period)):(t=0,a&&(t=itemAt(player.x,player.y).arg),setItem(player.x,player.y,createObject(OGOLDPILE,e+t)))):(beep(),updateLog("  There's something here already".concat(period))),1}function maxcarry(e){return e=e||player,Math.min(15+(e.LEVEL>>1),MAXINVEN)}function pocketfull(){for(var e=maxcarry(),t=0;t<e;t++)if(!player.inventory[t])return!1;return!0}function pocketempty(){for(var e=maxcarry(),t=0;t<e;t++)if(player.inventory[t])return!1;return!0}function isCarrying(t){var a=t&&(t.matches(OPOTION)||t.matches(OSCROLL));for(let e=0;e<player.inventory.length;e++){var r=player.inventory[e];if(r&&t.matches(r,a))return r}return null}let movedx=-1,movedy=-1,distance=-1,move_yl=-1,move_yh=-1,move_xl=-1,move_xh=-1;function movemonst(){if(!player.TIMESTOP&&!player.HOLDMONST){distance=player.AGGRAVATE?(move_yl=player.y-5,move_yh=player.y+6,move_xl=player.x-10,move_xh=player.x+11,40):(move_yl=player.y-3,move_yh=player.y+4,move_xl=player.x-5,move_xh=player.x+6,17),0==level?(move_yl<0&&(move_yl=0),move_yh>MAXY&&(move_yh=MAXY),move_xl<0&&(move_xl=0),move_xh>MAXX&&(move_xh=MAXX)):(move_yl<1&&(move_yl=1),move_yh>MAXY-1&&(move_yh=MAXY-1),move_xl<1&&(move_xl=1),move_xh>MAXX-1&&(move_xh=MAXX-1));for(let a=move_yl;a<move_yh;a++)for(let t=move_xl;t<move_xh;t++){let e=monsterAt(t,a);e&&(e.moved=!1)}if(0<=lasthx&&lasthx<MAXX&&0<=lasthy&&lasthy<MAXY){let e=monsterAt(lasthx,lasthy);e&&(e.moved=!1,movemt(lasthx,lasthy),lasthx=movedx,lasthy=movedy)}for(let a=move_yl;a<move_yh;a++)for(let t=move_xl;t<move_xh;t++){let e=monsterAt(t,a);ULARN&&e&&e.arg==MIMIC&&(e.mimiccounter%10==0&&(e.mimicarg=createMimicArg()),e.mimiccounter++),e&&!e.moved&&(!player.AGGRAVATE&&player.STEALTH&&!e.awake||movemt(t,a))}noticeplayer()}}function movemt(t,a){let r=monsterAt(t,a);if(r){if(!r.isSlow()||!isHalfTime()){let e=isCarrying(OHANDofFEAR)?1:0;player.SCAREMONST?e++:1==e&&4<rnd(10)&&(e=0),(r.isDemon()||r.matches(PLATINUMDRAGON))&&(e=e<=1?0:5<rnd(10)),(e?scared_move:r.intelligence>10-getDifficulty()?smart_move:dumb_move)(t,a)}}else console.log("movemt(): no monster at ".concat(t,",").concat(a))}function dumb_move(c,d){var p=monsterAt(c,d);if(p){let a=[],r=[],o=[],e=c-1,n=d-1,i=c+2,l=d+2;c<player.x?e++:c>player.x&&i--,d<player.y?n++:d>player.y&&l--,e<0&&(e=0),i>MAXX&&(i=MAXX),n<0&&(n=0),l>MAXY&&(l=MAXY);for(let e=0;e<9;e++)a[e]=1e4;let s=0;for(let t=e;t<i;t++)for(let e=n;e<l;e++)valid_monst_move(t,e,p)&&!monsterAt(t,e)&&(a[s]=(player.x-t)*(player.x-t)+(player.y-e)*(player.y-e),r[s]=t,o[s]=e),s++;let t=0;for(let e=1;e<9;e++)a[e]<a[t]&&(t=e);a[t]<1e4&&(c!=r[t]||d!=o[t])&&mmove(c,d,r[t],o[t])}else console.log("dumb_move(): no monster at ".concat(c,",").concat(d))}function scared_move(a,r){var o=monsterAt(a,r);if(o){let e=a+rnd(3)-2,t=r+rnd(3)-2;e<0&&(e=0),e>=MAXX&&(e=MAXX-1),t<0&&(t=0),t>=MAXY&&(t=MAXY-1),valid_monst_move(e,t,o)&&!monsterAt(e,t)&&mmove(a,r,e,t)}else console.log("scared_move(): no monster at ".concat(a,",").concat(r))}let screen=initGrid(MAXX,MAXY);function smart_move(s,c){let a=monsterAt(s,c);if(a){DEBUG_PROXIMITY&&(screen=initGrid(MAXX,MAXY));let r=vx(move_xl-2),o=vy(move_yl-2),n=vx(move_xh+2),e=vy(move_yh+2);for(let t=o;t<=e;t++)for(let e=r;e<=n;e++)if(valid_monst_move(e,t,a))if(a.matches(DEMONPRINCE)||a.matches(LUCIFER))screen[e][t]=0;else switch(itemAt(e,t).id){case OELEVATORUP.id:case OELEVATORDOWN.id:case OTRAPARROW.id:case ODARTRAP.id:case OTELEPORTER.id:screen[e][t]=127;break;case OPIT.id:case OTRAPDOOR.id:a.canFly()?screen[e][t]=0:screen[e][t]=127;break;default:screen[e][t]=0}else screen[e][t]=127;screen[player.x][player.y]=1,r=vx(move_xl-1),o=vy(move_yl-1),n=vx(move_xh+1),e=vy(move_yh+1);let i=1,l=0;for(;i<distance&&!l;){for(let a=o;a<=e;a++)for(let t=r;t<=n;t++)if(screen[t][a]==i)for(let e=1;e<9;e++){var d=t+diroffx[e],p=a+diroffy[e];0<=d&&d<MAXX&&0<=p&&p<MAXY&&0==screen[d][p]&&(screen[d][p]=i+1,d==s&&p==c&&(l=1))}i++}if(l){i=screen[s][c]-1;let t;for(let e=1;e<9;e++)if(r=s+diroffx[e],o=c+diroffy[e],t=0==level?0<=r&&r<MAXX&&0<=o&&o<MAXY:1<=r&&r<MAXX-1&&1<=o&&o<MAXY-1,t&&screen[r][o]==i&&!monsterAt(r,o))return void mmove(s,c,r,o)}else{let e=itemAt(s,c);a.isDemon()&&(e.matches(OLARNEYE)||e.matches(OPOTION)&&21==e.arg)||dumb_move(s,c)}}else console.log("smart_move(): no monster at ".concat(s,",").concat(c))}function mmove(n,i,l,s){let c=monsterAt(n,i);if(c){if(l==player.x&&s==player.y)return hitplayer(n,i),c.moved=!0,movedx=n,void(movedy=i);player.level.monsters[n][i]=null,player.level.monsters[l][s]=c,c.awake=!0,c.moved=!0;let e=itemAt(l,s);ULARN&&c.matches(LEMMING)&&rnd(100)<=2&&(player.level.monsters[n][i]=createMonster(LEMMING)),c.matches(LEPRECHAUN)&&(e.matches(OGOLDPILE)||e.isGem())&&(c.pickup(e),setItem(l,s,OEMPTY)),c.matches(TROLL)&&isHalfTime()&&monsterlist[c.arg].hitpoints>c.hitpoints&&c.hitpoints++;let t=0,a,r=0,o;var d;e.matches(OANNIHILATION)?c.isDemon()?!(d=isCarrying(OSPHTALISMAN))||d&&c.matches(LUCIFER)&&7<rnd(10)?(o="The ".concat(c," dispels the sphere!"),rmsphere(l,s)):(o="The ".concat(c," is destroyed by the sphere of annihilation!"),killMonster(l,s),t=1):c.isCarrying(OSPHTALISMAN)?o="The ".concat(c," is unaffected by the sphere of annihilation!"):(o="The ".concat(c," is destroyed by the sphere of annihilation!"),killMonster(l,s),t=1):e.matches(OTRAPARROW)?(a="An arrow",r=rnd(10)+level):e.matches(ODARTRAP)?(a="A dart",r=rnd(6)):e.matches(OTELEPORTER)?c.isDemon()||(o="The ".concat(c," gets teleported").concat(period),teleportMonster(l,s),l=movedx,s=movedy):e.matches(OPIT)||e.matches(OTRAPDOOR)?c.canFly()||(o="The ".concat(c," fell into a pit").concat(period),e.matches(OTRAPDOOR)&&(o="The ".concat(c," fell through a trapdoor").concat(period)),killMonster(l,s),t=1):(e.matches(OELEVATORUP)||e.matches(OELEVATORDOWN))&&(c.isDemon()||(o="The ".concat(c," is carried away by an elevator!"),killMonster(l,s),t=1)),0<r&&(c.hitpoints-=r,c.hitpoints<=0?(killMonster(l,s),o="".concat(a," hits and kills the ").concat(c).concat(period),t=1):o="".concat(a," hits the ").concat(c).concat(period)),movedy=t?movedx=-1:(movedx=l,s),player.BLINDCOUNT||(null!=player.level.know[l][s]&&o&&(updateLog(o),beep()),ULARN&&c.isDemon()&&!isCarrying(OLARNEYE)||(player.level.know[n][i]&HAVESEEN&&show1cell(n,i),player.level.know[l][s]&HAVESEEN&&show1cell(l,s)))}else console.log("mmove(): no monster at ".concat(n,",").concat(i))}function valid_monst_move(e,t,a){let r=itemAt(e,t);var o;let n;return o=e==player.x&&t==player.y,t=33==e&&t==MAXY-1&&1==level,n=r.matches(OCLOSEDDOOR)||r.matches(OWALL)&&!o,o=a.matches(VAMPIRE)&&r.matches(OMIRROR),ULARN&&(a.matches(DEMONPRINCE)||a.matches(LUCIFER))&&(n=!1),!(t||n||o)}function noticeplayer(){if(player.STEALTH)for(var e=nearbymonsters(),t=0;t<e.length;t++){var a=e[t];rund(15)<getDifficulty()-1&&!a.awake&&rnd(101)<50&&(updateLog("The ".concat(a," sees you!")),a.awake=!0)}}function isHalfTime(){return 1==(1&player.MOVESMADE)}function open_something(e){if(0==e)return updateLog(""),1;var t=player.x+diroffx[e],a=player.y+diroffy[e],e=itemAt(t,a);return e?e.matches(OOPENDOOR)?(updateLog("  The door is already open!"),beep()):e.matches(OCHEST)?act_open_chest(t,a):e.matches(OCLOSEDDOOR)?act_open_door(t,a):(updateLog("  You can't open that!"),beep()):updateLog("  There is nothing to open!"),1}function act_open_chest(e,t){var a=itemAt(e,t);if(a.matches(OCHEST))if(rnd(101)<40){updateLog("  The chest explodes as you open it".concat(period)),beep();var r=rnd(10);switch(r>player.hitpoints&&(r=player.hitpoints),lastnum=DIED_EXPLODING_CHEST,updateLog("  You suffer ".concat(r," hit points damage!")),player.losehp(r),rnd(10)){case 1:player.ITCHING+=rnd(1e3)+100,updateLog("  You feel an irritation spread over your skin!"),beep();break;case 2:player.CLUMSINESS+=rnd(1600)+200,updateLog("  You begin to lose hand to eye coordination!"),beep();break;case 3:player.HALFDAM+=rnd(1600)+200,beep(),updateLog(ULARN?"  You suddenly feel sick and BARF all over your shoes!":"  A sickness engulfs you!")}setItem(e,t,OEMPTY),rnd(100)<69&&dropItemNearPlayer(createGem()),dropItemNearPlayer(createGold(rnd(110*a.arg+200)));for(var o=0;o<rnd(4);o++)dropItemNearPlayer(createRandomItem(a.arg+2)),rnd(101)<8&&o--}else updateLog("  Nothing happens".concat(period))}function act_open_door(e,t){var a=itemAt(e,t);if(a.matches(OCLOSEDDOOR)){if(!(rnd(11)<7))return updateLog("  The door opens".concat(period)),setItem(e,t,OOPENDOOR),1;switch(a.arg){case 6:updateLog("  The door makes an awful groan, but remains stuck".concat(period)),player.AGGRAVATE+=rnd(400);break;case 8:if(!ULARN){updateLog("  You feel drained".concat(period)),player.loselevel();break}case 7:updateLog("  You are jolted by an electric shock!"),lastnum=DIED_ELECTRIC_SHOCK,player.losehp(rnd(20));break;case 9:updateLog("  You suddenly feel weaker".concat(period)),player.setStrength(player.STRENGTH-1);break;default:return updateLog("  The door doesn't budge".concat(period)),0}}}function close_something(e){cursors();var t=player.x+diroffx[e],a=player.y+diroffy[e],r=itemAt(t,a);if(!r)return updateLog("  There is nothing to close!"),1;if(r.matches(OCLOSEDDOOR))updateLog("  The door is already closed!"),beep();else if(r.matches(OOPENDOOR)){if(monsterAt(t,a))return void updateLog("  There's a monster in the way!");setItem(t,a,createObject(OCLOSEDDOOR,0)),updateLog("  The door closes".concat(period)),0==e&&(player.x=lastpx,player.y=lastpy)}else updateLog("  You can't close that!"),beep();return 1}function outfortune(){var e;updateLog("The cookie was delicious".concat(period)),player.BLINDCOUNT||(e=FORTUNES[rund(FORTUNES.length)],updateLog("Inside you find a scrap of paper that says:"),updateLog("  ".concat(e)))}function act_eatcookie(e){var t=getIndexFromChar(e),a=player.inventory[t];if(a&&a.matches(OCOOKIE))player.inventory[t]=null,outfortune();else if(a)updateLog("  You can't eat that!"),nomove=1;else{if("*"==e||" "==e||"I"==e)return mazeMode?showinventory(!0,act_eatcookie,showeat,!1,!1,!0):setMazeMode(!0),void(nomove=1);0<=t&&t<26&&(updateLog("  You don't have item ".concat(e,"!")),nomove=1),t<=-1&&(appendLog(" cancelled".concat(period)),nomove=1)}return setMazeMode(!0),1}function act_rub_lamp(){cursors(),updateLog("You rub the lamp".concat(period)),90<rnd(100)?(updateLog("  The magic genie was very upset at being disturbed!"),lastnum=DIED_GENIE,player.losehp(player.HP/2+1)):80<rnd(100)+player.LEVEL/2?(updateLog("  A magic genie appears!"),updateLog("  What spell would you like? : "),setCharCallback(wish)):(updateLog("  nothing happened".concat(period)),rnd(100)<15&&(updateLog("The genie prefers not to be disturbed again!"),forget(),player.LAMP=!1))}function wish(e){nomove=1;e=getSpellCode(e,!0);if(e!==newSpellCode)return e;e=learnSpell(newSpellCode);return newSpellCode=null,0<=e?(updateLog("Spell '<b>".concat(spelcode[e],"</b>': ").concat(spelname[e])),updateLog("  ".concat(speldescript[e]).concat(period))):updateLog("  The genie has never heard of such a spell!"),updateLog("The genie prefers not to be disturbed again".concat(period)),forget(),1}var cursorx=1,cursory=1,display=initGrid(80,24);function lprintf(e,t){lprcat(null!=t?padString(e,t):e)}var START_MARK="<mark>",END_MARK="</mark>",START_BOLD="<b>",END_BOLD="</b>";function lprint(e){lprcat(e),blt()}function lprcat(t,e){if(DEBUG_LPRCAT++,alternativeDisplay)alternativeDisplay+=t;else if(e)lprintf(t,e);else for(var a=null,r=t.length,o=0;o<r;o++){var n=t[o];if("<"===n)if(t.substr(o,3).toLowerCase()===START_BOLD){if(a=START_BOLD,o+=2,amiga_mode)continue;n=START_BOLD}else if(t.substr(o,4).toLowerCase()===END_BOLD){if(a=null,o+=3,amiga_mode)continue;{let e=80<cursorx?cursorx-80:1;cursorx-=e,n=t.substr(o-3-e,e)+END_BOLD}}else if(t.substr(o,6).toLowerCase()===START_MARK){if(a=START_MARK,o+=5,amiga_mode)continue;n=START_MARK}else if(t.substr(o,7).toLowerCase()===END_MARK){if(a=null,o+=6,amiga_mode)continue;{let e=80<cursorx?cursorx-80:1;cursorx-=e,n=t.substr(o-6-e,e)+END_MARK}}lprc(n,a)}}function cursor(e,t){cursorx=e,cursory=t}function cursors(){cursor(1,24)}function lprc(e,t){DEBUG_LPRC++,alternativeDisplay?alternativeDisplay+=e:"\b"==e?os_put_font(" ",--cursorx-1,cursory-1):"\n"==e?(cursorx=1,cursory++):(os_put_font(e,cursorx-1,cursory-1,t),cursorx++)}var HACK_URL_TEXT="url";function os_put_font(e,t,a,r){0<=t&&t<80&&0<=a&&a<24&&(amiga_mode?e.substring(0,3)===HACK_URL_TEXT?setImage(t,a,e):setChar(t,a,e,r):(DEBUG_PROXIMITY&&(screen[t]&&screen[t][a]&&127!=screen[t][a]&&0!=screen[t][a]&&(e=monsterAt(t,a)?"<b>".concat(e,"</b>"):screen[t][a]<10?""+screen[t][a]:""+screen[t][a]%10),t==player.x&&a==player.y&&(e="<b>#</b>")),display[t][a]=e,altrender&&setChar(t,a,e,r)))}function clear(){cl_dn(1,1)}function cltoeoln(){for(var e=cursorx,t=81-e;0<t--;)lprc(" ",null),setImage(80-t-1,cursory-1,OUNKNOWN.getChar());cursorx=e}function cl_up(e,t){for(var a=1;a<=t;a++)cursor(1,a),cltoeoln();cursor(e,t)}function cl_dn(e,t){for(var a=t;a<=24;a++)cursor(1,a),cltoeoln();cursor(e,t)}function lflush(){LOG=Array(LOG_SAVE_SIZE).join(" ").split("")}const KNOWNOT=0,HAVESEEN=1,KNOWHERE=2,KNOWALL=HAVESEEN|KNOWHERE;function paint(){mazeMode&&(drawmaze(),botside(),bottomline()),printStats(),blt(),DEBUG_PAINT++}function blt(){if(amiga_mode||altrender||bltDocument(),BLINKEN){let e={};e.LARN=document.getElementById("LARN").innerHTML,e.STATS=document.getElementById("STATS").innerHTML,recordFrame(e,createLocalScore)}}let alternativeDisplay;function detachDisplay(){display=null,alternativeDisplay=" "}function bltDocument(){if(!(e=alternativeDisplay))for(var e="",t=0;t<24;t++){for(var a=0;a<80;a++)e+=null!=display[a][t]?display[a][t]:" ";e+="\n"}setDiv("LARN",e)}function setMazeMode(e){mazeMode=e,clear(),paint()}function setChar(e,t,a,r){setDiv("".concat(e,",").concat(t),a,r)}function createDiv(e,t,a,r){a=a||12,r=r||2*a;var o,n="";return mobile&&(o=".",e<22&&t<=5?o="y":e<=44&&t<=5?o="k":e<=67&&t<=5?o="u":e<22&&t<=11?o="h":e<=44&&t<=11?o=".":e<=67&&t<=11?o="l":e<22&&t<=16?o="b":e<=44&&t<=16?o="j":e<=67&&t<=16&&(o="n"),n=" onclick='mousetrap(null, \"".concat(o,"\")'")),"<div id='".concat(e,",").concat(t,"' class='image' style=\"width:").concat(a,"px; height:").concat(r,'px;"').concat(n,"> </div>")}function setDiv(e,t,a){var r=document.getElementById(e);r?t===r.innerHTML&&a!=START_MARK&&(a!=START_BOLD&&"normal"==r.style.fontWeight||a==START_BOLD&&"bold"==r.style.fontWeight)||(r.innerHTML=t,a==START_BOLD?r.style.fontWeight="bold":a==START_MARK?r.innerHTML="<mark>".concat(t,"</mark>"):r.style.fontWeight="normal"):console.log("null document: ".concat(e))}function setImage(e,t,a){var r;amiga_mode&&((r=document.getElementById("".concat(e,",").concat(t)))?r.style.backgroundImage!==a&&(a&&(r.style.backgroundImage=a),r.innerHTML=" "):console.log("setImage: null doc at ".concat(e,",").concat(t)))}function onResize(){setMode(amiga_mode,retro_mode,original_objects)}function setMode(e,t,a){e&&isRecording()&&stopRecording(),amiga_mode=e,retro_mode=t,original_objects=a;var r=computeSpriteWidth(),t="12px modern",a="ABCDEFGHIJKLMNOPQRSTUVWXYZ",t=getTextWidth(a,t,!0)!=getTextWidth(a,t,!1);let o=t?1.66:1.71,n=1.93,i=t?"Courier New":"modern",l="lightgrey",s="normal";if(retro_mode&&(o=1.88,n=1.9,i="dos437",l="#ABABAB",s="-1px"),amiga_mode){o=1.66,i=retro_mode?"amiga500":"amiga1200",l="lightgrey",s="normal",original_objects=!0;var c=document.getElementById("0,0");if(c){if("".concat(r,"px")!=c.style.width){var d=document.getElementsByClassName("image");for(let e=0;e<d.length;e++){const O=d[e];O.style.width="".concat(r,"px"),O.style.height="".concat(2*r,"px")}}}else{for(var p=0;p<24;p++)for(var u=0;u<80;u++)display[u][p]=createDiv(u,p,r,2*r);bltDocument()}images||loadImages()}t=r*o,c="".concat(r*n,"px"),t="".concat(t,"px ").concat(i);document.body.style.font=t,document.body.style.fontFamily=i,document.body.style.color=l,document.body.style.letterSpacing=s,document.body.style.lineHeight=c,setButtons(),paint();try{if(!styleUploaded){styleUploaded=!0;let e={};var h=document.getElementById("LARN");e.font=getComputedStyle(h).font,e.fontFamily=getComputedStyle(h).fontFamily,e.color=getComputedStyle(h).color,e.letterSpacing=getComputedStyle(h).letterSpacing,e.widthMultiple=o,e.heightMultiple=n,uploadStyle(e)}}catch(e){console.error("failed to upload style",e)}}let styleUploaded=!1;function computeSpriteWidth(){var e=window.innerWidth,t=window.innerHeight,e=(e-75)/(80+(side_inventory?39:0)),t=Math.min(e,(t-125)/24/2),t=Math.floor(t);return Math.max(9,t)}function printStats(){let e="";player&&(DEBUG_STATS?e=debug_stats():game_started&&side_inventory&&(e=game_stats(player)),setDiv("STATS",e))}function bottomline(){cursor(1,18),lprcat("".concat(player.getStatString(),"\n"));for(var e=LOG_SAVE_SIZE-LOG_SIZE;e<LOG.length;e++)lprcat("".concat(LOG[e])),cltoeoln(),lprcat("\n")}function botside(){var e=1;botsideline(player.STEALTH,"Stealth",e++,changedStealth),botsideline(player.UNDEADPRO,"Undead Pro",e++,changedUndeadPro),botsideline(player.SPIRITPRO,"Spirit Pro",e++,changedSpiritPro),botsideline(player.CHARMCOUNT,"Charm",e++,changedCharmCount),botsideline(player.TIMESTOP,"Time Stop",e++,changedTimeStop),botsideline(player.HOLDMONST,"Hold Monst",e++,changedHoldMonst),botsideline(player.GIANTSTR,"Giant Str",e++,changedGiantStr),botsideline(player.FIRERESISTANCE,"Fire Resit",e++,changedFireResistance),botsideline(player.DEXCOUNT,"Dexterity",e++,changedDexCount),botsideline(player.STRCOUNT,"Strength",e++,changedStrCount),botsideline(player.SCAREMONST,"Scare",e++,changedScareMonst),botsideline(player.HASTESELF,"Haste Self",e++,changedHasteSelf),botsideline(player.CANCELLATION,"Cancel",e++,changedCancellation),botsideline(player.INVISIBILITY,"Invisible",e++,changedInvisibility);var t="Protect "+(ULARN?"5":"3");botsideline(player.ALTPRO,t,e++,changedAltPro),botsideline(player.PROTECTIONTIME,"Protect 2",+e,changedProtectionTime),botsideline(player.WTW,"Wall-Walk",17,changedWTW)}const blank="          ";function botsideline(e,t,a,r){cursor(70,a),lprcat(padString(0<e?t:blank,-1,r))}function drawmaze(){amiga_mode||clear();for(var e=player.level.know,t=0<player.BLINDCOUNT,a=0;a<MAXY;a++){cursor(1,1+a);for(var r,o,n=0;n<MAXX;n++)0!=e[n][a]&&e[n][a]&HAVESEEN?n!=player.x||a!=player.y?(r=monsterAt(n,a),o=itemAt(n,a),r&&e[n][a]&KNOWHERE?lprc((t?o:r).getChar(),n,a):lprc(o.getChar(),n,a)):lprc(player.getChar(),n,a):lprc(OUNKNOWN.getChar(),n,a)}}function showcell(e,t){if(mazeMode){var a,r,o=0<player.BLINDCOUNT?(i=n=e,l=t):0<player.AWARENESS?(n=e-3,i=e+3,l=t-3,t+3):(n=e-1,i=e+1,l=t-1,t+1),n=vx(n),i=vx(i),l=vy(l);o=vy(o);for(var s=player.level.know,c=l;c<=o;c++)for(r=n;r<=i;r++)if(0==(s[r][c]&KNOWHERE)){for(e=i;s[e][c]&KNOWHERE;)--e;for(a=r;a<=e;a++)s[a][c]=KNOWALL;r=i}}}function show1cell(e,t){player.level.know[e][t]=KNOWALL}const diroffx=[0,0,1,0,-1,1,-1,1,-1],diroffy=[0,1,0,-1,0,-1,-1,1,1];function moveplayer(e){player.CONFUSE&&player.LEVEL<rnd(30)&&(e=rund(9));var t=player.x+diroffx[e],a=player.y+diroffy[e];if(t<0||t>=MAXX||a<0||a>=MAXY)return nomove=1,0;var r=itemAt(t,a),e=monsterAt(t,a);return(r.matches(OCLOSEDDOOR)||r.matches(OWALL))&&0==player.WTW?(nomove=1,0):r.matches(OHOMEENTRANCE)?(newcavelevel(0),moveNear(OENTRANCE,!1),0):e?(hitmonster(t,a),0):(0==player.TIMESTOP&&itemAt(player.x,player.y).matches(OALTAR)&&!prayed&&(updateLog("  You have ignored the altar!"),act_ignore_altar(player.x,player.y)),prayed=0,lastpx=player.x,lastpy=player.y,player.x=t,player.y=a,r.matches(OEMPTY)||r.matches(OTRAPARROWIV)||r.matches(OIVTELETRAP)||r.matches(OIVDARTRAP)||r.matches(OIVTRAPDOOR)?1:0)}function moveNear(e,t){for(var a=0;a<MAXX;a++)for(var r=0;r<MAXY;r++)if(itemAt(a,r).matches(e))return positionplayer(a,r,t),!0;return debug("movenear: NOT FOUND: "+e.id),!1}var PAGE_COUNT=1;const NO_MORE="nomore";function seemagic(e,t){mazeMode=!1;var a=player.knownSpells;t&&(a=spelcode),e?cl_up(79,(a.length+2)/3+4):clear(),cursor(1,1);var r=[],o="  The magic spells you have discovered thus far:";printknown(o=t?"Available spells are:":o,a,function(e,t){return padString("".concat(e," ").concat(spelname[spelcode.indexOf(e)]),-26)},r,!0),e||(printknown("  The magic scrolls you have found to date are:",player.knownScrolls,function(e){return padString("".concat(SCROLL_NAMES[e.arg]),-26)},r,!0),printknown("  The magic potions you have found to date are:",player.knownPotions,function(e){return padString("".concat(POTION_NAMES[e.arg]),-26)},r,!1));for(var a=20*((PAGE_COUNT=r.length<=20?1:PAGE_COUNT)-1),n=0==a?Math.min(20,r.length):r.length,i=a;i<n;i++)lprcat(r[i]+"\n");(r.length<=20||2==PAGE_COUNT)&&(PAGE_COUNT=NO_MORE),e||lprcat("\n"),lprcat("Press <b>space</b> to continue \n")}function printknown(e,t,a,r,o){var n=t.slice().sort();r.push(e),r.push("");for(var i="",l=0,s=0;s<n.length;s++){var c=n[s];c&&(i+=a(c),++l%3==0&&(r.push(i),i=""))}l%3!=0&&r.push(i),0==l&&r.push("..."),o&&r.push("")}function parse_see_all(e){return nomove=1,(e=PAGE_COUNT==NO_MORE?ESC:e)==ESC?(PAGE_COUNT=1,exitbuilding()):" "==e?(seemagic(!(PAGE_COUNT=2)),0):void 0}function parse_see_spells(e){if(nomove=1,e==ESC||" "==e)return PAGE_COUNT=1,setCharCallback(cast),exitbuilding()}function updateLog(e,t){""==e&&(e=" "),DEBUG_OUTPUT&&console.log("LARN: ".concat(e," ").concat(t||"")),LOG&&(keyboard_hints&&t&&(e="".concat(e," ").concat(t)),LOG.push(e),LOG.length>LOG_SAVE_SIZE&&LOG.shift())}function appendLog(e){var t=e==DEL?(t=deleteLog()).substring(0,t.length-1):deleteLog()+e;updateLog(t)}function deleteLog(){if(LOG)return LOG.pop()}function onMouseClick(s){try{let e,t,a;if(!amiga_mode)return;if(!s.target.attributes.id)return;e=s.target.attributes.id.value.split(","),t=e[0],a=e[1];let r=monsterAt(t,a),o=itemAt(t,a);if(!o)return;let n="",i="It's ",l=!1;var c;r&&(l=!r.isVisible()||0<player.BLINDCOUNT),l&&(r=null),player.level.know[t][a]?t==player.x&&a==player.y?n="our Hero":r?(n=r.toString(),ULARN&&r.matches(MIMIC)&&(n=monsterlist[r.mimicarg].toString()),c=n.substring(0,1).toLocaleLowerCase(),i="It's a ",0<="aeiou".indexOf(c)&&(i="It's an ")):n=l||o.matches(OIVDARTRAP)||o.matches(OIVTELETRAP)||o.matches(OIVTRAPDOOR)||o.matches(OTRAPARROWIV)?OEMPTY.desc:o.getDescription():n="a mystery",n=i+n,updateLog(n),paint()}catch(e){console.log("onMouseClick",e)}}var STORE_INVENTORY,MAXITM,DNDItem=function(e,t,a,r){this.price=e,this.itemId=t,this.arg=a,this.qty=r};const LARN_STORE_INVENTORY=[[20,OLEATHER.id,0,3],[100,OSTUDLEATHER.id,0,2],[400,ORING.id,0,2],[850,OCHAIN.id,0,2],[2200,OSPLINT.id,0,1],[4e3,OPLATE.id,0,1],[9e3,OPLATEARMOR.id,0,1],[26e3,OSSPLATE.id,0,1],[1500,OSHIELD.id,0,1],[20,ODAGGER.id,0,3],[200,OSPEAR.id,0,3],[800,OFLAIL.id,0,2],[1500,OBATTLEAXE.id,0,2],[4500,OLONGSWORD.id,0,2],[1e4,O2SWORD.id,0,2],[5e4,OSWORD.id,0,1],[165e3,OLANCE.id,0,1],[6e4,OSWORDofSLASHING.id,0,0],[1e5,OHAMMER.id,0,0],[1500,OPROTRING.id,1,1],[850,OSTRRING.id,1,1],[1200,ODEXRING.id,1,1],[1200,OCLEVERRING.id,1,1],[1800,OENERGYRING.id,0,1],[1250,ODAMRING.id,0,1],[2200,OREGENRING.id,0,1],[1e4,ORINGOFEXTRA.id,0,1],[2800,OBELT.id,0,1],[4e3,OAMULET.id,0,1],[65e3,OORBOFDRAGON.id,0,0],[55e3,OSPIRITSCARAB.id,0,0],[5e4,OCUBEofUNDEAD.id,0,0],[6e4,ONOTHEFT.id,0,0],[5900,OCHEST.id,6,1],[2e3,OBOOK.id,8,1],[100,OCOOKIE.id,0,3],[200,OPOTION.id,0,6],[900,OPOTION.id,1,5],[5200,OPOTION.id,2,1],[1e3,OPOTION.id,3,2],[500,OPOTION.id,4,2],[1500,OPOTION.id,5,2],[700,OPOTION.id,6,1],[300,OPOTION.id,7,7],[2e3,OPOTION.id,8,1],[500,OPOTION.id,9,1],[800,OPOTION.id,10,1],[300,OPOTION.id,11,3],[200,OPOTION.id,12,5],[400,OPOTION.id,13,3],[350,OPOTION.id,14,2],[5200,OPOTION.id,15,1],[900,OPOTION.id,16,2],[2e3,OPOTION.id,17,2],[2200,OPOTION.id,18,4],[800,OPOTION.id,19,6],[3700,OPOTION.id,20,3],[500,OPOTION.id,22,1],[1500,OPOTION.id,23,3],[1e3,OSCROLL.id,0,2],[1250,OSCROLL.id,1,2],[600,OSCROLL.id,2,4],[100,OSCROLL.id,3,4],[1e3,OSCROLL.id,4,3],[2e3,OSCROLL.id,5,2],[1100,OSCROLL.id,6,1],[5e3,OSCROLL.id,7,2],[2e3,OSCROLL.id,8,2],[2500,OSCROLL.id,9,4],[200,OSCROLL.id,10,5],[300,OSCROLL.id,11,3],[3400,OSCROLL.id,12,1],[3400,OSCROLL.id,13,1],[3e3,OSCROLL.id,14,2],[4e3,OSCROLL.id,15,2],[5e3,OSCROLL.id,16,2],[1e4,OSCROLL.id,17,1],[5e3,OSCROLL.id,18,1],[3400,OSCROLL.id,19,2],[2200,OSCROLL.id,20,3],[39e3,OSCROLL.id,21,0],[6100,OSCROLL.id,22,1],[3e4,OSCROLL.id,23,0]],ULARN_STORE_INVENTORY=[[20,OLEATHER.id,0,3],[100,OSTUDLEATHER.id,0,2],[400,ORING.id,0,2],[850,OCHAIN.id,0,2],[2200,OSPLINT.id,0,1],[4e3,OPLATE.id,0,1],[9e3,OPLATEARMOR.id,0,1],[26e3,OSSPLATE.id,0,1],[1500,OSHIELD.id,0,1],[5e4,OELVENCHAIN.id,0,0],[1e4,OORB.id,0,0],[1e5,OSLAYER.id,0,0],[20,ODAGGER.id,0,3],[200,OSPEAR.id,0,3],[800,OFLAIL.id,0,2],[1500,OBATTLEAXE.id,0,2],[4500,OLONGSWORD.id,0,2],[1e4,O2SWORD.id,0,2],[5e4,OSWORD.id,0,1],[2e5,OLANCE.id,0,1],[2e4,OSWORDofSLASHING.id,0,0],[75e3,OHAMMER.id,0,0],[1500,OPROTRING.id,1,1],[850,OSTRRING.id,1,1],[1200,ODEXRING.id,1,1],[1200,OCLEVERRING.id,1,1],[1800,OENERGYRING.id,0,1],[1250,ODAMRING.id,0,1],[2200,OREGENRING.id,0,1],[1e4,ORINGOFEXTRA.id,0,1],[2800,OBELT.id,0,1],[4e3,OAMULET.id,0,1],[5e3,OCUBEofUNDEAD.id,0,0],[6e3,ONOTHEFT.id,0,0],[5900,OCHEST.id,3,1],[2e3,OBOOK.id,2,1],[100,OCOOKIE.id,0,3],[6660,OHANDofFEAR.id,0,0],[200,OPOTION.id,0,6],[900,OPOTION.id,1,5],[5200,OPOTION.id,2,1],[1e3,OPOTION.id,3,2],[500,OPOTION.id,4,2],[1500,OPOTION.id,5,2],[700,OPOTION.id,6,1],[300,OPOTION.id,7,7],[2e3,OPOTION.id,8,1],[500,OPOTION.id,9,1],[800,OPOTION.id,10,1],[300,OPOTION.id,11,3],[200,OPOTION.id,12,5],[400,OPOTION.id,13,3],[350,OPOTION.id,14,2],[5200,OPOTION.id,15,1],[900,OPOTION.id,16,2],[2e3,OPOTION.id,17,2],[2200,OPOTION.id,18,4],[800,OPOTION.id,19,6],[3700,OPOTION.id,20,3],[500,OPOTION.id,22,1],[1500,OPOTION.id,23,3],[8500,OORBOFDRAGON.id,0,0],[7500,OSPIRITSCARAB.id,0,0],[8e4,OVORPAL.id,0,0],[1e3,OSCROLL.id,0,2],[1250,OSCROLL.id,1,2],[600,OSCROLL.id,2,4],[100,OSCROLL.id,3,4],[1e3,OSCROLL.id,4,3],[2e3,OSCROLL.id,5,2],[1100,OSCROLL.id,6,1],[5e3,OSCROLL.id,7,2],[2e3,OSCROLL.id,8,2],[2500,OSCROLL.id,9,4],[200,OSCROLL.id,10,5],[300,OSCROLL.id,11,3],[3400,OSCROLL.id,12,1],[3400,OSCROLL.id,13,1],[3e3,OSCROLL.id,14,2],[4e3,OSCROLL.id,15,2],[5e3,OSCROLL.id,16,2],[1e4,OSCROLL.id,17,1],[5e3,OSCROLL.id,18,1],[3400,OSCROLL.id,19,2],[2200,OSCROLL.id,20,3],[39e3,OSCROLL.id,21,0],[6100,OSCROLL.id,22,1],[3e4,OSCROLL.id,23,0],[3e3,OSPHTALISMAN.id,0,0],[1500,OWWAND.id,0,0],[500,OBRASSLAMP.id,0,0],[95e3,OPSTAFF.id,0,0],[1e5,OLIFEPRESERVER.id,0,0]];function enter(){debug("enter(): entering a building"),mazeMode=!1;var e=itemAt(player.x,player.y);e.matches(OSCHOOL)?oschool():e.matches(OBANK)?obank():e.matches(OBANK2)?obank2():e.matches(ODNDSTORE)?dndstore():e.matches(OENTRANCE)?dungeon():e.matches(OTRADEPOST)?otradepost():e.matches(OLRS)?olrs():e.matches(OHOME)?ohome():e.matches(OVOLUP)?act_up_shaft():e.matches(OVOLDOWN)?act_down_shaft():e.matches(OPAD)?opad():(debug("enter(): no building here"),setMazeMode(!0),updateLog("There is no place to enter here!"))}function dungeon(){setMazeMode(!0),player.x=33,player.y=MAXY-2,newcavelevel(1),player.level.know[33][MAXY-1]=KNOWALL,player.level.monsters[33][MAXY-1]=null,showcell(player.x,player.y)}var dndindex=0;function dndstore(){initpricelist(),"Rob the Warrior of Doom"===logname?(0==dndindex&&clear(),cursor(1,1)):clear(),lprcat("Welcome to the ".concat(GAMENAME," Thrift Shoppe.  We stock many items explorers find useful\n")),lprcat("in their adventures.  Feel free to browse to your hearts content.\n"),lprcat("Also be advised, if you break 'em, you pay for 'em.");for(var e=dndindex;e<26+dndindex;e++)dnditem(e);updategold(),setCharCallback(dnd_parse)}function updategold(){cursor(50,19),lprcat("You have ".concat(Number(player.GOLD).toLocaleString()," gold pieces")),cltoeoln(),lprcat("\n\nEnter your transaction [<b>space</b> for next page, <b>escape</b> to leave] ")}function dnd_parse(e){if(e==ESC)return dndindex=0,exitbuilding();if(" "==e)return(dndindex+=26)>=MAXITM&&(dndindex=0),dndstore(),0;if(!isalpha(e))return 0;var t=getIndexFromChar(e);if(!(0<=t&&t<=26))return 0;if(MAXITM<=(t+=dndindex))storemessage("Sorry, but we are out of that item".concat(period),700);else if(dnd_item[t].qty<=0)storemessage("Sorry, but we are out of that item".concat(period),700);else if(pocketfull())storemessage("You can't carry anything more!",700);else{if(!(player.GOLD<dnd_item[t].price)){player.setGold(player.GOLD-dnd_item[t].price),dnd_item[t].qty--;var a=createObject(dnd_item[t].itemId,dnd_item[t].arg);take(a);var r=getCharFromIndex(player.inventory.indexOf(a));return a.matches(OSCROLL)&&learnScroll(a),a.matches(OPOTION)&&learnPotion(a),ULARN||!a.matches(OBOOK)&&!a.matches(OCHEST)||(!!PARAMS.unbalance&&"true"==PARAMS.unbalance?debug_used=!0:a.arg=Math.max(1,a.arg-getDifficulty())),storemessage("  You pick up: ".concat(r,") ").concat(a).concat(period),1e3),0==dnd_item[t].qty&&dnditem(t),updategold(),lprc(e),0}storemessage("You don't have enough gold to pay for that!",700)}}function dnditem(e){var t,a,r;e<0||MAXITM<=e||(cursor(t=40*(1&e)+1,a=5+(e%26>>1)),0!=dnd_item[e].qty?(r=createObject(dnd_item[e].itemId,dnd_item[e].arg),lprcat("".concat(getCharFromIndex(e%26),") ")),r.matches(OPOTION)||r.matches(OSCROLL)?lprintf("".concat(r.toString(!0).substring(8))):lprcat("".concat(r.toString(!0))),cursor(31+t,a),lprintf(dnd_item[e].price.toString(),6)):lprintf("",39))}function obank(){banktitle("Welcome to the First National Bank of ".concat(GAMENAME,"."))}function obank2(){banktitle("Welcome to the ".concat(ULARN?8:5,"th level branch office of the First National Bank of ").concat(GAMENAME,".")),player.TELEFLAG=0}function banktitle(e){clear(),lprcat(e),lprcat("\n\n   Gemstone                 Appraisal      Gemstone                 Appraisal"),obanksub(),paint()}var gemorder=[],gemvalue=[];function obanksub(){var e,t;for(gemorder=[],gemvalue=[],ointerest(),t=e=0;e<26;e++){var a=player.inventory[e];a&&(a.isGem()||a.matches(OLARNEYE))?(a.matches(OLARNEYE)?gemvalue[e]=Math.max(5e4,25e4-7*gtime/100*100):gemvalue[e]=100*a.arg,cursor((gemorder[e]=t)%2*40+1,4+(t>>1)),lprcat("".concat(getCharFromIndex(e),") ").concat(a)),cursor(t%2*40+32,4+(t>>1)),lprintf("".concat(gemvalue[e]),6),t++):(gemvalue[e]=0,gemorder[e]=0)}bank_print_gold(),cl_dn(1,21),lprcat("\nYour wish? [(<b>d</b>) deposit, (<b>w</b>) withdraw, (<b>s</b>) sell a stone, or <b>escape</b>] "),setCharCallback(bank_parse)}function bank_print_gold(){cursor(31,17),cltoeoln(),lprcat("You have ".concat(Number(player.BANKACCOUNT).toLocaleString()," gold pieces in the bank")),cursor(31,18),cltoeoln(),lprcat("You have ".concat(Number(player.GOLD).toLocaleString()," gold pieces")),player.BANKACCOUNT+player.GOLD>=MAX_BANK_BALANCE&&(lprcat("\n\nNote: "),lprcat(ULARN?"Only ":"Larndom law states that only "),lprcat("deposits under ".concat(Number(MAX_BANK_BALANCE).toLocaleString(),"gp can earn interest")))}function bank_parse(e){if(e==ESC)return exitbuilding();"d"==e&&(lprcat("deposit".concat(period,"\n")),cltoeoln(),lprcat("How much? [<b>*</b> for all] "),setNumberCallback(bank_deposit,!0)),"w"==e&&(lprcat("withdraw".concat(period,"\n")),cltoeoln(),lprcat("How much? [<b>*</b> for all] "),setNumberCallback(bank_withdraw,!0)),"s"==e&&(lprcat("sell".concat(period,"\n")),cltoeoln(),lprcat("Which stone would you like to sell? [<b>*</b> for all] "),setCharCallback(bank_sell))}function bankmessage(e,t){mazeMode||(cl_dn(1,""==t?23:24),bank_print_gold(),cursor(1,24),lprcat(e),cursor(73,22),cltoeoln(),setCharCallback(bank_parse),blt(),napping=!1,t&&0!=t&&(napping=!0,setTimeout(bankmessage,t,"",0)))}function bank_deposit(e){return e==ESC?bankmessage("  cancelled".concat(period),700):("*"==e&&(e=player.GOLD),(e=Number(e))<0?bankmessage("Sorry, but we can't take negative gold!",700):e>player.GOLD?bankmessage("You don't have that much".concat(period),700):(player.setGold(player.GOLD-e),player.BANKACCOUNT+=e,bankmessage("",700))),1}function bank_withdraw(e){return e==ESC?bankmessage("  cancelled".concat(period),700):("*"==e&&(e=player.BANKACCOUNT),(e=Number(e))<0?bankmessage("Sorry, but we don't have any negative gold!",700):e>player.BANKACCOUNT?bankmessage("You don't have that much in the bank!",700):(player.setGold(player.GOLD+e),player.BANKACCOUNT-=e,bankmessage("",700))),1}function bank_sell(e){if(e==ESC)bankmessage("  cancelled".concat(period),700);else if("*"==e){var t=!1;for(let e=0;e<26;e++)t|=sellGem(e);t||bankmessage("You have no gems to sell!",700)}else{e=getIndexFromChar(e);sellGem(e)||bankmessage("Item ".concat(getCharFromIndex(e)," is not a gemstone!"),700)}return 1}function sellGem(e){let t=player.inventory[e];if(t&&(t.isGem()||t.matches(OLARNEYE))){player.setGold(player.GOLD+gemvalue[e]),player.inventory[e]=null,gemvalue[e]=0;e=gemorder[e];return cursor(e%2*40+1,4+(e>>1)),lprintf("",39),bankmessage("",700),!0}return!1}function ointerest(){if(player.BANKACCOUNT<0&&(player.BANKACCOUNT=0),0<player.BANKACCOUNT&&player.BANKACCOUNT<MAX_BANK_BALANCE){for(var e=elapsedtime()-lasttime;0<e--&&player.BANKACCOUNT<MAX_BANK_BALANCE;)player.BANKACCOUNT+=player.BANKACCOUNT/(ULARN?877:250);player.BANKACCOUNT=Math.min(MAX_BANK_BALANCE,player.BANKACCOUNT)}lasttime=elapsedtime(),player.BANKACCOUNT=Math.floor(player.BANKACCOUNT)}var tradorder=[];function otradiven(){for(var e=player.inventory,t=0,a=0;t<26;t++){var r,o=e[t];o?(cursor(a%2*40+1,8+(a>>1)),tradorder[t]=0,o.matches(OPOTION)&&!isKnownPotion(o)||o.matches(OSCROLL)&&!isKnownScroll(o)||(tradorder[t]=a++,r=!o.isRing()&&o!=player.WIELD&&o!=player.WEAR&&o!=player.SHIELD,lprcat("".concat(getCharFromIndex(t),") ").concat(o.toString(r)).substring(0,39)))):tradorder[t]=0}}function otradepost(){setCharCallback(parse_tradepost),initpricelist(),clear(),lprcat("Welcome to the ".concat(GAMENAME," Trading Post. We buy items that explorers no longer find\n")),lprcat("useful. Since the condition of the items you bring in is not certain,\n"),lprcat("and we incur great expense in reconditioning the items, we usually pay\n"),lprcat("only 20% of their value were they to be new. If the items are badly\n"),lprcat("damaged, we will pay only 10% of their new value.\n\n"),lprcat("Here are the items we would be willing to buy from you:\n"),otradiven(),cl_dn(1,21),lprcat("\nWhat item do you want to sell to us? [Press <b>escape</b> to leave] ")}function cleartradiven(e){var t=tradorder[e];cursor(t%2*40+1,8+(t>>1)),lprintf(" ",39),tradorder[e]=0}function parse_tradepost(e){if(e==ESC)return exitbuilding();if(!isalpha(e))return 0;var t=0,a=getIndexFromChar(e);if(player.hasPickedUpPotion)return storemessage("Sorry friend, the shop is closed. It's time to go home now.",1500),0;if(!(0<=a&&a<=26))return storemessage("Sorry, but we are not authorized to accept that item".concat(period),700),0;var r=player.inventory[a];if(!r)return storemessage("You don't have item ".concat(e,"!"),700),0;if(r.matches(OSCROLL)&&!isKnownScroll(r)||r.matches(OPOTION)&&!isKnownPotion(r))return storemessage("Sorry, we can't accept unidentified objects".concat(period),700),0;if(r.isDrug())return storemessage("Sorry, we don't accept contraband".concat(period),700),0;if(r.matches(OLANCE)&&player.ramboflag)return storemessage("You don't *really* want to sell that, now do you?",1e3),0;if(r.isGem())t=20*r.arg;else if(r.matches(OLARNEYE))t=Math.max(1e4,5e4-7*gtime/100*20);else{for(var o=MAXITM,n=0;n<MAXITM;n++)if(dnd_item[n].itemId==r.id){o=n;break}if(o==MAXITM)return storemessage("Sorry, we can't accept unidentified objects".concat(period),700),0;if(r.matches(OSCROLL)||r.matches(OPOTION))r.matches(OPOTION)&&21<r.arg&&--n,t=.2*dnd_item[n+r.arg].price;else{var i=r.arg,t=.1*dnd_item[n].price;for(0<=i&&(t*=2);0<i--&&(t=14*(67+t)/10)<5e5;);}}t=Math.floor(t),storemessage("Item (".concat(e,") is worth ").concat(Number(t).toLocaleString()," gold pieces to us. Do you want to sell it?")),(itemToSell=[])[SELL_PRICE]=t,itemToSell[SELL_ITEM]=r,setCharCallback(parse_sellitem)}var itemToSell=null;const SELL_PRICE=0,SELL_ITEM=1;function parse_sellitem(e){var t=Number(itemToSell[SELL_PRICE]).toLocaleString();return e==ESC||"N"==e||"n"==e?(cursor(63+t.length,24),setCharCallback(parse_tradepost),lprcat("no thanks".concat(period)),napping=!0,setTimeout(storemessage,700,""),itemToSell=null,1):"Y"!=e&&"y"!=e?0:(cursor(63+t.length,24),setCharCallback(parse_tradepost),lprcat("yes".concat(period)),napping=!0,setTimeout(storemessage,700,""),player.setGold(player.GOLD+itemToSell[SELL_PRICE]),cleartradiven(player.inventory.indexOf(itemToSell[SELL_ITEM])),destroyInventory(itemToSell[SELL_ITEM]),itemToSell=null,1)}const coursetime=[10,15,10,20,10,10,10,5];function oschool(){setCharCallback(parse_class),napping=!1,printclasses(),cl_dn(1,19),cursor(1,20),lprcat("What is your choice? [Press <b>escape</b> to leave] "),blt()}function printclasses(){cl_up(1,18),cursor(1,1),lprcat("The College of ".concat(GAMENAME," offers the exciting opportunity of higher education to\n")),lprcat("all inhabitants of the caves. Here is the class schedule:\n\n\n"),lprcat("                      Course Name               Time Needed\n\n"),course[0]||lprcat("                  a)  Fighter Training I          10 mobuls"),lprc("\n"),course[1]||lprcat("                  b)  Fighter Training II         15 mobuls"),lprc("\n"),course[2]||lprcat("                  c)  Introduction to Wizardry    10 mobuls"),lprc("\n"),course[3]||lprcat("                  d)  Applied Wizardry            20 mobuls"),lprc("\n"),course[4]||lprcat("                  e)  Behavioral Psychology       10 mobuls"),lprc("\n"),course[5]||lprcat("                  f)  Faith for Today             10 mobuls"),lprc("\n"),course[6]||lprcat("                  g)  Contemporary Dance          10 mobuls"),lprc("\n"),course[7]||lprcat("                  h)  History of ".concat(GAMENAME).concat(ULARN?"":" ","             5 mobuls")),lprcat("\n\n                  All courses cost 250 gold pieces"),cursor(30,18),lprcat("You are presently carrying ".concat(Number(player.GOLD).toLocaleString()," gold pieces"))}function parse_class(e){if(e==ESC)return exitbuilding();var t=700;if(!isalpha(e))return 0;lprc("".concat(e));var a=getIndexFromChar(e);if(cursor(1,21),a<0||8<=a||course[a])lprcat("\nSorry, but that class is filled".concat(period));else if(player.GOLD<250)lprcat("\nYou don't have enough gold to pay for that!");else{player.setGold(player.GOLD-250);var r=0;switch(e){case"a":player.setStrength(player.STRENGTH+2),player.setConstitution(player.CONSTITUTION+1),lprcat("\nYou feel stronger!");break;case"b":if(!course[0]){player.setGold(player.GOLD+250),r=-1e4,lprcat("\nSorry, but this class has a prerequisite of Fighter Training I".concat(period));break}player.setStrength(player.STRENGTH+2),player.setConstitution(player.CONSTITUTION+2),lprcat("\nYou feel much stronger!");break;case"c":player.setIntelligence(player.INTELLIGENCE+2),lprcat("\nThe task before you now seems more attainable!");break;case"d":if(!course[2]){player.setGold(player.GOLD+250),r=-1e4,lprcat("\nSorry, but this class has a prerequisite of Introduction to Wizardry".concat(period));break}player.setIntelligence(player.INTELLIGENCE+2),lprcat("\nThe task before you now seems very attainable!");break;case"e":player.setCharisma(player.CHARISMA+3),lprcat("\nYou now feel like a born leader!");break;case"f":player.setWisdom(player.WISDOM+2),lprcat("\nYou now feel more confident that you can find the potion in time!");break;case"g":player.setDexterity(player.DEXTERITY+3),lprcat("\nYou feel like dancing!");break;case"h":player.setIntelligence(player.INTELLIGENCE+1),ULARN?lprcat("\nWow! e = mc^2!"):(lprcat("\nYour instructor told you that the Eye of Larn is rumored to be guarded"),lprcat("\nby a platinum dragon who possesses psionic abilities".concat(period)))}0<(r+=100*coursetime[a])&&(gtime+=r,course[a]=1,player.raisehp(player.HPMAX-player.HP),player.setSpells(player.SPELLMAX),player.BLINDCOUNT&&(player.BLINDCOUNT=1),player.CONFUSE&&(player.CONFUSE=1),adjtime(r),t+=200)}return printclasses(),blt(),setTimeout(oschool,t),napping=!0,0}async function ohome(){var e=isCarrying(createObject(OPOTION,21)),t=gtime<=TIMELIMIT;try{if(e||!t){let e=window.location.href.split("?")[0];e=e.split("/larn.html")[0]+"/tv/?gameid=".concat(gameID),updateLog("Replay Link: <b><a href='".concat(e,"'>").concat(e,"</a></b>"))}}catch(e){}return setMazeMode(!1),napping=!1,dropflag=1,setCharCallback(parse_home),e&&(lprint("Congratulations. You found the potion of cure dianthroritis!\n\n"),await nap(1e3),lprint("Frankly, No one thought you could do it. Boy! Did you surprise them!\n\n"),await nap(1e3)),e&&t?(lprint("The doctor is now administering the potion, and in a few moments\n"),lprint("your daughter should be well on her way to recovery.\n\n"),await nap(1e3),lprint("Press <b>enter</b> to continue: "),napping=!1,setCharCallback(win),void paint()):e&&!t?(ULARN?(lprint("However... the doctor has the sad duty to inform you that your daughter\n"),lprint("has died! You didn't make it in time. In your agony, you kill the doctor,\nyour "),"Male"===player.gender?lprcat("wife"):"Female"==player.gender?lprcat("husband"):lprcat("partner"),lprint(" and yourself! Too bad...\n\n")):(lprint("The doctor has the sad duty to inform you that your daughter died before\n"),lprint("your return. There was nothing that could be done without the potion.\n\n")),await nap(2e3),napping=!1,void died(DIED_FAILED,!1)):(!e&&t&&(cursor(1,7),lprcat("     Welcome home ".concat(logname,".")),lprcat("\n\n     The latest word from the doctor is not good."),lprcat("\n\n     The diagnosis is confirmed as dianthroritis. The doctor guesses that"),lprcat("\n     your daughter has only ".concat(timeleft()," mobuls left in this world. It's up to you,")),lprcat("\n     ".concat(logname,", to find the only hope for your daughter, the")),lprcat("\n     very rare potion of cure dianthroritis. It is rumored that only deep"),lprcat("\n     in the depths of the caves can this potion be found."),lprcat("\n\n     Press <b>escape</b> to leave: "),paint(),napping=!1),void(e||t||(lprint("Welcome home ".concat(logname,".\n\n")),await nap(1e3),lprint("The latest word from the doctor is not good.\n\n"),await nap(1e3),ULARN?(lprint("The doctor has the sad duty to inform you that your daughter has died!\n"),lprint("You didn't make it in time. In your agony, you kill the doctor, your\n"),"Male"==player.gender?lprcat("wife"):"Female"==player.gender?lprcat("husband"):lprcat("partner"),lprint(" and yourself! Too bad...\n\n")):(lprint("The doctor has the sad duty to inform you that your daughter died! You didn't\n"),lprint("make it in time. There was nothing that could be done without the potion.\n\n")),await nap(2e3),napping=!1,died(DIED_FAILED,!1))))}function parse_home(e){if(e==ESC&&!GAMEOVER)return exitbuilding()}async function win(e){return e!=ENTER?0:(napping=!0,cursor(1,8),cltoeoln(),lprint("The potion is"),await nap(500),lprint("."),await nap(1e3),lprint("."),await nap(1e3),lprint("."),await nap(1e3),lprint(" working!\n\n"),lprintf("The doctor thinks that your daughter will recover in a few days.\n"),lprintf("Congratulations!\n\n"),await nap(2e3),napping=!1,died(DIED_WINNER,!1),1)}function parse_lrs(e){if(e==ESC)return exitbuilding();"p"==e&&(setNumberCallback(parse_lrs_pay,!0),lprcat("pay taxes".concat(period,"\nHow much? ")))}function parse_lrs_pay(e){(e=Number(e))>player.GOLD?lprcat("\n  You don't have that much".concat(period,"\n")):(e=paytaxes(e),player.setGold(player.GOLD-e),lprcat("\n  You pay ".concat(e," gold pieces").concat(period,"\n"))),setTimeout(olrs,700)}function olrs(){setCharCallback(parse_lrs),clear(),cursor(1,4),lprcat("Welcome to the ".concat(GAMENAME," Revenue Service district office  ")),cursor(1,6),lprcat(0<outstanding_taxes?"You presently owe ".concat(outstanding_taxes," gold pieces in taxes  "):"You do not owe us any taxes           "),cursor(1,8),0<player.GOLD?lprcat("You have ".concat(Number(player.GOLD).toLocaleString()," gold pieces    ")):lprcat("You have no gold pieces  "),cursor(1,20),lprcat("How can we help you? [(<b>p</b>) pay taxes, or <b>escape</b>] "),blt()}function exitbuilding(){return setMazeMode(!0),1}function storemessage(e,t){mazeMode||(cursors(),cltoeoln(),lprcat(e),cursor(59,21),blt(),napping=!1,t&&0!=t&&(napping=!0,setTimeout(storemessage,t,"",0)))}function initpricelist(){if(!dnd_item){dnd_item=[];for(var e=0;e<STORE_INVENTORY.length;e++){var t=STORE_INVENTORY[e];dnd_item[e]=new DNDItem(t[0],t[1],t[2],t[3])}}}var drug=[!0,!0,!0,!0,!0];function pad_hd(){cl_up(1,18),cursor(1,1),lprcat("Hey man, welcome to Dealer McDope's Pad! I gots the some of the finest shit\n"),lprcat("you'll find anywhere in Ularn -- check it out...\n\n\n"),lprcat("                    The Stash                   The Cash\n\n"),drug[0]&&lprcat("                a)  Killer Speed                100 bucks"),lprc("\n"),drug[1]&&lprcat("                b)  Groovy Acid                 250 bucks"),lprc("\n"),drug[2]&&lprcat("                c)  Monster Hash                500 bucks"),lprc("\n"),drug[3]&&lprcat("                d)  Trippy Shrooms              1000 bucks"),lprc("\n"),drug[4]&&lprcat("                e)  Cool Coke                   5000 bucks"),lprc("\n");var e=1==player.GOLD?"":"s";cursor(30,18),lprcat("Looks like you got about ".concat(player.GOLD," buck").concat(e," on you.   ")),lprcat("\n\nSo, whaddya want [<b>escape</b> to split] ?")}function opad(){clear(),pad_hd(),setCharCallback(parse_mcdopes)}function parse_mcdopes(e){if(e==ESC)return exitbuilding();if(!isalpha(e))return!1;switch(cursor(39,20),lprc("".concat(e,"\n")),e){case"a":dodeal(OSPEED,100,0);break;case"b":dodeal(OACID,250,1);break;case"c":dodeal(OHASH,500,2);break;case"d":dodeal(OSHROOMS,1e3,3);break;case"e":dodeal(OCOKE,5e3,4)}return pad_hd(),!1}function dodeal(e,t,a){drug[a]?player.GOLD<t?nocash():snag(e)&&(player.GOLD-=t,drug[a]=!1):nomore()}function snag(e){return pocketfull()?(lprcat("\nHey, you can't carry any more."),cltoeoln(),!1):(take(createObject(e)),lprcat("\nOk, here ya go."),cltoeoln(),!0)}function nomore(){lprcat("\nSorry man, I ain't got no more of that shit."),cltoeoln()}function nocash(){lprcat("\nWhattaya trying to pull on me? You aint got the cash!"),cltoeoln()}function doSpeed(){appendLog(" snort!"),updateLog("Ohwowmanlikethingstotallyseemtoslowdown!"),player.updateHasteSelf(200+player.LEVEL),player.HALFDAM+=300+rnd(200),player.setIntelligence(player.INTELLIGENCE-2),player.setWisdom(player.WISDOM-2),player.setConstitution(player.CONSTITUTION-2),player.setDexterity(player.DEXTERITY-2),player.setStrength(player.STRENGTH-2)}function eatShrooms(){appendLog(" eat!"),updateLog("Things start to get real spacey..."),player.HASTEMONST+=rnd(75)+25,player.CONFUSE+=30+rnd(10),player.setWisdom(player.WISDOM+2),player.setCharisma(player.CHARISMA+2)}function dropAcid(){appendLog(" eat!"),updateLog("You are now frying your ass off!"),player.CONFUSE+=30+rnd(10),player.setIntelligence(player.INTELLIGENCE+2),player.setWisdom(player.WISDOM+2),player.AWARENESS+=1500,player.AGGRAVATE+=1500;for(let t=0;t<MAXY;t++)for(let e=0;e<MAXX;e++)player.level.monsters[e][t]&&(player.level.monsters[e][t].hitpoints=monsterlist[player.level.monsters[e][t].arg].hitpoints)}function smokeHash(){appendLog(" smoke!"),updateLog("WOW! You feel stooooooned..."),player.HASTEMONST+=rnd(75)+25,player.setIntelligence(player.INTELLIGENCE+2),player.setWisdom(player.WISDOM+2),player.setConstitution(player.CONSTITUTION-2),player.setDexterity(player.DEXTERITY-2),player.HALFDAM+=300+rnd(200),player.CLUMSINESS+=rnd(1800)+200}function doCoke(){appendLog(" snort!"),updateLog("Your nose begins to bleed!"),player.setDexterity(player.DEXTERITY-2),player.setConstitution(player.CONSTITUTION-2),player.setCharisma(player.CHARISMA+3),player.setStrength(player.STRENGTH+33),player.setIntelligence(player.INTELLIGENCE+33),player.setWisdom(player.WISDOM+33),player.setConstitution(player.CONSTITUTION+33),player.setDexterity(player.DEXTERITY+33),player.setCharisma(player.CHARISMA+33),player.COKED+=10}function saveGame(e){var t=e?"checkpoint":logname;let a;var r=player.level;player.level=null;try{var o=new GameState(!0);"checkpoint"!=t&&(a=localStorageSetObject(t,o)),localStorageSetObject(t+"backup",o)}catch(a){console.log("saveGame(): caught: ".concat(a))}o=JSON.stringify(o);if(player.level=r,!e){if(a)return updateLog("".concat(a)),updateLog("Sorry, your game couldn't be saved! Are cookies disabled?"),!1;updateLog("Game saved. ".concat(Number(o.length).toLocaleString()," bytes written."))}return!0}function loadSavedGame(t,a){if(t){loadState(t);var r=player.level;player.level=null;var o=JSON.stringify(t),t=new GameState(!1),t=JSON.stringify(t);let e=new diff_match_patch;var n=e.diff_main(o,t);if(e.diff_cleanupSemantic(n),player.level=r,1!=n.length)try{let a="".concat(BUILD," ").concat(GAMENAME," failed integrity check, current.length:").concat(t.length,", saved.length:").concat(o.length," diff=\n");for(let t=0;t<n.length;t++){let e=n[t][1];200<e.length&&(e="".concat(e.substring(0,100),"\n   ...\n   ").concat(e.substring(e.length-100))),a+="".concat(t,": ").concat(e,"\n")}console.log("".concat(a)),Rollbar.error("".concat(a))}catch(e){console.log("failed integrity check: caught: ".concat(e))}localStorageRemoveItem(logname),localStorageRemoveItem("checkpoint"),updateLog(a?"Did you quit accidentally? I restored your last game just in case.":"Welcome back. (Your save file has now been been deleted)"),game_started=!0}else updateLog("Sorry, your saved game can't be found!")}function loadState(e){loadLevels(e.LEVELS);var t=e.LOG;LOG=t;t=e.player;(player=loadPlayer(t)).level=LEVELS[e.level],setRecordingInfo(e.recording),newsphereflag=e.newsphereflag,GAMEOVER=e.GAMEOVER,mazeMode=e.mazeMode,napping=e.napping,original_objects=e.original_objects,keyboard_hints=e.keyboard_hints,auto_pickup=e.auto_pickup,side_inventory=e.side_inventory,show_color=e.show_color,bold_objects=e.bold_objects,dnd_item=e.dnd_item,genocide=e.genocide,amiga_mode=e.amiga_mode,gameID=e.gameID,setMode(amiga_mode,retro_mode,original_objects),debug_used=e.debug_used,logname=e.logname,cheat=e.cheat,level=e.level,wizard=e.wizard,gtime=e.gtime,setDifficulty(e.HARDGAME),lastmonst=e.lastmonst,lastnum=e.lastnum,hitflag=e.hitflag,lastpx=e.lastpx,lastpy=e.lastpy,lasthx=e.lasthx,lasthy=e.lasthy,prayed=e.prayed,course=e.course,outstanding_taxes=e.outstanding_taxes,dropflag=e.dropflag,rmst=e.rmst,nomove=e.nomove,viewflag=e.viewflag,lasttime=e.lasttime,w1x=e.w1x,w1y=e.w1y,spheres=e.spheres}function loadLevels(e){for(var t=0;t<MAXLEVEL+MAXVLEVEL;t++)if(e[t]){debug("loading: ".concat(t));for(var a=e[t],r=initGrid(MAXX,MAXY),o=initGrid(MAXX,MAXY),n=0;n<MAXX;n++)for(var i=0;i<MAXY;i++)r[n][i]=createObject(a.items[n][i]),o[n][i]=createMonster(a.monsters[n][i]);LEVELS[t]=Object.create(Level),LEVELS[t].items=r,LEVELS[t].monsters=o,LEVELS[t].know=a.know}else LEVELS[t]=null}function loadPlayer(e){var t=new Player;t.WEAR=null,t.WIELD=null,t.SHIELD=null;for(var a=0;a<26;a++){var r=e.inventory[a];t.inventory[a]=r?createObject(r):null,r&&(e.SHIELD&&e.SHIELD.id==r.id&&e.SHIELD.arg==r.arg&&(t.SHIELD=t.inventory[a]),e.WIELD&&e.WIELD.id==r.id&&e.WIELD.arg==r.arg&&(t.WIELD=t.inventory[a]),e.WEAR&&e.WEAR.id==r.id&&e.WEAR.arg==r.arg&&(t.WEAR=t.inventory[a]))}return t.gender=e.gender,t.char_picked=e.char_picked,t.ramboflag=e.ramboflag,t.knownPotions=e.knownPotions,t.knownScrolls=e.knownScrolls,t.knownSpells=e.knownSpells,t.char=e.char,t.x=e.x,t.y=e.y,t.STRENGTH=e.STRENGTH,t.START_STRENGTH=e.START_STRENGTH,t.INTELLIGENCE=e.INTELLIGENCE,t.WISDOM=e.WISDOM,t.CONSTITUTION=e.CONSTITUTION,t.DEXTERITY=e.DEXTERITY,t.CHARISMA=e.CHARISMA,t.HPMAX=e.HPMAX,t.HP=e.HP,t.GOLD=e.GOLD,t.EXPERIENCE=e.EXPERIENCE,t.LEVEL=e.LEVEL,t.REGEN=e.REGEN,t.WCLASS=e.WCLASS,t.AC=e.AC,t.BANKACCOUNT=e.BANKACCOUNT,t.SPELLMAX=e.SPELLMAX,t.SPELLS=e.SPELLS,t.ENERGY=e.ENERGY,t.ECOUNTER=e.ECOUNTER,t.MOREDEFENSES=e.MOREDEFENSES,t.PROTECTIONTIME=e.PROTECTIONTIME,t.REGENCOUNTER=e.REGENCOUNTER,t.MOREDAM=e.MOREDAM,t.DEXCOUNT=e.DEXCOUNT,t.STRCOUNT=e.STRCOUNT,t.BLINDCOUNT=e.BLINDCOUNT,t.CONFUSE=e.CONFUSE,t.ALTPRO=e.ALTPRO,t.HERO=e.HERO,t.COKED=e.COKED,t.CHARMCOUNT=e.CHARMCOUNT,t.INVISIBILITY=e.INVISIBILITY,t.CANCELLATION=e.CANCELLATION,t.HASTESELF=e.HASTESELF,t.AGGRAVATE=e.AGGRAVATE,t.GLOBE=e.GLOBE,t.TELEFLAG=e.TELEFLAG,t.SCAREMONST=e.SCAREMONST,t.AWARENESS=e.AWARENESS,t.HOLDMONST=e.HOLDMONST,t.TIMESTOP=e.TIMESTOP,t.HASTEMONST=e.HASTEMONST,t.GIANTSTR=e.GIANTSTR,t.FIRERESISTANCE=e.FIRERESISTANCE,t.SPIRITPRO=e.SPIRITPRO,t.UNDEADPRO=e.UNDEADPRO,t.STEALTH=e.STEALTH,t.ITCHING=e.ITCHING,t.LAUGHING=e.LAUGHING,t.DRAINSTRENGTH=e.DRAINSTRENGTH,t.CLUMSINESS=e.CLUMSINESS,t.INFEEBLEMENT=e.INFEEBLEMENT,t.HALFDAM=e.HALFDAM,t.SEEINVISIBLE=e.SEEINVISIBLE,t.WTW=e.WTW,t.STREXTRA=e.STREXTRA,t.LIFEPROT=e.LIFEPROT,t.LAMP=e.LAMP,t.WAND=e.WAND,t.SLAYING=e.SLAYING,t.NEGATESPIRIT=e.NEGATESPIRIT,t.CUBEofUNDEAD=e.CUBEofUNDEAD,t.NOTHEFT=e.NOTHEFT,t.TALISMAN=e.TALISMAN,t.HAND=e.HAND,t.ORB=e.ORB,t.ELVEN=e.ELVEN,t.SLASH=e.SLASH,t.BESSMANNINTEL=e.BESSMANNINTEL,t.BESSMANN=e.BESSMANN,t.SLAY=e.SLAY,t.VORPAL=e.VORPAL,t.STAFF=e.STAFF,t.PRESERVER=e.PRESERVER,t.PAD=e.PAD,t.ELEVDOWN=e.ELEVDOWN,t.ELEVUP=e.ELEVUP,t.MOVESMADE=e.MOVESMADE,t.SPELLSCAST=e.SPELLSCAST,t.MONSTKILLED=e.MONSTKILLED,t.hasPickedUpPotion=e.hasPickedUpPotion,t}function learnSpell(e){var t=spelcode.indexOf(e);return player.knownSpells[t]=e,t}function forgetSpell(e){player.knownSpells[e]=null}var splev,spelweird,newSpellCode=null;function pre_cast(){cursors(),nomove=1,0<player.SPELLS?(updateLog("Enter your spell: "),setCharCallback(cast)):updateLog("You don't have any spells!")}function matchesSpell(e){for(var t=0;t<spelcode.length;t++)if(spelcode[t]===e)return!0;return!1}function getSpellCode(e,t){if("I"==e||" "==e)return seemagic(!0,t),setCharCallback(parse_see_spells),0;if(e==DEL&&newSpellCode&&1<=newSpellCode.length){newSpellCode=newSpellCode.substring(0,newSpellCode.length-1);t=deleteLog();return updateLog(t.substring(0,t.length-1)),0}return e==ESC?(appendLog("  aborted".concat(period)),newSpellCode=null,1):isalpha(e)||matchesSpell(e)?(newSpellCode=newSpellCode||"",newSpellCode+=e,appendLog(e),newSpellCode.length<3?0:newSpellCode):0}function cast(e){e=getSpellCode(e,!(nomove=1));if(e!==newSpellCode)return e;player.setSpells(player.SPELLS-1),player.SPELLSCAST++;e=player.knownSpells.indexOf(newSpellCode.toLowerCase());return 0<=e?speldamage(e):(nomove=0,updateLog("  Nothing Happened".concat(period))),newSpellCode=null,1}function speldamage(e){if(player.TIMESTOP)updateLog("  It didn't seem to work".concat(period));else{var t=player.LEVEL;if(7==rnd(23)||rnd(18)>player.INTELLIGENCE)return nomove=0,void updateLog("  It didn't work!");if(3*t+2<e)return nomove=0,void updateLog("  Nothing happens.  You seem inexperienced at this".concat(period));switch(e){case nomove=0:return void player.updateProtectionTime(250);case 1:return void prepare_direction_event(spell_magic_missile);case 2:return void player.updateDexCount(400);case 3:return void prepare_direction_event(spell_sleep);case 4:return void player.updateCharmCount(player.CHARISMA<<1);case 5:return void prepare_direction_event(spell_sonic_spear);case 6:return void prepare_direction_event(spell_web);case 7:return void player.updateStrCount(150+rnd(100));case 8:var a=Math.max(0,player.y-5),r=Math.min(MAXY,player.y+6),o=Math.max(0,player.x-15),n=Math.min(MAXX,player.x+16);for(let t=o;t<n;t++)for(let e=a;e<r;e++)player.level.know[t][e]=KNOWALL;return;case 9:return void player.raisehp(20+(t<<1));case 10:return void(player.BLINDCOUNT&&(player.BLINDCOUNT=1));case 11:return void createmonster(makemonst(level+1)+8);case 12:return void prepare_direction_event(spell_phantasmal);case 13:var i=0,o=isCarrying(OAMULET);return o&&(i+=1+o.arg),void player.updateInvisibility(12+(i<<7));case 14:return void prepare_direction_event(spell_fireball);case 15:return void prepare_direction_event(spell_cold);case 16:return void prepare_direction_event(spell_polymorph);case 17:return void player.updateCancellation(5+t);case 18:return void player.updateHasteSelf(7+t);case 19:return void omnidirect(e,30+rnd(10),"gasps for air");case 20:var l=Math.min(player.x+1,MAXX-2),s=Math.min(player.y+1,MAXY-2);for(let a=Math.max(player.x-1,1);a<=l;a++)for(let t=Math.max(player.y-1,1);t<=s;t++){let e=itemAt(a,t);if(e.matches(OWALL))level<VBOTTOM-(ULARN?2:0)&&setItem(a,t,OEMPTY);else if(e.matches(OSTATUE)){let e=getDifficulty()<3;ULARN&&(e=getDifficulty()<=3&&rnd(60)<30),e&&setItem(a,t,createObject(OBOOK,level))}else e.matches(OTHRONE)?0==e.arg&&(create_guardian(GNOMEKING,a,t),e.arg=1):e.matches(OALTAR)?(create_guardian(DEMONPRINCE,a,t),ULARN&&(createmonster(DEMONPRINCE),createmonster(DEMONPRINCE),createmonster(DEMONPRINCE))):!ULARN&&e.matches(OFOUNTAIN)?create_guardian(WATERLORD,a,t):(monsterAt(a,t)&&monsterAt(a,t).matches(XORN)||ULARN&&monsterAt(a,t)&&monsterAt(a,t).matches(TROLL))&&(ifblind(a,t),hitm(a,t,200));player.level.know[a][t]=KNOWALL}return void updateWalls(player.x,player.y,2);case 21:return void prepare_direction_event(spell_dry);case 22:return void prepare_direction_event(spell_lightning);case 23:return void prepare_direction_event(spell_drain);case 24:return 0==player.GLOBE&&player.setMoreDefenses(player.MOREDEFENSES+10),player.GLOBE+=200,void loseint();case 25:return void omnidirect(e,32+t,"struggles for air in your flood!");case 26:return void(63!=rnd(151)?prepare_direction_event(spell_finger):(beep(),updateLog("  Your heart stopped!"),died(DIED_WAYWARD_FINGER,!1)));case 27:return player.updateScareMonst(rnd(10)+t),void(isCarrying(OHANDofFEAR)&&(player.SCAREMONST*=3));case 28:return void player.updateHoldMonst(rnd(10)+t);case 29:return void player.updateTimeStop(rnd(20)+(t<<1));case 30:return void prepare_direction_event(spell_teleport);case 31:return void omnidirect(e,35+rnd(10)+t,"cringes from the flame");case 32:return void prepare_direction_event(spell_makewall);case 33:return isCarrying(OSPHTALISMAN)||5!=rnd(23)?(loseint(),void prepare_direction_event(spell_sphere)):(updateLog("You have been enveloped by the zone of nothingness!"),void died(DIED_ANNIHILATED_SELF,!1));case 34:return updateLog("Genocide what monster? "),setCharCallback(genmonst),wizard||forgetSpell(GEN),void loseint();case 35:return void(30<rnd(100)?prepare_direction_event(spell_summon):15<rnd(100)?updateLog("  Nothing seems to have happened".concat(period)):(updateLog("  The demon turned on you and vanished!"),beep(),i=rnd(40)+30,lastnum=DIED_DEMON,player.losehp(i)));case 36:return void player.updateWTW(rnd(10)+5);case 37:{var c=[],d=[];let t,a;for(a=0;a<MAXY;a++)for(t=0;t<MAXX;t++){let e=itemAt(t,a);var p=monsterAt(t,a);e.matches(OEMPTY)||e.matches(OWALL)||e.matches(OANNIHILATION)||e.matches(OHOMEENTRANCE)||d.push(e),p&&c.push(p),setItem(t,a,0!=level?OWALL:OEMPTY),player.level.monsters[t][a]=null,player.level.know[t][a]=wizard?KNOWALL:0}for(0!=level&&eat(1,1),1==level&&setItem(33,MAXY-1,OHOMEENTRANCE),a=rnd(MAXY-2),t=1;t<MAXX-1;t++)setItem(t,a,OEMPTY);for(;0<d.length;){var u=d.pop();fillroom(u,u.arg)}for(;0<c.length;)fillmonst(c.pop().arg);return loseint(),wizard||forgetSpell(ALT),positionplayer(),lasthy=lasthx=0,void updateWalls()}case 38:return adjtime(-99999),wizard||forgetSpell(PER),void loseint();default:return nomove=0,appendLog("  spell ".concat(e," not available!")),void beep()}}}function spell_magic_missile(e){var t=rnd(player.LEVEL+1<<1)+player.LEVEL+3;setup_godirect(100,MLE,e,t,"+")}function spell_sleep(e){var t=rnd(3)+1;direct(SLE,e,fullhit(t),t)}function spell_sonic_spear(e){var t=rnd(10)+15+player.LEVEL;setup_godirect(70,SSP,e,t,"@")}function spell_web(e){var t=rnd(3)+2;direct(WEB,e,fullhit(t),t)}function spell_phantasmal(e){rnd(11)+7<=player.WISDOM?direct(PHA,e,rnd(20)+20+player.LEVEL,0):updateLog("  It didn't believe the illusions!")}function spell_fireball(e){var t=rnd(25+player.LEVEL)+25+player.LEVEL;setup_godirect(40,BAL,e,t,"*")}function spell_cold(e){var t=rnd(25)+20+player.LEVEL;setup_godirect(60,CLD,e,t,"O")}function spell_dry(e){direct(DRY,e,100+player.LEVEL,0)}function spell_lightning(e){var t=rnd(25)+20+(player.LEVEL<<1);setup_godirect(10,LIT,e,t,"~")}function spell_drain(e){var t=Math.min(player.HP-1,player.HPMAX/2);direct(DRL,e,t+t,0),player.losehp(Math.round(t))}function spell_finger(e){player.WISDOM>rnd(10)+10?direct(FGR,e,2e3,0):updateLog("  It didn't work".concat(period))}function spell_makewall(e){makewall(e)}function spell_sphere(e){newsphere(player.x+diroffx[e],player.y+diroffy[e],e,rnd(20)+11,level),newsphereflag=!0}function spell_summon(e){direct(SUM,e,150,0)}function spell_polymorph(e){var t,a;isconfuse()||(t=player.x+diroffx[e],a=player.y+diroffy[e],(e=getMonster(e))?(ifblind(t,a),0==nospell(PLY,e)?(player.level.monsters[t][a]=null,createmonster(rnd(monsterlist.length-1),t,a),show1cell(t,a)):(lasthx=t,lasthy=a)):updateLog("  There wasn't anything there!"))}function spell_teleport(e){var t,a;isconfuse()||(t=player.x+diroffx[e],a=player.y+diroffy[e],(e=getMonster(e))?(ifblind(t,a),lasthy=0==nospell(TEL,e)?(fillmonst(e.arg),player.level.monsters[t][a]=null,player.level.know[t][a]&=~KNOWHERE,lasthx=0):(lasthx=t,a)):updateLog("  There wasn't anything there!"))}function create_guardian(e,t,a){var r;t==player.x&&a==player.y&&(r=rnd(8),t+=diroffx[r],a+=diroffy[r]),player.level.know[t][a]=0,isGenocided(e)||createmonster(e,t,a)}function loseint(){player.setIntelligence(player.INTELLIGENCE-1)}function isconfuse(){return player.CONFUSE&&(updateLog("  You can't aim your magic!"),beep()),0<player.CONFUSE}function nospell(e,t){e=spelweird[t.arg-1][e];return 0==e?0:(cursors(),updateLog(spelmes[e](t)),1)}function fullhit(e){if(e<0||20<e)return 0;if(player.WIELD&&player.WIELD.matches(OLANCE))return 1e4;var t=e*((player.WCLASS>>1)+player.STRENGTH+player.STREXTRA-getDifficulty()-12+player.MOREDAM);return 1<=t?t:e}function direct(e,t,a,r){if(!isconfuse()){var o=player.x+diroffx[t],n=player.y+diroffy[t],i=getMonster(t),l=getItemDir(t);if(i||l.matches(OMIRROR)){t=attackmessage[e];if(!l.matches(OMIRROR)||i)ifblind(o,n),0==nospell(e,i)?(updateLog(t(i,r)),hitm(o,n,a)):(lasthx=o,lasthy=n);else if(e!=SLE){if(e!=WEB)return lastnum=DIED_OWN_MAGIC,updateLog(t("spell caster (that's you)")),beep(),void player.losehp(a);for(updateLog("  You get stuck in your own web!"),beep(),r+=2;0<r--;)parse2()}else for(updateLog("  You fall asleep! "),beep(),r+=2;0<r--;)parse2()}else updateLog("  There wasn't anything there!")}}function setup_godirect(e,t,a,r,o,n){napping=!0,nomove=1,setTimeout(godirect,e,t,player.x,player.y,diroffx[a],diroffy[a],r,e,o,n)}function godirect(e,t,a,r,o,n,i,l,s){if(isconfuse())exitspell();else{if(t==player.x&&a==player.y||(cursor(t+1,a+1),lprc(amiga_mode?" ":itemAt(t,a).getChar())),a+=o,(t+=r)>MAXX-1||a>MAXY-1||t<0||a<0)return n=0,void exitspell();if(t==player.x&&a==player.y)return cursors(),updateLog("  You are hit by your own magic!"),lastnum=DIED_OWN_MAGIC,player.losehp(n),void exitspell();0==player.BLINDCOUNT&&(cursor(t+1,a+1),lprc(l),show1cell(t,a));var c,d=monsterAt(t,a),p=itemAt(t,a),u=s||attackmessage[e];if(d)if(ifblind(t,a),ULARN&&(d.matches(LUCIFER)||d.isDemon()&&rnd(100)<10))r*=-1,o*=-1,cursors(),updateLog("  the ".concat(d," returns your puny missile!"));else{if(nospell(e,d))return lasthx=t,lasthy=a,void exitspell();cursors(),updateLog(u(d)),n-=hitm(t,a,n),show1cell(t,a),t-=r,a-=o}else p.matches(OWALL)?(cursors(),updateLog(u("wall")),n>=50+getDifficulty()&&level<VBOTTOM-(ULARN?2:0)&&t<MAXX-1&&a<MAXY-1&&0!=t&&0!=a&&(updateLog("  The wall crumbles".concat(period)),setItem(t,a,OEMPTY),updateWalls(t,a,1)),n=0):p.matches(OCLOSEDDOOR)?(cursors(),updateLog(u("door")),40<=n&&(updateLog("  The door is blasted apart".concat(period)),setItem(t,a,OEMPTY)),n=0):p.matches(OSTATUE)?(cursors(),updateLog(u("statue")),44<n&&(c=getDifficulty()<3,(c=ULARN?getDifficulty()<=3&&rnd(60)<30:c)&&(updateLog("  The statue crumbles".concat(period)),setItem(t,a,createObject(OBOOK,level)))),n=0):p.matches(OTHRONE)?(cursors(),updateLog(u("throne")),(ULARN?39:33)<n&&0==p.arg&&(create_guardian(GNOMEKING,t,a),p.arg=1,show1cell(t,a)),n=0):!ULARN&&p.matches(OALTAR)?(cursors(),updateLog(u("altar")),n>75-(getDifficulty()>>2)&&(create_guardian(DEMONPRINCE,t,a),show1cell(t,a)),n=0):!ULARN&&p.matches(OFOUNTAIN)?(cursors(),updateLog(u("fountain")),55<n&&(create_guardian(WATERLORD,t,a),show1cell(t,a)),n=0):p.matches(OMIRROR)&&(c=0,u=r,p=o,rnd(100)<50&&(r*=-(c=1)),rnd(100)<50&&(o*=-(c=1)),c&&(u!=r||p!=o)||(r=-u,o=-p));0<(n-=3+(getDifficulty()>>1))?(nomove=1,blt(),setTimeout(godirect,i,e,t,a,r,o,n,i,l,s)):(cursor(t+1,a+1),amiga_mode&&lprc(" "),exitspell())}}function exitspell(){napping=!1,nomove=0,gtime++,parse2(),paint()}function omnidirect(e,t,a){for(var r=player.x-1;r<=player.x+1;r++)for(var o=player.y-1;o<=player.y+1;o++){var n=monsterAt(r,o);n&&(0==nospell(e,n)?(ifblind(r,o),cursors(),updateLog("  The ".concat(n," ").concat(a)),hitm(r,o,t)):(lasthx=r,lasthy=o))}}function makewall(e){var t,a,r;isconfuse()||(r=itemAt(t=player.x+diroffx[e],a=player.y+diroffy[e]),e=monsterAt(t,a),r&&!r.matches(OHOMEENTRANCE)?0<=a&&a<=MAXY-1&&0<=t&&t<=MAXX-1&&(r.matches(OWALL)?updateLog("  there's a wall there already!"):r.matches(OEMPTY)?e?updateLog("  there's a monster there!"):(setItem(t,a,OWALL),updateWalls(player.x,player.y,2)):updateLog("  there's something there already!")):updateLog("  you can't make a wall there!"))}function annihilate(){for(var e=0,t=player.x-1;t<=player.x+1;t++)for(var a=player.y-1;a<=player.y+1;a++){var r=monsterAt(t,a);r&&(r.isDemon()?(updateLog("  The ".concat(r," barely escapes being annihilated!")),r.hitpoints=1+(r.hitpoints>>1)):ULARN||r.arg!=LAWLESS?(e+=r.experience,killMonster(t,a)):updateLog("Lawless resists!"))}return 0<e&&(updateLog("  You hear loud screams of agony!"),player.raiseexperience(e)),e}function isGenocided(e){return 0<=genocide.indexOf(e)}function setGenocide(e){genocide.push(e)}function genmonst(e){if(!isalpha(e))return 0;appendLog(e);for(var t,a=0;a<monsterlist.length;a++)if(monsterlist[a].char==e&&!isGenocided(a)){switch(!ULARN&&a==LAWLESS||setGenocide(a),a){case JACULI:t="jaculi";break;case YETI:t="yeti";break;case ELF:t="elves";break;case VORTEX:t="vortexes";break;case VIOLETFUNGI:t="violet fungi";break;case DISENCHANTRESS:t="disenchantresses";break;case LAWLESS:if(!ULARN)return updateLog("  Lawless resists!"),1;default:t=monsterlist[a]+"s"}return updateLog("  There will be no more ".concat(t).concat(period)),newcavelevel(level),paint(),1}return updateLog("  You sense failure!"),1}const LARN_splev=[1,4,9,14,18,22,26,29,33,36,38,38,38,38,38],ULARN_splev=[1,4,7,11,15,20,24,28,30,32,33,34,35,36,37,38,38,38,38,38,38],spelcode=["pro","mle","dex","sle","chm","ssp","web","str","enl","hel","cbl","cre","pha","inv","bal","cld","ply","can","has","ckl","vpr","dry","lit","drl","glo","flo","fgr","sca","hld","stp","tel","mfi","mkw","sph","gen","sum","wtw","alt","per"],spelname=["protection","magic missile","dexterity","sleep","charm monster","sonic spear","web","strength","enlightenment","healing","cure blindness","create monster","phantasmal forces","invisibility","fireball","cold","polymorph","cancellation","haste self","cloud kill","vaporize rock","dehydration","lightning","drain life","invulnerability","flood","finger of death","scare monster","hold monster","time stop","teleport away","magic fire","make a wall","sphere of annihilation","genocide","summon demon","walk through walls","alter reality","permanence"],speldescript=["Generates a +2 protection field","Creates and hurls a magic missile equivalent to a +1 magic arrow","Adds +2 to the caster's dexterity","Causes some monsters to go to sleep","Some monsters may be awed at your magnificence","Causes the caster's hands to emit a screeching sound","Causes strands of sticky thread to entangle an enemy","Adds +2 to the caster's strength for a short term","The caster becomes aware of things in the vicinity","Restores some of the caster's health","Restores sight to one so unfortunate as to be blinded","Creates a monster near the caster","Creates illusions which, if believed, cause monsters to die","The caster becomes invisible","Makes a ball of fire that burns what it hits","Sends forth a cone of cold which freezes whatever it touches","You can find out what this does for yourself","Negates the ability of a monster to use its special abilities","Speeds up the caster's movements","Creates a fog of poisonous gas which kills all that is within it","Changes rock to air","Dries up water in the immediate vicinity","Causes the caster's fingers to emit lightning bolts","Subtracts hit points from both the caster and monster","This globe helps to protect the player from physical attack","Creates a deluge of water, flooding the immediate chamber","A holy spell calling on your god to back you up","Terrifies the monster so that it may not hit the caster","Freezes monsters in their tracks","All movement in the caverns ceases for a limited duration","Moves a particular monster around in the dungeon (hopefully away from you)","Creates a curtain of fire around the caster","Makes a wall in the specified place","Anything caught in this sphere is instantly killed. Warning: dangerous","Eliminates a species of monster from the game -- use sparingly","Summons a demon who may help you out","Allows the player to walk through walls for a short period of time","God only knows what this will do","Makes a character's spell permanent, i.e. protection, strength, etc."],LARN_spelweird=[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,8,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,4,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,6,0,0,0,0,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,11,0,0,0,0,0,0,0,0,15,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,7,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,15,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,14,0,0,15,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,14,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,13,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,4,0,4,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,13,0,0,0,10,1,0,0,0,0,0,0,0,0,0,0,0,0,4,0,4,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,8,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,4,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,7,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,7,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,8,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,13,0,8,0,4,1,0,0,0,0,0,0,0,0,4,0,0,0,4,0,4,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,8,0,0,1,0,0,0,0,0,4,0,0,0,0,0,0,4,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,7,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,7,0,0,3,0,0,0,0,0,0,0,0,5,0,0,9,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,13,0,8,3,4,1,0,0,0,0,0,0,0,0,0,9,0,0,4,0,0,0,0,0,16,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,7,0,0,0,0,11,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,13,0,8,3,4,1,0,0,0,0,0,0,5,0,4,9,0,0,4,0,4,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,6,0,9,0,0,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,7,0,9,0,0,11,0,0,0,0,0,14,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,6,0,0,0,0,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,7,0,4,3,0,1,0,0,0,0,0,14,5,0,0,4,0,0,4,0,4,0,0,0,4,4,0,0,0,9,4,0,9,0,0,0,0,0],[0,7,0,4,3,0,1,0,0,0,0,0,14,5,0,0,4,0,0,4,0,4,0,0,0,4,4,0,0,0,9,4,0,9,0,0,0,0,0],[0,7,0,4,3,0,1,0,0,0,0,0,14,5,0,0,4,0,0,4,0,4,0,0,0,4,4,0,0,0,9,4,0,9,0,0,0,0,0],[0,7,0,4,3,0,1,0,0,0,0,0,14,5,0,0,4,0,0,4,0,4,0,0,0,4,4,0,0,0,9,4,0,9,0,0,0,0,0],[0,7,0,4,3,0,1,0,0,0,0,0,14,5,0,0,4,0,0,4,0,4,0,0,0,4,4,0,0,0,9,4,0,9,0,0,0,0,0],[0,7,0,4,3,0,1,0,0,0,0,0,14,5,0,0,4,0,0,4,0,4,0,0,0,4,4,0,0,0,9,4,0,9,0,0,0,0,0],[0,7,0,4,3,0,1,0,0,0,0,0,14,5,0,0,4,0,0,4,0,4,0,0,0,4,4,0,0,0,9,4,0,9,0,0,0,0,0],[0,7,0,4,3,9,1,0,0,0,0,0,14,5,0,0,4,0,0,4,0,4,0,0,0,4,4,3,0,0,9,4,0,9,0,17,0,0,0]],ULARN_spelweird=[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,8,0,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,8,0,4,0,0,0,0,0,0,4,0,0,0,0,0,0,4,0,4,0,4,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,6,0,0,0,0,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,11,0,0,0,0,0,0,0,0,15,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,15,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,14,0,0,15,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,14,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,13,0,8,0,10,2,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,13,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,4,0,4,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,13,0,0,0,10,1,0,0,0,0,0,0,0,0,0,0,0,0,4,0,4,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,13,0,8,0,4,0,0,0,0,0,0,14,0,0,0,0,0,0,4,0,4,0,4,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,7,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,7,0,8,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,4,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,4,2,0,0,0,0,0,14,0,0,0,0,0,0,4,0,0,0,4,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,13,0,8,0,4,1,0,0,0,0,0,0,0,0,4,0,0,0,4,0,4,0,4,0,4,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,8,0,10,1,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,7,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,7,0,0,3,0,0,0,0,0,0,0,0,5,0,0,9,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,13,0,8,3,4,1,0,0,0,0,0,0,0,0,0,9,0,0,4,0,0,0,0,0,16,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,7,0,0,0,0,11,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,13,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,13,0,8,3,4,1,0,0,0,0,0,14,5,0,4,9,0,0,4,0,4,0,4,0,4,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,6,0,9,0,0,12,0,0,0,0,0,0,0,0,0,9,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,7,0,9,0,0,11,0,0,0,0,0,14,0,0,0,9,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,6,0,0,0,0,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,13,0,8,3,10,1,0,0,0,0,0,14,5,0,0,9,0,0,4,0,4,0,9,0,4,4,3,0,0,9,4,0,9,0,0,0,0,0],[0,13,0,8,3,10,1,0,0,0,0,0,14,5,0,0,9,0,0,4,0,4,0,9,0,4,4,3,0,0,9,4,0,9,0,0,0,0,0],[0,13,0,8,3,10,1,0,0,0,0,0,14,5,0,0,9,0,0,4,0,4,0,9,0,4,4,3,0,0,9,4,0,9,0,0,0,0,0],[0,13,0,8,3,10,1,0,0,0,0,0,14,5,0,0,9,0,0,4,0,4,0,9,0,4,4,3,0,0,9,4,0,9,0,0,0,0,0],[0,13,0,8,3,10,1,0,0,0,0,0,14,5,0,0,9,0,0,4,0,4,0,9,0,4,4,3,0,0,9,4,0,9,0,0,0,0,0],[0,13,0,8,3,10,1,0,0,0,0,0,14,5,0,0,4,0,0,4,0,4,0,0,0,4,4,3,0,0,9,4,0,9,0,0,0,0,0],[0,13,0,8,3,10,1,0,0,0,0,0,14,5,0,0,4,0,0,4,0,4,0,0,0,4,4,3,0,0,9,4,0,9,0,0,0,0,0],[0,13,0,8,3,10,1,0,0,0,0,0,14,5,0,0,4,0,0,4,0,4,0,4,0,4,4,3,0,0,9,4,0,9,0,0,0,0,0],[0,13,0,8,3,10,1,0,0,0,0,0,14,5,18,0,9,0,0,4,0,4,18,4,0,4,4,3,0,0,9,4,0,9,0,17,0,0,0]];var spelmes=["",function(e){return"the web had no effect on the ".concat(e).concat(period)},function(e){return"the ".concat(e," changed shape to avoid the web").concat(period)},function(e){return"the ".concat(e," isn't afraid of you").concat(period)},function(e){return"the ".concat(e," isn't affected").concat(period)},function(e){return"the ".concat(e," can see you with its infravision").concat(period)},function(e){return"the ".concat(e," vaporizes your missile").concat(period)},function(e){return"your missile bounces off the ".concat(e).concat(period)},function(e){return"the ".concat(e," doesn't sleep").concat(period)},function(e){return"the ".concat(e," resists").concat(period)},function(e){return"the ".concat(e," can't hear the noise").concat(period)},function(e){return"the ".concat(e,"'s tail cuts it free of the web").concat(period)},function(e){return"the ".concat(e," burns through the web").concat(period)},function(e){return"your missiles pass right through the ".concat(e).concat(period)},function(e){return"the ".concat(e," sees through your illusions").concat(period)},function(e){return"the ".concat(e," loves the cold!")},function(e){return"the ".concat(e," loves the water!")},function(e){return"the demon is terrified of the ".concat(e,"!")},function(e){return"the ".concat(e," loves fire and lightning!")}];const MLE=1,SLE=3,SSP=5,WEB=6,PHA=12,BAL=14,CLD=15,PLY=16,DRY=21,LIT=22,DRL=23,FGR=26,TEL=30,MKW=32,GEN=34,SUM=35,ALT=37,PER=38,attackmessage=[];function regen(){player&&(player.MOVESMADE++,0<player.TIMESTOP?player.updateTimeStop(-1)<=0&&recalc():(player.HP!=player.HPMAX&&player.REGENCOUNTER--<=0&&(player.REGENCOUNTER=22+(getDifficulty()<<1)-player.LEVEL,player.raisehp(player.REGEN)),player.SPELLS<player.SPELLMAX&&player.ECOUNTER--<=0&&(player.ECOUNTER=100+4*(getDifficulty()-player.LEVEL-player.ENERGY),player.setSpells(player.SPELLS+1)),player.HERO&&--player.HERO<=0&&(player.setStrength(player.STRENGTH-10),player.setIntelligence(player.INTELLIGENCE-10),player.setWisdom(player.WISDOM-10),player.setConstitution(player.CONSTITUTION-10),player.setDexterity(player.DEXTERITY-10),player.setCharisma(player.CHARISMA-10)),player.COKED&&--player.COKED<=0&&(player.setStrength(player.STRENGTH-34),player.setIntelligence(player.INTELLIGENCE-34),player.setWisdom(player.WISDOM-34),player.setConstitution(player.CONSTITUTION-34),player.setDexterity(player.DEXTERITY-34),player.setCharisma(player.CHARISMA-34)),player.STEALTH&&player.updateStealth(-1),player.UNDEADPRO&&player.updateUndeadPro(-1),player.SPIRITPRO&&player.updateSpiritPro(-1),player.CHARMCOUNT&&player.updateCharmCount(-1),player.HOLDMONST&&player.updateHoldMonst(-1),player.FIRERESISTANCE&&player.updateFireResistance(-1),player.SCAREMONST&&player.updateScareMonst(-1),player.HASTESELF&&player.updateHasteSelf(-1),player.CANCELLATION&&player.updateCancellation(-1),player.INVISIBILITY&&player.updateInvisibility(-1),player.WTW&&player.updateWTW(-1),player.GIANTSTR&&player.updateGiantStr(-1),player.DEXCOUNT&&player.updateDexCount(-1),player.STRCOUNT&&player.updateStrCount(-1),player.ALTPRO&&player.updateAltPro(-1),player.PROTECTIONTIME&&player.updateProtectionTime(-1),player.GLOBE&&--player.GLOBE<=0&&player.setMoreDefenses(player.MOREDEFENSES-10),player.BLINDCOUNT&&--player.BLINDCOUNT<=0&&updateLog("The blindness lifts".concat(period)),player.CONFUSE&&--player.CONFUSE<=0&&updateLog("You regain your senses".concat(period)),player.HALFDAM&&--player.HALFDAM<=0&&updateLog("You now feel better".concat(period)),player.AGGRAVATE&&--player.AGGRAVATE,player.AWARENESS&&(isCarrying(OORB)||--player.AWARENESS),player.HASTEMONST&&--player.HASTEMONST,player.SEEINVISIBLE&&(ULARN&&isCarrying(OAMULET)&&player.SEEINVISIBLE++,--player.SEEINVISIBLE<=0&&(player.BLINDCOUNT||updateLog("You feel your vision return to normal".concat(period)))),player.ITCHING&&(1<player.ITCHING&&(player.WEAR||player.SHIELD)&&rnd(100)<50&&(player.WEAR=null,player.SHIELD=null,updateLog("The hysteria of itching forces you to remove your armor!")),--player.ITCHING<=0&&updateLog("You now feel the irritation subside!")),player.CLUMSINESS&&(player.WIELD&&1<player.CLUMSINESS&&itemAt(player.x,player.y).matches(OEMPTY)&&rnd(100)<33&&drop_object(getCharFromIndex(player.inventory.indexOf(player.WIELD))),--player.CLUMSINESS<=0&&updateLog("You now feel less awkward!"))))}attackmessage[MLE]=function(e,t){return"  Your missile".concat(2<=player.LEVEL?"s":""," hit the ").concat(e).concat(period)},attackmessage[SLE]=function(e,t){return"  While the ".concat(e," slept, you smashed it ").concat(t," times").concat(period)},attackmessage[SSP]=function(e,t){return"  The sound damages the ".concat(e).concat(period)},attackmessage[WEB]=function(e,t){return"  While the ".concat(e," is entangled, you hit ").concat(t," times").concat(period)},attackmessage[PHA]=function(e,t){return"  The ".concat(e," believed!")},attackmessage[BAL]=function(e,t){return"  The fireball hits the ".concat(e).concat(period)},attackmessage[CLD]=function(e,t){return"  Your cone of cold strikes the ".concat(e).concat(period)},attackmessage[DRY]=function(e,t){return"  The ".concat(e," shrivels up").concat(period)},attackmessage[LIT]=function(e,t){return"  A lightning bolt hits the ".concat(e).concat(period)},attackmessage[DRL]=function(e,t){return""},attackmessage[FGR]=function(e,t){return"  The ".concat(e,"'s heart stopped").concat(period)},attackmessage[SUM]=function(e,t){return"  The demon strikes at the ".concat(e).concat(period)};var Sphere=function(e,t,a,r,o){this.x=e,this.y=t,this.level=o,this.direction=a,this.lifetime=r};function newsphere(e,t,a,r,o){9<=a&&(a=0),0==o?(e=vx(e),t=vy(t)):((e=e<1?1:e)>=MAXX-1&&(e=MAXX-2),(t=t<1?1:t)>=MAXY-1&&(t=MAXY-2));var n=monsterAt(e,t);if(!isCarrying(OSPHTALISMAN)){if(n&&n.isDemon())return show1cell(e,t),cursors(),updateLog("The ".concat(n," dispels the sphere!")),void rmsphere(e,t);if(n&&n.matches(DISENCHANTRESS))return cursors(),updateLog("The ".concat(n," causes cancellation of the sphere!")),sphboom(e,t),void rmsphere(e,t);if(player.CANCELLATION)return cursors(),updateLog("As the cancellation spell takes effect, you hear a great earth shaking blast!"),sphboom(e,t),void rmsphere(e,t);if(player.x==e&&player.y==t)return cursors(),updateLog("You have been enveloped by the zone of nothingness!"),rmsphere(e,t),void died(DIED_ANNIHILATED_SELF,!1)}if(itemAt(e,t).matches(OANNIHILATION))return cursors(),updateLog("Two spheres of annihilation collide! You hear a great earth shaking blast!"),sphboom(e,t),void rmsphere(e,t);setItem(e,t,OANNIHILATION),updateWalls(e,t,1),n&&n.isCarrying(OSPHTALISMAN)?updateLog("The ".concat(n," is unaffected by the sphere of annihilation!")):killMonster(e,t),player.level.know[e][t]=1,show1cell(e,t);o=new Sphere(e,t,a,r,o);spheres.push(o)}function rmsphere(e,t){for(var a=0;a<spheres.length;a++){var r=spheres[a];r&&r.level==level&&e==r.x&&t==r.y&&(setItem(e,t,OEMPTY),player.level.know[e][t]=1,show1cell(e,t),spheres.splice(a,1))}return spheres.length}function sphboom(e,t){player.HOLDMONST&&player.updateHoldMonst(-player.HOLDMONST),player.CANCELLATION&&player.updateCancellation(-player.CANCELLATION);for(var a=Math.max(1,e-2);a<Math.min(e+3,MAXX-1);a++)for(var r=Math.max(1,t-2);r<Math.min(t+3,MAXY-1);r++){setItem(a,r,OEMPTY);let e=monsterAt(a,r);e&&e.isCarrying(OSPHTALISMAN)?updateLog("The ".concat(e," is unaffected by the blast!")):killMonster(a,r),show1cell(a,r),isCarrying(OSPHTALISMAN)||player.x==a&&player.y==r&&(cursors(),updateLog("You were too close to the sphere!"),died(DIED_ANNIHILATED,!1))}updateWalls(e,t,3)}function movsphere(){for(var e=spheres.length;0<=e;--e){var t=spheres[e];if(t&&(t.level==level&&itemAt(t.x,t.y).matches(OANNIHILATION)))if(--t.lifetime<0)rmsphere(t.x,t.y);else switch(rnd(Math.max(7,player.INTELLIGENCE>>1))){case 1:case 2:t.direction=rnd(8);default:rmsphere(t.x,t.y),newsphere(t.x+diroffx[t.direction],t.y+diroffy[t.direction],t.direction,t.lifetime,t.level)}}}const helppages=[];var LEVELS,LOG,player,playerID,currentpage=0;function parse_help(e){if(nomove=1,e==ESC)return exitbuilding();" "==e&&print_help()}function print_help(){mazeMode=!1,clear(),++currentpage>helppages.length-1&&(currentpage=1),lprcat(helppages[currentpage]),cursors(),lprcat("              ---- Press <b>space</b> for more help, <b>escape</b> to exit ----"),blt()}function initHelpPages(){helppages[0]="Welcome to the game of ".concat(GAMENAME,". At this moment, you face a great problem.\nYour daughter has contracted a strange disease, and none of your home remedies\nseem to have any effect. You sense that she is in mortal danger, and you must\ntry to save her. Time ago you heard of a land of great danger and opportunity.\nPerhaps here is the solution you need.\n\n    It has been said that there once was a great magician who called himself\nPolinneaus. Many years ago, after having many miraculous successes, Polinneaus\nretired to the caverns of ").concat(GAMENAME,", where he devoted most of his time to the\ncreation of magic. Rumors have it that one day Polinneaus set out to dispel\nan attacking army in a forest some distance to the north. It is believed that\nhere he met his demise.\n\n    The caverns of ").concat(GAMENAME,", it is thought, must be magnificent in design,\nand contain much magic and treasure. One option you have is to undertake a\njourney into these caverns.\n\n\n    Good Luck!  You're going to need it!\n"),helppages[1]="                       <b>Help File for The Caverns of ".concat(GAMENAME,"</b>                 \n                                                                         shift+\n y|Y  move|run northwest  k|K  move|run up    u|U  move|run northeast     ↖↑↗\n h|H  move|run left        .   stay here      l|L  move|run right        ←    →\n b|B  move|run southwest  j|J  move|run down  n|N  move|run southeast     ↙↓↘\n                                                                         to run\n                              A  desecrate an altar       <  go up stairs       \n  c  cast a spell             C  close a door             >  go down stairs     \n  d  drop an item             D  drink at a fountain                            \n  e  eat something            E  enter a store, dungeon   ^  identify a trap    \n  f  tidy up at a fountain       or volcanic shaft                              \n  g  get present pack weight                              !  toggle key hints   \n  i  inventory your pockets   I  list all known items     @  toggle auto-pickup \n  o  open a door or chest                                 #  toggle inventory   \n  p  pray at an altar         P  give tax status                                \n  q  quaff a potion           Q  quit the game            {  toggle retro fonts \n  r  read a scroll or book    R  remove gems from throne  }  toggle between     \n  s  sit on a throne          S  save the game               classic, hack,     \n  t  take an item             T  take off armor              and amiga graphics \n  v  print program version                                                      \n  w  wield a weapon           W  wear armor                                     \n  z  show scores              Z  teleport yourself        ?  this help screen   \n  "),helppages[2]="                                 <b>Special Notes</b> \n\nTo drop gold, press '<b>.</b>' after pressing '<b>d</b>'. When dropping gold, if you\ntype '<b>*</b>' as your amount, all your gold is dropped.\n\nIn general, typing in '<b>*</b>' means all of what you're interested in. This is true\nwhen visiting the bank, or when contributing at altars.\n\nWhen in the store, trading post, school, or home, an <b>escape</b> will get you out.\n\nWhen casting a spell, if you need a list of spells you can cast, type <b>space</b> \nat any time and the available list of spells will be shown.\n\nWhen an inventory list is on the screen from a drop, quaff, read, or similar\ncommand, you can type the letter of the object that you wish to act apon,\nwithout having to type a space to get back to the prompt.\n\nIf NumLock is off, the Keypad functions in the obvious way for movement. Hold\nShift when pressing any direction on the Keypad to run in that direction. The\n5 key on the Keypad is the same as 'stay here', which really means skip your\nturn.\n",helppages[3]="                      <b>Background Information for ".concat(GAMENAME,"</b> \n\n    Welcome to the game of ").concat(GAMENAME,". At this moment, you face a great problem.\nYour daughter has contracted a strange disease, and none of your home remedies\nseem to have any effect. You sense that she is in mortal danger, and you must\ntry to save her. Time ago you heard of a land of great danger and opportunity.\nPerhaps here is the solution you need.\n\n    It has been said that there once was a great magician who called himself\nPolinneaus. Many years ago, after having many miraculous successes, Polinneaus\nretired to the caverns of ").concat(GAMENAME,", where he devoted most of his time to the\ncreation of magic. Rumors have it that one day Polinneaus set out to dispel\nan attacking army in a forest some distance to the north. It is believed that\nhere he met his demise.\n\n    The caverns of ").concat(GAMENAME,", it is thought, must be magnificent in design,\nand contain much magic and treasure. One option you have is to undertake a\njourney into these caverns.\n\n    Good Luck!  You're going to need it!\n"),helppages[4]="                  <b>Explanation of the ".concat(GAMENAME," scoreboard facility </b> \n\n").concat(GAMENAME," supports TWO scoreboards, one for winners, and one for deceased\ncharacters. Each player (by the name entered when you start the game)\nis allowed one slot on each scoreboard. This design helps ensure that \nfrequent players of ").concat(GAMENAME," do not hog the scoreboard, and gives more\nplayers a chance for glory. Level of difficulty is also noted on the\nscoreboards, and this takes precedence over score for determining what\nentry is on the scoreboard. For example: if 'Yar, the Bug Slayer' has\na score of 128003 on the scoreboard at diff 0, then a game at diff 1\nand a score of 4112 would replace the previous entry on the scoreboard.\nNote that when a player dies, the inventory is stored in the scoreboard\nso that everyone can see what items the player had at the time of death.\n")}var playerIP="0",PARAMS={},recording={},newsphereflag=!1,GAMEOVER=!0,game_started=!1,mazeMode=!1,napping=!1,original_objects=!0,keyboard_hints=!1,auto_pickup=!1,side_inventory=!0,show_color=!0,bold_objects=!0,retro_mode=!1,dnd_item=null,genocide=[],amiga_mode=!1,gameID=Math.random().toString(36).substr(2,10),debug_used=0,logname="Adventurer",cheat=0,level=-1,wizard=0,gtime=0,HARDGAME=0;function getDifficulty(){return null!=HARDGAME&&""!==HARDGAME&&!isNaN(Number(HARDGAME))||(console.log("get: invalid difficulty: "+HARDGAME),console.trace()),HARDGAME}function setDifficulty(e){null!=e&&""!==e&&!isNaN(Number(e))||(console.log("set: invalid difficulty: "+e),console.trace()),HARDGAME=e}var w1x,w1y,winnerHardlev,lastmonst="",lastnum=0,hitflag=0,lastpx=0,lastpy=0,lasthx=0,lasthy=0,prayed=1,course=[],outstanding_taxes=0,dropflag=0,rmst=120,nomove=0,viewflag=0,lasttime=0,spheres=[];function GameState(e){this.LEVELS=LEVELS,this.LOG=LOG,this.player=player,isRecording()&&(this.recording=getRecordingInfo(),e?this.recording.frames+=3:(--this.recording.frames,--this.recording.rolls)),this.newsphereflag=newsphereflag,this.GAMEOVER=GAMEOVER,this.mazeMode=mazeMode,this.napping=napping,this.original_objects=original_objects,this.keyboard_hints=keyboard_hints,this.auto_pickup=auto_pickup,this.side_inventory=side_inventory,this.show_color=show_color,this.bold_objects=bold_objects,this.dnd_item=dnd_item,this.genocide=genocide,this.amiga_mode=amiga_mode,this.gameID=gameID,this.debug_used=debug_used,this.logname=logname,this.cheat=cheat,this.level=level,this.wizard=wizard,this.gtime=gtime,this.HARDGAME=getDifficulty(),this.lastmonst=lastmonst,this.lastnum=lastnum,this.hitflag=hitflag,this.lastpx=lastpx,this.lastpy=lastpy,this.lasthx=lasthx,this.lasthy=lasthy,this.prayed=prayed,this.course=course,this.outstanding_taxes=outstanding_taxes,this.dropflag=dropflag,this.rmst=rmst,this.nomove=nomove,this.viewflag=viewflag,this.lasttime=lasttime,this.w1x=w1x,this.w1y=w1y,this.spheres=spheres}var winnerLetterGender="Male";function readmail(){var e=0;winnerHardlev=0;try{var t=localStorageGetObject(logname);t&&(winnerLetterGender=t.gender,e=t.score,winnerHardlev=t.hardlev+1)}catch(e){console.error("readmail: caught ".concat(e))}letter1(e)}function letter1(e){return clear(),lprcat("<b>From:</b> The LRS (".concat(GAMENAME," Revenue Service)")),ULARN&&lprcat(" &ltlrs@ularn.com&gt"),lprcat("\n"),lprcat("\n<b>Subject:</b> Undeclared income\n"),lprcat("\n   We heard you survived the caverns of ".concat(GAMENAME,". Let me be the")),lprcat("\nfirst to congratulate you on your success. It is quite a feat."),lprcat("\nIt must also have been very profitable for you."),lprcat("\n\n   The Dungeon Master has informed us that you brought"),lprcat("\n".concat(Number(e).toLocaleString()," gold pieces back with you from your journey. As the")),lprcat("\ncounty of ".concat(GAMENAME," is in dire need of funds, we have spared no time")),lprcat("\nin preparing your tax bill. You owe <strike>".concat(Math.round(e*TAXRATE).toLocaleString(),"</strike> 0 gold pieces as")),lprcat("\nof this notice, and is due within 5 days. Failure to pay will"),lprcat("\nmean penalties. Once again, congratulations, We look forward"),lprcat("\nto your future successful expeditions.\n"),cursors(),lprcat("                --- press <b>space</b> to continue ---\n"),setCharCallback(letter2),1}function letter2(e){let t="Female"===winnerLetterGender?"Lady":"Male"===winnerLetterGender?"Knight":"Champion";return" "!=e?0:(clear(),lprcat("<b>From:</b> His Majesty King Wilfred of Larndom"),ULARN&&lprcat(" &ltwilfred@ularn.com&gt"),lprcat("\n"),lprcat("\n<b>Subject:</b> A noble deed\n"),lprcat("\n   I have heard of your magnificent feat, and I, King Wilfred,"),lprcat("\nforthwith declare today to be a national holiday. Furthermore,"),lprcat("\nhence three days, Ye be invited to the castle to receive the"),lprcat("\nhonour of ".concat(t," of the realm. Upon thy name shall it be written. . .")),lprcat("\nBravery and courage be yours."),lprcat("\nMay you live in happiness forevermore . . .\n"),cursors(),lprcat("                --- press <b>space</b> to continue ---\n"),setCharCallback(letter3),1)}function letter3(e){let t="Female"===winnerLetterGender?"Bitch":"Male"===winnerLetterGender?"Bastard":"Jerk";return" "!=e?0:(clear(),lprcat("<b>From:</b> Count Endelford"),ULARN&&lprcat(" &ltendelford@ularn.com&gt"),lprcat("\n"),lprcat("\n<b>Subject:</b> You ".concat(t,"!\n")),lprcat("\n   I heard (from sources) of your journey. Congratulations!"),lprcat("\nYou ".concat(t,"! With several attempts I have yet to endure the")),lprcat(" caves,\nand you, a nobody, makes the journey! From this time"),lprcat(" onward, bewarned\nupon our meeting you shall pay the price!\n"),cursors(),lprcat("                --- press <b>space</b> to continue ---\n"),setCharCallback(letter4),1)}function letter4(e){return" "!=e?0:(clear(),lprcat("<b>From:</b> Mainair, Duke of Larnty"),ULARN&&lprcat(" &ltmainair@ularn.com&gt"),lprcat("\n"),lprcat("\n<b>Subject:</b> High Praise\n"),lprcat("\n   With a certainty a hero I declare to be amongst us! A nod of"),lprcat("\nfavour I send to thee. Me thinks Count Endelford this day of"),lprcat("\nright breath'eth fire as of dragon of whom ye are slayer. I"),lprcat("\nyearn to behold his anger and jealously. Should ye choose to"),lprcat("\nunleash some of thy wealth upon those who be unfortunate, I,"),lprcat("\nDuke Mainair, Shall equal thy gift also.\n"),cursors(),lprcat("                --- press <b>space</b> to continue ---\n"),setCharCallback(letter5),1)}function letter5(e){let t="Female"===winnerLetterGender?"woman's":"Male"===winnerLetterGender?"man's":"person's";return" "!=e?0:(clear(),lprcat("<b>From:</b> St. Mary's Children's Home"),ULARN&&lprcat(" &ltstmarys@ularn.com&gt"),lprcat("\n"),lprcat("\n<b>Subject:</b> These poor children\n"),lprcat("\n   News of your great conquests has spread to all of Larndom."),lprcat("\nMight I have a moment of a great ".concat(t," time. We here at St.")),lprcat("\nMary's Children's Home are very poor, and many children are"),lprcat("\nstarving. Disease is widespread and very often fatal without"),lprcat("\ngood food. Could you possibly find it in your heart to help us"),lprcat("\nin our plight? Whatever you could give will help much."),lprcat("\n(your gift is tax deductible)\n"),cursors(),lprcat("                --- press <b>space</b> to continue ---\n"),setCharCallback(letter6),1)}function letter6(e){let t=ULARN?"Dianthroritis":"Cancer";return" "!=e?0:(clear(),lprcat("<b>From:</b> The National ".concat(t," Society of ").concat(GAMENAME)),ULARN&&lprcat(" &ltnds@ularn.com&gt"),lprcat("\n"),lprcat("\n<b>Subject:</b> Hope\n"),lprcat("\n   Congratulations on your successful expedition. We are sure much"),lprcat("\ncourage and determination were needed on your quest. There are"),lprcat("\nmany though, that could never hope to undertake such a journey"),lprcat("\ndue to an enfeebling disease -- ".concat(t,". We at the National")),lprcat("\n".concat(t," Society of ").concat(GAMENAME," wish to appeal to your philanthropy in")),lprcat("\norder to save many good people -- possibly even yourself a few"),lprcat("\nyears from now. Much work needs to be done in researching this"),lprcat("\ndreaded disease, and you can help today. Could you please see it"),lprcat("\nin your heart to give generously? Your continued good health"),lprcat("\ncan be your everlasting reward.\n"),cursors(),lprcat("                --- press <b>space</b> to continue ---\n"),setCharCallback(setdiff),1)}function desecrate_altar(){cursors(),itemAt(player.x,player.y).matches(OALTAR)?act_desecrate_altar():updateLog("I see no altar to desecrate here!")}function pray_at_altar(){cursors(),itemAt(player.x,player.y).matches(OALTAR)?(updateLog("  How much do you donate? "),setNumberCallback(act_donation_pray,!0),nomove=1):updateLog("I see no altar to pray at here!")}function act_donation_pray(e){if(e==ESC)return appendLog(" cancelled".concat(period)),prayed=0,nomove=1;if("*"==e&&(e=player.GOLD),(e=Number(e))>player.GOLD)return updateLog("  You don't have that much!"),prayed=0,dropflag=1;if(0==e)return act_just_pray(),prayed=dropflag=1;if(player.GOLD>=e){dropflag=prayed=1;var t=player.GOLD/10;if(player.setGold(player.GOLD-e),ULARN){if(e<player.GOLD/10&&rnd(60)<30)return updateLog("Cheapskate! The Gods are insulted by such a tiny offering!"),forget(),createmonster(DEMONPRINCE),player.AGGRAVATE+=1500,1;if(e<t||e<rnd(50))return createmonster(makemonst(level+2)),player.AGGRAVATE+=500,1;var a=rund(16);return a<4?updateLog("Thank you".concat(period)):(a<6?(enchantarmor(ENCH_ALTAR),enchantarmor(ENCH_ALTAR)):a<8?(enchweapon(ENCH_ALTAR),enchweapon(ENCH_ALTAR)):act_prayer_heard(),13==rnd(43)&&crumble_altar()),1}return e<t||e<rnd(50)?(createmonster(makemonst(level+1)),player.AGGRAVATE+=200):50<rnd(101)?act_prayer_heard():5==rnd(43)?enchantarmor(ENCH_ALTAR):8==rnd(43)?enchweapon(ENCH_ALTAR):13==rnd(43)?crumble_altar():updateLog("  Thank You".concat(period)),1}}function act_just_pray(){if(10==rnd(43))return crumble_altar(),"crumble";if(ULARN){var e=rund(100);e<12?createmonster(makemonst(level+2)):e<17?enchweapon(ENCH_ALTAR):e<22?enchantarmor(ENCH_ALTAR):e<27?act_prayer_heard():updateLog("  Nothing happens".concat(period))}else if(rnd(100)<75)updateLog("  Nothing happens".concat(period));else{if(10==rnd(43))return enchantarmor(ENCH_ALTAR),"ac";if(10==rnd(43))return player.WIELD&&updateLog("  You feel your weapon vibrate for a moment".concat(period)),enchweapon(),"wc";createmonster(makemonst(level+1))}}function act_desecrate_altar(){rnd(100)<60?(createmonster(makemonst(level+(ULARN?3:2))+8),player.AGGRAVATE+=2500):ULARN&&rnd(100)<5?player.raiselevel():rnd(101)<30?crumble_altar():updateLog("  Nothing happens".concat(period))}function crumble_altar(){updateLog("  The altar crumbles into a pile of dust before your eyes".concat(period)),forget()}function act_ignore_altar(e,t){rnd(100)<30?(createmonster(makemonst(level+(ULARN?2:1)),e,t),player.AGGRAVATE+=rnd(450)):updateLog("  Nothing happens".concat(period))}function act_prayer_heard(){var e;updateLog("  You have been heard!"),e=ULARN?800:500,player.updateAltPro(e)}function act_drink_fountain(){if(rnd(1501)<(ULARN?4:2)){var e=ULARN?"OH MY GOD!! You":"Oops! You seem to";return updateLog("  ".concat(e," have caught the dreadful sleep!")),beep(),void died(DIED_DREADFUL_SLEEP,!1)}var t=rnd(100);ULARN?1==t?player.raiselevel():t<11?(e=rnd(2+(level<<2)),updateLog("  Bleah! The water tasted like stale gatorade! You lose ".concat(e," hit point")),exclaim(e),lastnum=DIED_BAD_WATER,player.losehp(e)):t<14?(player.HALFDAM+=200+rnd(200),updateLog("  The water makes you vomit".concat(period))):t<17?quaffpotion(createObject(OPOTION,17),!1):t<45?updateLog("  Nothing seems to have happened".concat(period)):2!=rnd(3)?fntchange(1):fntchange(-1):t<7?(player.HALFDAM+=200+rnd(200),updateLog("  You feel a sickness coming on".concat(period))):t<13?quaffpotion(createObject(OPOTION,23),!1):t<45?updateLog("  Nothing seems to have happened".concat(period)):2!=rnd(3)?fntchange(1):fntchange(-1),rnd(12)<3&&(updateLog("  The fountains bubbling slowly quiets".concat(period)),setItem(player.x,player.y,ODEADFOUNTAIN),player.level.know[player.x][player.y]=0)}function act_wash_fountain(){var e,t;rnd(100)<11?(e=rnd(2+(level<<2)),t="  Oh no! The water was foul! You suffer ".concat(e," hit point"),updateLog(t=ULARN?"  The water burns like acid! You lose ".concat(e," hit point"):t),exclaim(e),lastnum=DIED_BAD_WATER,player.losehp(e)):rnd(100)<29?(updateLog(ULARN?"  You are now clean".concat(period):"  You got the dirt off!"),player.ITCHING?player.ITCHING=1:(rnd(100)<50?enchantarmor:enchweapon)(ENCH_FOUNTAIN)):rnd(100)<31?updateLog(ULARN?"  This water seems to be hard water! The dirt didn't come off!":"  This water needs soap -- the dirt didn't come off".concat(period)):rnd(100)<34&&!isGenocided(WATERLORD)?createmonster(WATERLORD):updateLog("  Nothing seems to have happened".concat(period)),rnd(12)<3&&(updateLog("  The fountains bubbling slowly quiets".concat(period)),setItem(player.x,player.y,ODEADFOUNTAIN),player.level.know[player.x][player.y]=0)}function fntchange(e){switch(e/=Math.abs(e),rnd(9)){case 1:updateLog("  Your strength"),player.setStrength(player.STRENGTH+e),fch(e);break;case 2:updateLog("  Your intelligence"),player.setIntelligence(player.INTELLIGENCE+e),fch(e);break;case 3:updateLog("  Your wisdom"),player.setWisdom(player.WISDOM+e),fch(e);break;case 4:updateLog("  Your constitution"),player.setConstitution(player.CONSTITUTION+e),fch(e);break;case 5:updateLog("  Your dexterity"),player.setDexterity(player.DEXTERITY+e),fch(e);break;case 6:updateLog("  Your charm"),player.setCharisma(player.CHARISMA+e),fch(e);break;case 7:var t=rnd(level+1);e<0?(updateLog("  You lose ".concat(t," hit point")),exclaim(t),player.losemhp(t)):(updateLog("  You gain ".concat(t," hit point")),exclaim(t),player.raisemhp(t));break;case 8:var a=rnd(level+1);0<e?(updateLog("  You just gained ".concat(a," spell")),exclaim(a),player.raisemspells(a)):(updateLog("  You just lost ".concat(a," spell")),exclaim(a),player.losemspells(a));break;case 9:a=5*rnd((level+1)*(level+1));e<0?(updateLog("  You just lost ".concat(a," experience point")),exclaim(a),player.loseexperience(a)):(updateLog("  You just gained ".concat(a," experience point")),exclaim(a),player.raiseexperience(a))}}function fch(e){appendLog(e<0?" went down by one!":" went up by one!")}function exclaim(e){appendLog(1<e?"s!":"!")}function drink_fountain(){var e=itemAt(player.x,player.y);e.matches(ODEADFOUNTAIN)?updateLog("There is no water to drink!"):e.matches(OFOUNTAIN)?act_drink_fountain():updateLog("I see no fountain to drink from here!")}function wash_fountain(){var e=itemAt(player.x,player.y);e.matches(ODEADFOUNTAIN)?updateLog("There is no water to wash in!"):e.matches(OFOUNTAIN)?act_wash_fountain():updateLog("I see no fountain to wash at here!")}function isKnownPotion(e,t){return t=t||player,!(!e.matches(OPOTION)||!t.knownPotions[e.arg])}function learnPotion(e){e.matches(OPOTION)&&(player.knownPotions[e.arg]=e)}function act_quaffpotion(e){var t=getIndexFromChar(e),a=player.inventory[t];if(a&&a.matches(OPOTION))quaffpotion(a,!(player.inventory[t]=null));else if(a)updateLog("  You can't quaff that!");else{if("*"==e||" "==e||"I"==e)return mazeMode?showinventory(!0,act_quaffpotion,showquaff,!1,!1,!0):setMazeMode(!0),nomove=1,0;0<=t&&t<26&&updateLog("  You don't have item ".concat(e,"!")),t<=-1&&(appendLog(" cancelled".concat(period)),nomove=1)}return setMazeMode(!0),1}function quaffpotion(e,t){if(e){t&&learnPotion(e),ULARN&&updateLog("You drink a potion of ".concat(POTION_NAMES[e.arg]).concat(period));var a=!ULARN;switch(e.arg){case 0:updateLog("  You fall asleep. . .");for(var r=rnd(11)-(player.CONSTITUTION>>2)+2;0<--r;)parse2();updateLog("  You woke up!");break;case 1:player.HP==player.HPMAX?player.raisemhp(1):player.raisehp(rnd(20)+20+player.LEVEL),updateLog("  You feel better".concat(period));break;case 2:updateLog("  Suddenly, you feel much more skillful!"),player.raiselevel(),player.raisemhp(1);break;case 3:switch(rund(6)){case 0:player.setStrength(player.STRENGTH+1);break;case 1:player.setIntelligence(player.INTELLIGENCE+1);break;case 2:player.setWisdom(player.WISDOM+1);break;case 3:player.setConstitution(player.CONSTITUTION+1);break;case 4:player.setDexterity(player.DEXTERITY+1);break;case 5:player.setCharisma(player.CHARISMA+1)}updateLog("  You feel strange for a moment".concat(period));break;case 4:player.setWisdom(player.WISDOM+rnd(2)),updateLog("  You feel more self confident!");break;case 5:player.HERO&&player.setStrength(player.STRENGTH-11),player.setStrength(Math.max(player.START_STRENGTH,player.STRENGTH+1)),player.HERO&&player.setStrength(player.STRENGTH+11),updateLog("  Wow! You feel great!");break;case 6:player.setCharisma(player.CHARISMA+1),updateLog(ULARN?"  You feel charismatic!":"  Your charm went up by one!");break;case 7:player.setStrength(player.STRENGTH-1),updateLog("  You become dizzy!");break;case 8:player.setIntelligence(player.INTELLIGENCE+1),updateLog(ULARN?"  You feel clever!":"  Your intelligence went up by one!");break;case 9:if(updateLog("  You sense the presence of objects!"),0<player.BLINDCOUNT)return;for(let a=0;a<MAXX;a++)for(let t=0;t<MAXY;t++){let e=itemAt(a,t);!canTake(e)||e.isGem()||e.matches(OLARNEYE)||e.matches(OGOLDPILE)||(player.level.know[a][t]=HAVESEEN,show1cell(a,t))}break;case 10:if(a&&updateLog("  You detect the presence of monsters!"),0<player.BLINDCOUNT)return;for(let t=0;t<MAXX;t++)for(let e=0;e<MAXY;e++){var o=monsterAt(t,e);o&&o.isVisible()&&(player.level.know[t][e]=HAVESEEN,show1cell(t,e))}break;case 11:updateLog("  You stagger for a moment...");for(let t=0;t<MAXX;t++)for(let e=0;e<MAXY;e++)player.level.know[t][e]=0;break;case 12:a&&updateLog("  This potion has no taste to it".concat(period));break;case 13:player.BLINDCOUNT+=500,updateLog("  You can't see anything!");break;case 14:player.CONFUSE+=20+rnd(9),updateLog("  You feel confused".concat(period));break;case 15:0==player.HERO&&(player.setStrength(player.STRENGTH+11),player.setIntelligence(player.INTELLIGENCE+11),player.setWisdom(player.WISDOM+11),player.setConstitution(player.CONSTITUTION+11),player.setDexterity(player.DEXTERITY+11),player.setCharisma(player.CHARISMA+11)),player.HERO+=250,updateLog("  WOW!!! You feel Super-fantastic!!!");break;case 16:player.setConstitution(player.CONSTITUTION+1),updateLog(ULARN?"  You feel healthier!":"  You have a greater intestinal constitude!");break;case 17:0==player.GIANTSTR&&(changedSTR=millis()),player.updateGiantStr(700),updateLog("  You now have incredibly bulging muscles!!!");break;case 18:player.updateFireResistance(1e3),updateLog("  You feel a chill run up your spine!");break;case 19:if(updateLog("  You feel greedy . . ."),0<player.BLINDCOUNT)return;for(let a=0;a<MAXX;a++)for(let t=0;t<MAXY;t++){let e=itemAt(a,t);(e.isGem()||e.matches(OLARNEYE)||e.matches(OGOLDPILE))&&(player.level.know[a][t]=HAVESEEN,show1cell(a,t))}break;case 20:player.raisehp(player.HPMAX-player.HP),ULARN&&removecurse(!1),updateLog("  You feel all better now!");break;case 21:updateLog("  You don't seem to be affected".concat(period));break;case 22:player.HALFDAM+=200+rnd(200),updateLog("  You feel a sickness engulf you".concat(period));break;case 23:player.SEEINVISIBLE+=rnd(1e3)+400,updateLog("  You feel your vision sharpen".concat(period))}}}function isKnownScroll(e,t){return t=t||player,!(!e.matches(OSCROLL)||!t.knownScrolls[e.arg])}function learnScroll(e){e.matches(OSCROLL)&&(player.knownScrolls[e.arg]=e)}function act_read_something(e){var t=getIndexFromChar(e),a=player.inventory[t];if(a&&a.matches(OSCROLL))player.inventory[t]=null,read_scroll(a);else if(a&&a.matches(OBOOK))player.inventory[t]=null,readbook(a);else if(a)updateLog("  You can't read that!");else{if("*"==e||" "==e||"I"==e)return mazeMode?showinventory(!0,act_read_something,showread,!1,!1,!0):setMazeMode(!0),nomove=1,0;0<=t&&t<26&&updateLog("  You don't have item ".concat(e,"!")),t<=-1&&(appendLog(" cancelled".concat(period)),nomove=1)}return setMazeMode(!0),1}function read_scroll(e){if(e){learnScroll(e),ULARN&&updateLog("You read a scroll of ".concat(SCROLL_NAMES[e.arg]).concat(period));var t=!ULARN;switch(e.arg){case 0:enchantarmor(ENCH_SCROLL);break;case 1:enchweapon(ENCH_SCROLL);break;case 2:t&&updateLog("  You have been granted enlightenment!");var a=Math.min(player.y+7,MAXY),r=Math.min(player.x+25,MAXX),o=Math.max(player.y-7,0);for(let t=Math.max(player.x-25,0);t<r;t++)for(let e=o;e<a;e++)player.level.know[t][e]=KNOWALL;break;case 3:t&&updateLog("  This scroll seems to be blank".concat(period));break;case 4:createmonster(makemonst(level+1));break;case 5:dropItemNearPlayer(createRandomItem(level)),rnd(101)<8&&dropItemNearPlayer(createRandomItem(level));break;case 6:t&&updateLog("  Something isn't right..."),player.AGGRAVATE+=800;break;case 7:var n=rnd(1e3)-850;gtime+=n,ULARN&&gtime<0&&(gtime=0);var i=Math.abs(Math.round(n/100));debug("timewarp: ".concat(n," ").concat(i)),updateLog((0<=n?"  You went forward in time by ":"  You went backward in time by ").concat(i," mobul").concat(1==i?"":"s").concat(period)),adjtime(n);break;case 8:t&&updateLog("  Your surroundings change".concat(period)),oteleport(0);break;case 9:t&&updateLog("  You feel extra alert".concat(period)),player.AWARENESS+=1800;break;case 10:updateLog(ULARN?"  You feel nervous".concat(period):"  Something isn't right..."),player.HASTEMONST+=rnd(55)+12;break;case 11:updateLog(ULARN?"  You feel uneasy".concat(period):"  Something isn't right...");for(let t=0;t<MAXY;t++)for(let e=0;e<MAXX;e++)player.level.monsters[e][t]&&(player.level.monsters[e][t].hitpoints=monsterlist[player.level.monsters[e][t].arg].hitpoints);break;case 12:player.updateSpiritPro(300+rnd(200));break;case 13:player.updateUndeadPro(300+rnd(200));break;case 14:player.updateStealth(250+rnd(250));break;case 15:t&&updateLog("  You have been granted enlightenment!"),revealLevel();break;case 16:player.updateHoldMonst(30);break;case 17:t&&updateLog("  You feel someone eyeing your belongings".concat(period));for(let t=0;t<26;t++){let e=player.inventory[t];e&&e.isGem()&&(e.arg*=2,e.arg=Math.min(255,e.arg))}break;case 18:t&&updateLog("  You feel a twitch at the base of your skull".concat(period)),player.updateCharmCount(player.CHARMCOUNT),player.updateTimeStop(player.TIMESTOP),player.updateHoldMonst(player.HOLDMONST),player.updateDexCount(player.DEXCOUNT),player.updateStrCount(player.STRCOUNT),player.updateScareMonst(player.SCAREMONST),player.updateHasteSelf(player.HASTESELF),player.updateCancellation(player.CANCELLATION),player.updateInvisibility(player.INVISIBILITY),player.updateProtectionTime(player.PROTECTIONTIME),player.updateWTW(player.WTW),player.GLOBE<<=1;break;case 19:t&&updateLog("  You feel someone eyeing your belongings".concat(period));for(let t=0;t<player.inventory.length;t++){let e=player.inventory[t];e&&(e.matches(OPOTION)&&learnPotion(e),e.matches(OSCROLL)&&learnScroll(e))}break;case 20:removecurse(t);break;case 21:annihilate();break;case 22:var l=function(e){return"  The ray hits the ".concat(e).concat(period)};prepare_direction_event(function(e){setup_godirect(10,LIT,e,150," ",l)});break;case 23:t&&updateLog("  You sense a benign presence".concat(period)),player.LIFEPROT++}}}function removecurse(e){e&&updateLog("  You sense a benign presence".concat(period)),0<player.BLINDCOUNT&&(player.BLINDCOUNT=1),0<player.CONFUSE&&(player.CONFUSE=1),0<player.AGGRAVATE&&(player.AGGRAVATE=1),0<player.HASTEMONST&&(player.HASTEMONST=1),0<player.ITCHING&&(player.ITCHING=1),0<player.LAUGHING&&(player.LAUGHING=1),0<player.DRAINSTRENGTH&&(player.DRAINSTRENGTH=1),0<player.CLUMSINESS&&(player.CLUMSINESS=1),0<player.INFEEBLEMENT&&(player.INFEEBLEMENT=1),0<player.HALFDAM&&(player.HALFDAM=1)}function up_stairs(){var e=itemAt(player.x,player.y);e.matches(OSTAIRSDOWN)?(updateLog("  The stairs don't go up!"),dropflag=1):e.matches(OVOLUP)?act_up_shaft():e.matches(OSTAIRSUP)?act_up_stairs():(updateLog("  I see no way to go up here!"),dropflag=1)}function down_stairs(){var e=itemAt(player.x,player.y);e.matches(OSTAIRSUP)?(updateLog("  The stairs don't go down!"),dropflag=1):e.matches(OVOLDOWN)?act_down_shaft():e.matches(OENTRANCE)?enter():e.matches(OSTAIRSDOWN)?act_down_stairs():(updateLog("  I see no way to go down here!"),dropflag=1)}function act_up_stairs(){let e=level<=1;e|=level==MAXLEVEL,ULARN&&(e|=level==DBOTTOM),e?(updateLog("  The stairs lead to a dead end!"),dropflag=1):newcavelevel(level-1)}function act_down_stairs(){let e=0==level;e|=level==DBOTTOM,e|=level==VBOTTOM,ULARN&&(e|=VBOTTOM-2<=level),e?(updateLog("  The stairs lead to a dead end!"),dropflag=1):newcavelevel(level+1)}function act_down_shaft(){setMazeMode(!0),0==level?null!=LEVELS[1]||wizard?(packweight()>45+3*(player.STRENGTH+player.STREXTRA)&&(updateLog("  You slip and fall down the shaft".concat(period)),lastnum=DIED_VOLCANO_SLIP,player.losehp(30+rnd(20))),newcavelevel(MAXLEVEL)):updateLog("  You feel a foreboding sense of doom, and back away"):updateLog("  The shaft only extends 5 feet downward!")}function act_up_shaft(){if(setMazeMode(!0),level==MAXLEVEL){if(packweight()>(ULARN?40:45)+5*(player.STRENGTH+player.STREXTRA))return updateLog("  You slip and fall down the shaft".concat(period)),lastnum=DIED_VOLCANO_SLIP,void player.losehp(15+rnd(20));newcavelevel(0),moveNear(OVOLDOWN,!1)}else updateLog("  The shaft only extends 8 feet upwards before you find a blockage!")}function remove_gems(){cursors();var e=itemAt(player.x,player.y);e.matches(ODEADTHRONE)?updateLog("There are no gems to remove!"):e.matches(OTHRONE)?act_remove_gems(e.arg):updateLog("I see no throne here to remove gems from!")}function act_remove_gems(e){var t=rnd(101);if(t<25){for(var a=0;a<rnd(4);a++)dropItemNearPlayer(createGem());var r=itemAt(player.x,player.y).arg;setItem(player.x,player.y,createObject(ODEADTHRONE,r)),player.level.know[player.x][player.y]=0}else t<40&&0==e&&!isGenocided(GNOMEKING)?(createmonster(GNOMEKING),itemAt(player.x,player.y).arg=1,player.level.know[player.x][player.y]=0):updateLog("  Nothing happens".concat(period))}function sit_on_throne(){cursors();var e=itemAt(player.x,player.y);e.matches(OTHRONE)?act_sit_throne(e.arg):e.matches(ODEADTHRONE)?act_sit_dead_throne(e.arg):updateLog("I see no throne to sit on here!")}function act_sit_throne(e){var t=rnd(101);t<30&&0==e&&!isGenocided(GNOMEKING)?(createmonster(GNOMEKING),itemAt(player.x,player.y).arg=1,player.level.know[player.x][player.y]=0):t<35?(updateLog("  Zaaaappp!  You've been teleported!"),beep(),oteleport(0)):updateLog("  Nothing happens".concat(period))}function act_sit_dead_throne(e){var t;ULARN?(t=rnd(101))<5?player.raiselevel():t<25?(updateLog("  Zaaaappp!  You've been teleported!"),beep(),oteleport(0)):updateLog("  Nothing happens".concat(period)):act_sit_throne(e)}function enableDevmode(){try{Rollbar.configure({enabled:!1})}catch(e){}console.error("DEVMODE IN USE"),enableDebug(),eventToggleDebugWTW(),eventToggleDebugStairs(),eventToggleDebugOutput(),eventToggleDebugKnowAll(),eventToggleDebugStats(),eventToggleDebugImmortal(),eventToggleDebugAwareness(),wizardmode("pvnert(x)"),player.GOLD=25e4}const ENABLE_RECORDING=!0,ENABLE_RECORDING_REALTIME=!1,ENABLE_RECORDING_TEST_LAMBDA=!1,MIN_FRAMES_TO_LIST=1e3,MAX_ROLL_LENGTH=ENABLE_RECORDING_REALTIME?10:100;function updateMessage(t){if(document){let e=document.getElementById("LARN_LIST");e&&(e.innerHTML=t)}}class Frame{constructor(){this.id=0,this.ts=0,this.divs={}}}const LAMBDA=ENABLE_RECORDING_TEST_LAMBDA?"movie_test":"movies";function invokeLambda(e,a,r){e={FunctionName:LAMBDA,Payload:JSON.stringify(e),InvocationType:"RequestResponse",LogType:"None"};lambda.invoke(e,function(e,t){e?(console.error("invokeLambda(): error: ".concat(e)),updateMessage("".concat(e)),r&&r(e)):t&&(200==t.StatusCode?a&&(e=JSON.parse(t.Payload),a(e.body,e.File,e.Metadata)):(console.error("invokeLambda(): error ".concat(t.StatusCode)),updateMessage("couldn't load: ".concat(t.StatusCode)),r&&r(t.StatusCode)))})}function downloadRecordings(e,t){console.log("downloadRecordings()"),invokeLambda({action:"listcompleted",frameLimit:t},e,lambdaFail)}function lambdaFail(e){console.log("lambdaFail(): ",e)}function loadStyles(e,t){console.log("loadStyles()"),invokeLambda({action:"loadstyle",gameID:e},t,null)}function downloadFile(e,t,a,r){console.log("downloadFile(): ".concat(e,"/").concat(t)),invokeLambda({action:"read",gameID:e,filename:t},a,r)}function downloadRoll(r,o,n){let i=r.rolls.length,l="".concat(i,".json");downloadFile(r.gameID,l,function(e,t,a){t?(t=decompressRoll(t),0===i&&(console.log("downloadRoll(): metadata",a),a.diff&&(a.diff=parseInt(a.diff)),a.score&&(a.score=parseInt(a.score)),a.frames&&(a.frames=parseInt(a.frames)),a.frames&&(r.metadata=a,r.totalFrames=a.frames),a.who&&(document.title="LarnTV: ".concat(a.who," - ").concat(a.what," - diff ").concat(a.diff," - score ").concat(a.score))),r.addRollToBuffer(t),o&&o()):(console.error("downloadRoll(): ".concat(r.gameID,"/").concat(l," empty file")),0===i&&updateMessage("\nSorry, this game couldn't be loaded"),n&&n(r,l))},null)}function uploadFile(e,t,a,r,o){console.log("uploadFile(): ".concat(e,"/").concat(t));let n={action:r?"writelast":"write",gameID:e,filename:t,file:a};o&&(n.progressData=o),invokeLambda(n,null,null)}let video;const EMPTY_LARN_FRAME="                                                                                \n                                                                                \n                                                                                \n                                                                                \n                                                                                \n                                                                                \n                                                                                \n                                                                                \n                                                                                \n                                                                                \n                            SAVING GAME                                        \n                                                                                \n                                                                                \n                                                                                \n                                                                                \n                                                                                \n                                                                                \n                                                                                \n                                                                                \n                                                                                \n                                                                                \n                                                                                \n                                                                                \n                                                                                \n";class Video{constructor(e){this.frameBuffer=[],this.recording=ENABLE_RECORDING,this.gameID=e,this.currentFrameNum=-1,this.metadata,this.totalFrames,this.rolls=[],this.divs=[],this.progressCallback}addRollToBuffer(a){if(a){var e=a.patches[0].id;let t=this.getFrame(e-1);for(let e=0;e<a.patches.length;e++){var r=buildFrame(a.patches[e],t);r&&(this.metadata&&r.id<=this.totalFrames||!this.metadata?(this.frameBuffer[r.id]=r,t=r):console.log("addRollToBuffer(): extra frame:",t.id),this.metadata||(this.totalFrames=r.id))}this.addRoll(a),1===this.rolls.length&&play(),this.metadata&&t.id>=this.metadata.frames?(console.log("addRollToBuffer(): done loading"),updateMessage("")):downloadRoll(this,updateProgressBarCallback,waitForNextFile)}else console.log("addRollToBuffer(): no roll!")}getFrame(e){return e<0?this.createEmptyFrame():(this.frameBuffer[e]||(console.error("video.getFrame(): missing frame: ".concat(e)),this.frameBuffer[e]=this.createEmptyFrame()),this.frameBuffer[e])}createEmptyFrame(){let t=new Frame;return this.divs.forEach(e=>{t.divs[e]=""}),t}getCurrentRoll(){return this.rolls[this.rolls.length-1]}addFrame(t){var a=buildPatch(this.getFrame(this.currentFrameNum),t);let r=!0;if(Object.values(a.divs).forEach(e=>{r&=""==e}),!r){let e=this.getCurrentRoll();e||(e=new Roll([]),this.addRoll(e)),e.addPatch(a),e.isFull()&&(uploadRoll(e,this.rolls.length-1,this.progressCallback),this.addRoll(new Roll([]))),this.currentFrameNum=t.id,this.frameBuffer[this.currentFrameNum]=t}}addRoll(e){this.rolls.push(e)}getNextFrame(){return this.updateCurrentFrame(1),this.getFrame(this.currentFrameNum)}updateCurrentFrame(e){return this.currentFrameNum=0<e?Math.min(this.currentFrameNum+e,this.frameBuffer.length-1):Math.max(this.currentFrameNum+e,0),this.currentFrameNum}getPreviousFrame(){return this.updateCurrentFrame(-1),this.getFrame(this.currentFrameNum)}setTotalFrames(e){this.totalFrames=e}}function uploadRoll(e,t,a){let r;ENABLE_RECORDING_REALTIME&&(a&&(r=a()),r?(a=e.patches[e.patches.length-1])?r.frames=a.id:console.error("null patch for roll=".concat(e.patches.length-1," num=").concat(t)):(r=null,console.log("uploadroll: progressData=null")));t="".concat(t,".json"),e=compressRoll(e);uploadFile(gameID,t,e,!1,JSON.stringify(r))}function stopRecording(){console.log("stopping recording"),video=video||new Video(gameID),video.recording=!1}function isRecording(){return!!navigator.onLine&&(!!ENABLE_RECORDING&&(video=video||new Video(gameID),video.recording))}function recordFrame(t,a){if(isRecording()){video=video||new Video(gameID),video.progressCallback||(video.progressCallback=a);let e=new Frame;e.id=video.currentFrameNum+1,e.ts=Date.now();for(var[r,o]of Object.entries(t))video.divs[r]="",e.divs[r]=o;video.addFrame(e)}}function endRecording(e,t){try{if(!isRecording())return;var a=video.getCurrentRoll();uploadRoll(a,video.rolls.length-1,video.progressCallback),e&&("+"===e.gameID.slice(-1)&&(e.gameID=e.gameID.slice(0,-1)),e.frames=a.patches[a.patches.length-1].id,e.ularn=t,console.log("endRecording(): enddata: ",e),console.log("endRecording(): frames = ".concat(e.frames)),uploadFile(gameID,"".concat(gameID,".txt"),JSON.stringify(e),!0))}catch(e){console.log("endRecording(): caught: ",e)}}function getRecordingInfo(){if(isRecording())return{frames:video.currentFrameNum,rolls:video.rolls.length}}function setRecordingInfo(t){if(isRecording()&&t){video=new Video(video.gameID),console.log("setRecordingInfo(): info: ".concat(JSON.stringify(t))),video.currentFrameNum=parseInt(t.frames),video.frameBuffer[video.currentFrameNum]=new Frame;for(let e=0;e<parseInt(t.rolls);e++)video.addRoll(new Roll([]));video.addRoll(new Roll([]))}}function uploadStyle(e){isRecording()&&uploadFile(gameID,"".concat(gameID,".css"),JSON.stringify(e))}const dmp=new diff_match_patch;class Patch{constructor(){this.id,this.ts,this.divs={}}}function buildFrame(e,t){let a=new Frame;var r,o;a.id=e.id,a.ts=e.ts;for([r,o]of Object.entries(e.divs)){var n=dmp.patch_fromText(o),n=dmp.patch_apply(n,t.divs[r]);a.divs[r]=n[0]}return a}function buildPatch(a,r){let o=new Patch;o.id=r.id,o.ts=r.ts;let e=Object.keys(r.divs);return e.forEach(e=>{var t=dmp.diff_main(a.divs[e]||"",r.divs[e]);2<t.length&&dmp.diff_cleanupEfficiency(t);t=dmp.patch_make(a.divs[e]||"",t);o.divs[e]=dmp.patch_toText(t)}),o}class Roll{constructor(e){this.patches=e}addPatch(e){this.patches.push(e)}isFull(){return this.patches.length>=MAX_ROLL_LENGTH}}function createRoll(e){return new Roll(e.patches)}function compressRoll(e){var t=JSON.stringify(e),e=LZString.compressToEncodedURIComponent(t);Math.round(t.length/e.length*100);return e}function decompressRoll(e){e=LZString.decompressFromEncodedURIComponent(e);return createRoll(JSON.parse(e))}